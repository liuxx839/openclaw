<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>AI Health Companion</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{--bg:#050810;--bg2:#0c1220;--card:rgba(16,22,38,.85);--accent:#0d9488;--accent2:#14b8a6;--aglow:rgba(13,148,136,.12);--blue:#6c9fff;--purple:#a78bfa;--warm:#f59e0b;--green:#34d399;--red:#ef4444;--pink:#ec4899;--cyan:#22d3ee;--text:#f0f2f8;--text2:#8896ab;--text3:#404a5c;--border:rgba(255,255,255,.07);--r:14px;--rs:10px}
body{font-family:-apple-system,system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;padding-bottom:env(safe-area-inset-bottom)}
.nav{position:fixed;bottom:0;left:0;right:0;background:rgba(5,8,16,.95);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom)}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;padding:10px 0 6px;font-size:9px;color:var(--text3);cursor:pointer;transition:.3s}.ni.on{color:var(--accent2)}.ni .ic{font-size:20px;margin-bottom:2px}
.page{display:none;min-height:100vh;padding:14px 14px 85px}.page.on{display:block}
.ph{font-size:18px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.btn{padding:9px 18px;border:none;border-radius:var(--rs);font-size:12px;font-weight:600;cursor:pointer;transition:.2s}.btn:active{transform:scale(.96)}
.btn-p{background:linear-gradient(135deg,var(--accent),#0f766e);color:#fff}.btn-g{background:var(--bg2);color:var(--text2);border:1px solid var(--border)}
.cd{background:var(--card);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:10px}
.cd h4{font-size:13px;font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.inp{width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:var(--rs);background:var(--bg2);color:var(--text);font-size:13px;outline:none;font-family:inherit}.inp:focus{border-color:var(--accent)}
textarea.inp{resize:vertical;min-height:50px}
.tag{display:inline-block;font-size:10px;padding:2px 8px;border-radius:10px;margin:2px 2px 2px 0}
.t-diag{background:rgba(239,68,68,.12);color:var(--red);border:1px solid rgba(239,68,68,.2)}
.t-med{background:rgba(52,211,153,.12);color:var(--green);border:1px solid rgba(52,211,153,.15)}
.t-hosp{background:rgba(108,159,255,.12);color:var(--blue);border:1px solid rgba(108,159,255,.15)}
.t-date{background:rgba(245,158,11,.12);color:var(--warm);border:1px solid rgba(245,158,11,.15)}
.t-test{background:rgba(34,211,238,.12);color:var(--cyan);border:1px solid rgba(34,211,238,.15)}
.t-abn{background:rgba(239,68,68,.2);color:#fca5a5;border:1px solid rgba(239,68,68,.3);font-weight:600}
/* Patient chips */
.psel{display:flex;gap:6px;overflow-x:auto;margin-bottom:14px;padding:2px 0;-webkit-overflow-scrolling:touch}
.pc{padding:7px 14px;border-radius:18px;border:1px solid var(--border);background:var(--card);color:var(--text2);font-size:11px;font-weight:500;cursor:pointer;white-space:nowrap;flex-shrink:0;transition:.2s}
.pc.on{background:var(--accent);color:#fff;border-color:var(--accent)}.pc.add{border-style:dashed;color:var(--text3)}
/* Record card (modular) */
.rec-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);margin-bottom:12px;overflow:hidden}
.rec-header{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.rec-header .rec-date{font-size:11px;color:var(--warm);font-weight:600}
.rec-header .rec-hosp{font-size:11px;color:var(--blue)}
.rec-body{padding:12px 14px}
.rec-section{margin-bottom:10px}
.rec-section .rs-title{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.rec-section .rs-content{font-size:12px;color:var(--text2);line-height:1.6}
.rec-imgs{display:flex;gap:6px;overflow-x:auto;padding:8px 14px;border-top:1px solid var(--border)}
.rec-imgs img{height:60px;border-radius:6px;cursor:pointer;border:1px solid var(--border);flex-shrink:0}
/* Test results table */
.test-row{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);font-size:12px}
.test-row:last-child{border:none}
.test-row .tn{color:var(--text2)}.test-row .tv{font-weight:600}.test-row.abn .tv{color:var(--red)}
/* Chat */
.chat-w{flex:1;overflow-y:auto;padding:8px 0}
.cm{margin-bottom:10px;max-width:88%}.cm.u{margin-left:auto}
.cm .bbl{padding:10px 14px;border-radius:var(--r);font-size:13px;line-height:1.6}
.cm.u .bbl{background:var(--accent);color:#fff;border-bottom-right-radius:4px}
.cm.ai .bbl{background:var(--card);border:1px solid var(--border);border-bottom-left-radius:4px}
.cm .cite{display:flex;align-items:center;gap:6px;margin-top:6px;padding:6px 8px;background:rgba(108,159,255,.08);border-radius:8px;cursor:pointer;border:1px solid rgba(108,159,255,.15)}
.cm .cite img{height:40px;border-radius:4px}
.cm .cite span{font-size:10px;color:var(--blue)}
.cm .search-badge{font-size:10px;color:var(--cyan);margin-bottom:4px;display:flex;align-items:center;gap:4px}
.chat-inp{display:flex;gap:6px;padding:8px 0}.chat-inp .inp{flex:1}
/* Med */
.med-i{display:flex;align-items:center;gap:10px;padding:10px;background:var(--card);border-radius:var(--rs);margin-bottom:6px;border:1px solid var(--border)}
.med-i .mi-icon{font-size:22px;width:36px;text-align:center}
.med-i .mi-info{flex:1}.med-i .mi-name{font-size:13px;font-weight:600}.med-i .mi-dose{font-size:10px;color:var(--text2)}
.med-i .mi-chk{width:26px;height:26px;border-radius:50%;border:2px solid var(--accent);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:11px}
.med-i .mi-chk.done{background:var(--green);border-color:var(--green);color:#fff}
/* Memory */
.mem-entry{font-size:11px;color:var(--text2);padding:5px 0;border-bottom:1px solid var(--border);line-height:1.5}.mem-entry:last-child{border:none}
.mem-entry .mt{color:var(--warm);font-size:10px}
/* Stats */
.stat-r{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.stat-b{background:var(--card);border-radius:var(--rs);padding:10px;text-align:center;border:1px solid var(--border)}
.stat-b .sv{font-size:20px;font-weight:700;color:var(--accent2)}.stat-b .sl{font-size:9px;color:var(--text3);margin-top:2px}
/* View tabs */
.vt{display:flex;gap:5px;margin-bottom:10px}.vt div{padding:5px 12px;border-radius:14px;font-size:10px;font-weight:500;color:var(--text3);border:1px solid var(--border);cursor:pointer}.vt div.on{background:var(--accent);color:#fff;border-color:var(--accent)}
/* Image viewer modal */
.img-modal{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:200;display:none;align-items:center;justify-content:center;flex-direction:column}
.img-modal.show{display:flex}
.img-modal img{max-width:95%;max-height:80vh;border-radius:8px}
.img-modal .close{position:absolute;top:20px;right:20px;color:#fff;font-size:28px;cursor:pointer;background:rgba(0,0,0,.5);border:none;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center}
.toast{position:fixed;top:50px;left:50%;transform:translateX(-50%);background:rgba(16,22,38,.95);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:var(--rs);padding:10px 24px;font-size:12px;color:var(--text);z-index:200;opacity:0;transition:.3s}.toast.show{opacity:1}
</style>
</head>
<body>

<div class="page on" id="p-home">
  <div class="ph">ğŸ¥ AI Health</div>
  <div class="psel" id="patSel"></div>
  <div class="stat-r" id="homeStats"></div>
  <div class="cd"><h4>ğŸ¤– å¥åº·åŠ©æ‰‹</h4><div id="aiMsg" style="font-size:12px;color:var(--text2);line-height:1.6">åŠ è½½ä¸­...</div></div>
  <div class="cd"><h4>ğŸ“‹ æœ€è¿‘æ¡£æ¡ˆ</h4><div id="recentRecs"></div></div>
  <div class="cd"><h4>ğŸ’Š ä»Šæ—¥ç”¨è¯</h4><div id="todayMeds2"></div></div>
</div>

<div class="page" id="p-recs">
  <div class="ph">ğŸ“‹ å¥åº·æ¡£æ¡ˆ</div>
  <div class="vt" id="viewTabs"><div class="on" data-v="tl">â±ï¸ æ—¶é—´è½´</div><div data-v="dis">ğŸ©º ç–¾ç—…</div><div data-v="hos">ğŸ¥ åŒ»é™¢</div></div>
  <div id="recsView"></div>
</div>

<div class="page" id="p-add">
  <div class="ph">ğŸ“¸ å½•å…¥æ¡£æ¡ˆ</div>
  <div class="cd">
    <h4>ğŸ“· ä¸Šä¼ åŒ»ç–—æ–‡ä»¶</h4>
    <div style="display:flex;gap:6px;margin-bottom:8px">
      <button class="btn btn-p" onclick="$('#camIn').click()" style="flex:1">ğŸ“· æ‹ç…§</button>
      <button class="btn btn-g" onclick="$('#galIn').click()" style="flex:1">ğŸ–¼ï¸ ç›¸å†Œ</button>
    </div>
    <div id="uploadPrev" style="display:flex;gap:6px;flex-wrap:wrap"></div>
    <div id="ocrSt" style="font-size:11px;color:var(--text3);margin-top:6px"></div>
  </div>
  <div id="extractedCards"></div>
  <div class="cd" id="manualForm" style="display:none">
    <h4>âœï¸ è¡¥å……/ä¿®æ”¹</h4>
    <div style="margin-bottom:6px"><label style="font-size:10px;color:var(--text3)">å°±è¯Šæ—¥æœŸ</label><input type="date" class="inp" id="aDate"></div>
    <div style="margin-bottom:6px"><label style="font-size:10px;color:var(--text3)">åŒ»é™¢</label><input class="inp" id="aHosp" placeholder="åŒ»é™¢"></div>
    <div style="margin-bottom:6px"><label style="font-size:10px;color:var(--text3)">ç§‘å®¤</label><input class="inp" id="aDept" placeholder="ç§‘å®¤"></div>
    <div style="margin-bottom:6px"><label style="font-size:10px;color:var(--text3)">åŒ»ç”Ÿ</label><input class="inp" id="aDoc" placeholder="åŒ»ç”Ÿ"></div>
    <div style="margin-bottom:6px"><label style="font-size:10px;color:var(--text3)">è¯Šæ–­</label><input class="inp" id="aDiag" placeholder="è¯Šæ–­"></div>
    <div style="margin-bottom:6px"><label style="font-size:10px;color:var(--text3)">ç”¨è¯</label><textarea class="inp" id="aMeds" placeholder="æ¯è¡Œä¸€ä¸ªï¼šè¯å å‰‚é‡ é¢‘æ¬¡"></textarea></div>
    <div style="margin-bottom:6px"><label style="font-size:10px;color:var(--text3)">å¤‡æ³¨</label><textarea class="inp" id="aNotes" placeholder="å…¶ä»–"></textarea></div>
    <button class="btn btn-p" onclick="saveRecord()" style="width:100%">ğŸ’¾ ä¿å­˜æ¡£æ¡ˆ</button>
  </div>
  <div class="cd"><h4>âœï¸ æ‰‹åŠ¨å½•å…¥</h4><button class="btn btn-g" onclick="$('#manualForm').style.display='block'" style="width:100%">å±•å¼€æ‰‹åŠ¨è¡¨å•</button></div>
  <input type="file" id="camIn" accept="image/*" capture="environment" style="display:none" onchange="onImg(event)">
  <input type="file" id="galIn" accept="image/*" multiple style="display:none" onchange="onImg(event)">
</div>

<div class="page" id="p-chat" style="display:none;flex-direction:column;height:100vh;padding-bottom:70px">
  <div class="ph">ğŸ’¬ å¥åº·é—®ç­”</div>
  <div style="display:flex;gap:5px;margin-bottom:6px">
    <button class="btn btn-g" onclick="$('#chatImgIn').click()" style="font-size:11px">ğŸ“· å‘å›¾</button>
    <span style="font-size:10px;color:var(--text3);display:flex;align-items:center">åŸºäºæ¡£æ¡ˆå›ç­” Â· æ”¯æŒè”ç½‘æœç´¢</span>
  </div>
  <div class="chat-w" id="chatW"></div>
  <div class="chat-inp"><input class="inp" id="chatInp" placeholder="é—®å…³äºå¥åº·æ¡£æ¡ˆçš„é—®é¢˜..." onkeydown="if(event.key==='Enter')sendMsg()"><button class="btn btn-p" onclick="sendMsg()">å‘é€</button></div>
  <input type="file" id="chatImgIn" accept="image/*" style="display:none" onchange="onChatImg(event)">
</div>

<div class="page" id="p-meds">
  <div class="ph">ğŸ’Š ç”¨è¯ç®¡ç†</div>
  <div class="cd"><h4>ä»Šæ—¥æ‰“å¡</h4><div id="medsL"></div></div>
  <div class="cd"><h4>â• æ·»åŠ </h4>
    <div style="margin-bottom:6px"><input class="inp" id="mName" placeholder="è¯å“å"></div>
    <div style="display:flex;gap:6px;margin-bottom:6px"><input class="inp" id="mDose" placeholder="å‰‚é‡" style="flex:1"><input type="time" class="inp" id="mTime" style="flex:1" value="08:00"></div>
    <button class="btn btn-p" onclick="addMed()" style="width:100%">æ·»åŠ </button>
  </div>
  <div class="cd"><h4>ğŸ“Š ä¾ä»æ€§</h4><div id="compli" style="font-size:12px;color:var(--text2)"></div></div>
</div>

<div class="page" id="p-mem">
  <div class="ph">ğŸ§  æ‚£è€…è®°å¿†</div>
  <div class="cd"><h4>ğŸ“ çŸ­æœŸè®°å¿† (è¿‘æœŸå¯¹è¯/äº‹ä»¶)</h4><div id="sMemV"></div></div>
  <div class="cd"><h4>ğŸ’ é•¿æœŸè®°å¿† (é‡è¦å¥åº·ä¿¡æ¯)</h4><div id="lMemV"></div></div>
  <div class="cd"><h4>ğŸ”® AI åæ€ (å¥åº·ç”»åƒ)</h4><div id="rMemV"></div></div>
  <div style="display:flex;gap:6px"><button class="btn btn-g" onclick="triggerReflect()">ğŸ”® AIåæ€</button><button class="btn btn-g" onclick="exportMem()">ğŸ“¤ å¯¼å‡º</button></div>
</div>

<div class="page" id="p-set">
  <div class="ph">âš™ï¸ è®¾ç½®</div>
  <div class="cd"><h4>ğŸ”‘ API Key</h4><input type="password" class="inp" id="sKey" placeholder="DashScope API Key" style="margin-bottom:6px"><button class="btn btn-p" onclick="saveCfg()" style="width:100%">ä¿å­˜</button></div>
  <div class="cd"><h4>ğŸ‘¥ æ‚£è€…ç®¡ç†</h4><div id="patList"></div>
    <div style="display:flex;gap:6px;margin-top:8px"><input class="inp" id="newPat" placeholder="æ‚£è€…å§“å" style="flex:1"><button class="btn btn-g" onclick="addPat()">â•</button></div>
  </div>
  <div class="cd"><h4>â„¹ï¸ å…³äº</h4><div style="font-size:10px;color:var(--text3);line-height:2">AI Health v2.0<br>å…¨éƒ¨ä½¿ç”¨ qwen3.5-plus<br>VLMåŒ»ç–—OCR Â· RAGé—®ç­” Â· è”ç½‘æœç´¢ Â· è®°å¿†ç³»ç»Ÿ<br>OpenClaw memory pattern</div></div>
</div>

<div class="nav">
  <div class="ni on" data-p="p-home"><div class="ic">ğŸ </div>é¦–é¡µ</div>
  <div class="ni" data-p="p-recs"><div class="ic">ğŸ“‹</div>æ¡£æ¡ˆ</div>
  <div class="ni" data-p="p-add"><div class="ic">ğŸ“¸</div>å½•å…¥</div>
  <div class="ni" data-p="p-chat"><div class="ic">ğŸ’¬</div>é—®ç­”</div>
  <div class="ni" data-p="p-meds"><div class="ic">ğŸ’Š</div>ç”¨è¯</div>
  <div class="ni" data-p="p-mem"><div class="ic">ğŸ§ </div>è®°å¿†</div>
  <div class="ni" data-p="p-set"><div class="ic">âš™ï¸</div>è®¾ç½®</div>
</div>

<div class="img-modal" id="imgModal"><button class="close" onclick="$('#imgModal').classList.remove('show')">âœ•</button><img id="modalImg"></div>
<div class="toast" id="toast"></div>

<script>
const $=s=>document.querySelector(s);const $$=s=>document.querySelectorAll(s);
const MODEL='qwen3.5-plus'; // ALL features use this single model
let CFG={key:localStorage.getItem('hc_k')||''};
let curPat=localStorage.getItem('hc_cp')||'';

// ---- Storage ----
function pats(){return JSON.parse(localStorage.getItem('hc_pats')||'[]')}
function savePats(p){localStorage.setItem('hc_pats',JSON.stringify(p))}
function pk(k){return`hc_${curPat}_${k}`}
function recs(){return JSON.parse(localStorage.getItem(pk('recs'))||'[]')}
function saveRecs(r){localStorage.setItem(pk('recs'),JSON.stringify(r))}
function meds(){return JSON.parse(localStorage.getItem(pk('meds'))||'[]')}
function saveMeds(m){localStorage.setItem(pk('meds'),JSON.stringify(m))}
function checks(){return JSON.parse(localStorage.getItem(pk('chk'))||'[]')}
function saveChecks(c){localStorage.setItem(pk('chk'),JSON.stringify(c))}
function chatH(){return JSON.parse(localStorage.getItem(pk('chat'))||'[]')}
function saveChatH(c){localStorage.setItem(pk('chat'),JSON.stringify(c.slice(-100)))}
function mem(){return JSON.parse(localStorage.getItem(pk('mem'))||'{"s":[],"l":[],"r":[]}')}
function saveMem(m){localStorage.setItem(pk('mem'),JSON.stringify(m))}
// Store original images with records
function imgs(){return JSON.parse(localStorage.getItem(pk('imgs'))||'{}')}
function saveImgs(i){try{localStorage.setItem(pk('imgs'),JSON.stringify(i))}catch(e){console.warn('Image storage full')}}

// ---- Nav ----
$$('.ni').forEach(n=>{n.onclick=()=>{
  $$('.ni').forEach(x=>x.classList.remove('on'));$$('.page').forEach(x=>{x.classList.remove('on');x.style.display='none'});
  n.classList.add('on');const pg=$('#'+n.dataset.p);pg.classList.add('on');pg.style.display=n.dataset.p==='p-chat'?'flex':'block';
  if(n.dataset.p==='p-home')renderHome();if(n.dataset.p==='p-recs')renderRecs();
  if(n.dataset.p==='p-meds')renderMeds();if(n.dataset.p==='p-mem')renderMem();if(n.dataset.p==='p-set')renderSet();
}});

// ---- Init ----
window.addEventListener('load',()=>{
  if(CFG.key)$('#sKey').value=CFG.key;
  const p=pats();if(!p.length){addPatDirect('é»˜è®¤æ‚£è€…');curPat=pats()[0].id}
  if(!curPat)curPat=p[0]?.id||'';localStorage.setItem('hc_cp',curPat);
  renderHome();
});

// ---- API (ALL qwen3.5-plus) ----
async function callAI(messages,opts={}){
  if(!CFG.key){show('è¯·è®¾ç½®API Key');return null}
  const body={model:MODEL,messages,max_tokens:opts.maxTok||600};
  if(opts.search)body.extra_body={enable_search:true};
  try{
    const r=await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',{
      method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+CFG.key},
      body:JSON.stringify(body)});
    const d=await r.json();return d.choices?.[0]?.message?.content?.trim()||null;
  }catch(e){return null}
}
async function callVision(sysPrompt,imgB64,userText,opts={}){
  return callAI([
    {role:'system',content:sysPrompt},
    {role:'user',content:[{type:'image_url',image_url:{url:'data:image/jpeg;base64,'+imgB64}},{type:'text',text:userText}]}
  ],{maxTok:opts.maxTok||800,...opts});
}

// ---- Patient ----
function addPat(){const n=$('#newPat').value.trim();if(!n)return;$('#newPat').value='';addPatDirect(n);renderSet();renderPatSel()}
function addPatDirect(name){const p=pats();p.push({id:'p_'+Date.now(),name,created:new Date().toISOString()});savePats(p)}
function switchPat(id){curPat=id;localStorage.setItem('hc_cp',id);renderPatSel();renderHome();show('å·²åˆ‡æ¢')}
function delPat(id){if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ'))return;let p=pats().filter(x=>x.id!==id);savePats(p);if(curPat===id){curPat=p[0]?.id||'';localStorage.setItem('hc_cp',curPat)}renderSet();renderPatSel()}
function renderPatSel(){
  const p=pats();$('#patSel').innerHTML=p.map(x=>`<div class="pc${x.id===curPat?' on':''}" onclick="switchPat('${x.id}')">${x.name}</div>`).join('')+`<div class="pc add" onclick="$$('.ni')[6].click()">+</div>`;
}
function curPatName(){return pats().find(p=>p.id===curPat)?.name||''}

// ---- Home ----
function renderHome(){
  renderPatSel();
  const r=recs(),m=meds(),today=new Date().toISOString().split('T')[0];
  const ck=checks().filter(c=>c.d===today);
  $('#homeStats').innerHTML=`<div class="stat-b"><div class="sv">${r.length}</div><div class="sl">æ¡£æ¡ˆ</div></div>
    <div class="stat-b"><div class="sv">${m.length}</div><div class="sl">ç”¨è¯</div></div>
    <div class="stat-b"><div class="sv">${ck.length}</div><div class="sl">ä»Šæ—¥æ‰“å¡</div></div>`;
  // Recent
  const rec3=r.slice(-3).reverse();
  $('#recentRecs').innerHTML=rec3.length?rec3.map(x=>`<div style="padding:6px 0;border-bottom:1px solid var(--border);font-size:11px">
    <span class="tag t-date">${x.date||'?'}</span><span class="tag t-hosp">${x.hospital||'?'}</span>${x.diagnosis?`<span class="tag t-diag">${x.diagnosis}</span>`:''}
  </div>`).join(''):'<div style="color:var(--text3);font-size:11px">æš‚æ— ï¼Œç‚¹ğŸ“¸å½•å…¥</div>';
  renderTodayMeds2();genGreeting();
}
function renderTodayMeds2(){
  const m=meds(),today=new Date().toISOString().split('T')[0],ck=checks();
  $('#todayMeds2').innerHTML=m.filter(x=>x.on).slice(0,3).map(x=>{
    const done=ck.some(c=>c.mid===x.id&&c.d===today);
    return`<div style="font-size:11px;padding:3px 0;display:flex;gap:6px;align-items:center">
      <span style="color:${done?'var(--green)':'var(--text3)'}">${done?'âœ…':'â¬œ'}</span>${x.name} ${x.time||''}</div>`}).join('')||'<div style="color:var(--text3);font-size:11px">æš‚æ— </div>';
}
async function genGreeting(){
  const pat=curPatName(),r=recs().slice(-3),m=mem();
  const ctx=r.map(x=>`${x.date}: ${x.diagnosis||'æ£€æŸ¥'}`).join('; ');
  const longM=m.l.slice(-3).join('; ');
  const now=new Date(),h=now.getHours(),timeW=h<12?'ä¸Šåˆ':'ä¸‹åˆ';
  const resp=await callAI([{role:'user',content:`ä½ æ˜¯${pat}çš„å¥åº·åŠ©æ‰‹ã€‚ç”Ÿæˆç®€çŸ­æ¸©æš–çš„é—®å€™(40å­—å†…)ã€‚
ç°åœ¨${timeW}ã€‚æœ€è¿‘å°±è¯Šï¼š${ctx||'æš‚æ— '}ã€‚é•¿æœŸè®°å¿†ï¼š${longM||'æš‚æ— '}ã€‚è¦å…³æ€€ä¸å•°å—¦ã€‚`}],{maxTok:80});
  $('#aiMsg').textContent=resp||`${timeW}å¥½ï¼è®°å¾—æŒ‰æ—¶åƒè¯ ğŸ˜Š`;
}

// ---- VLM Image OCR ----
let pendingImgs=[];
function onImg(e){
  Array.from(e.target.files).forEach(f=>{
    const reader=new FileReader();
    reader.onload=async ev=>{
      const b64=ev.target.result.split(',')[1];
      const prev=document.createElement('img');prev.src=ev.target.result;prev.style.cssText='height:60px;border-radius:6px;border:1px solid var(--border)';
      prev.onclick=()=>viewImg(ev.target.result);
      $('#uploadPrev').appendChild(prev);
      pendingImgs.push({b64,src:ev.target.result});
      $('#ocrSt').textContent=`ğŸ” AIè¯†åˆ«ä¸­ (ç¬¬${pendingImgs.length}å¼ )...`;
      await extractMedicalInfo(b64,ev.target.result);
    };reader.readAsDataURL(f);
  });e.target.value='';
}

async function extractMedicalInfo(b64,srcUrl){
  const patName=curPatName();
  const resp=await callVision(
    `ä½ æ˜¯åŒ»ç–—OCRä¸“å®¶ã€‚ä»å›¾ç‰‡æå–æ‰€æœ‰åŒ»ç–—ä¿¡æ¯ï¼Œè¿”å›JSONã€‚
é‡è¦ï¼šå¦‚æœå›¾ç‰‡ä¸­æœ‰æ‚£è€…å§“åï¼Œå¿…é¡»æå–åˆ°patient_nameå­—æ®µã€‚
å­—æ®µï¼š
{"patient_name":"æ‚£è€…å§“å","gender":"æ€§åˆ«","age":"å¹´é¾„",
"date":"å°±è¯Šæ—¥æœŸYYYY-MM-DD","hospital":"åŒ»é™¢","department":"ç§‘å®¤","doctor":"åŒ»ç”Ÿ",
"diagnosis":"è¯Šæ–­","pathology":"ç—…ç†ç»“æœ",
"medications":[{"name":"è¯å","dose":"å‰‚é‡","freq":"é¢‘æ¬¡","duration":"å‘¨æœŸ"}],
"tests":[{"name":"é¡¹ç›®","value":"å€¼","unit":"å•ä½","reference":"å‚è€ƒèŒƒå›´","abnormal":true/false}],
"notes":"å…¶ä»–é‡è¦ä¿¡æ¯"}
æ— æ³•è¯†åˆ«çš„å­—æ®µç•™ç©ºå­—ç¬¦ä¸²ã€‚åªè¿”å›JSONã€‚`,
    b64,'æå–æ­¤åŒ»ç–—æ–‡æ¡£çš„æ‰€æœ‰ä¿¡æ¯',{maxTok:1000});

  if(!resp){$('#ocrSt').textContent='âš ï¸ è¯†åˆ«å¤±è´¥';return}
  try{
    const data=JSON.parse(resp.replace(/```json\n?/g,'').replace(/```/g,'').trim());
    // Check patient name mismatch
    if(data.patient_name&&data.patient_name!==patName&&patName!=='é»˜è®¤æ‚£è€…'){
      if(confirm(`æ£€æµ‹åˆ°æ‚£è€…å§“å"${data.patient_name}"ä¸å½“å‰æ‚£è€…"${patName}"ä¸åŒã€‚\n\næ˜¯å¦ä¸º"${data.patient_name}"åˆ›å»ºæ–°æ¡£æ¡ˆï¼Ÿ`)){
        addPatDirect(data.patient_name);
        const newPat=pats().find(p=>p.name===data.patient_name);
        if(newPat){switchPat(newPat.id)}
      }
    }else if(data.patient_name&&patName==='é»˜è®¤æ‚£è€…'){
      // Rename default patient
      const ps=pats();const cur=ps.find(p=>p.id===curPat);if(cur){cur.name=data.patient_name;savePats(ps)}
    }
    renderExtractedCards(data,srcUrl);
    autoFillForm(data);
    $('#ocrSt').textContent='âœ… è¯†åˆ«å®Œæˆï¼æŸ¥çœ‹ä¸‹æ–¹æå–ç»“æœï¼Œç¡®è®¤åä¿å­˜ã€‚';
    $('#manualForm').style.display='block';
  }catch(err){$('#ocrSt').textContent='âš ï¸ è§£æå¤±è´¥: '+err.message}
}

function renderExtractedCards(data,imgSrc){
  const el=$('#extractedCards');
  let html='';
  // Patient info card
  if(data.patient_name||data.gender||data.age){
    html+=`<div class="cd"><h4>ğŸ‘¤ æ‚£è€…ä¿¡æ¯</h4>
      <div style="font-size:12px;color:var(--text2);line-height:1.8">
      ${data.patient_name?`å§“åï¼š<b>${data.patient_name}</b><br>`:''}
      ${data.gender?`æ€§åˆ«ï¼š${data.gender} `:''}${data.age?`å¹´é¾„ï¼š${data.age}`:''}
      </div></div>`;
  }
  // Diagnosis card
  if(data.diagnosis||data.pathology){
    html+=`<div class="cd" style="border-left:3px solid var(--red)"><h4>ğŸ©º è¯Šæ–­</h4>
      <div style="font-size:13px;line-height:1.6">
      ${data.diagnosis?`<div><span class="tag t-diag">${data.diagnosis}</span></div>`:''}
      ${data.pathology?`<div style="margin-top:4px;font-size:11px;color:var(--text2)">ç—…ç†ï¼š${data.pathology}</div>`:''}
      </div></div>`;
  }
  // Test results card
  if(data.tests?.length){
    html+=`<div class="cd" style="border-left:3px solid var(--cyan)"><h4>ğŸ”¬ æ£€æµ‹ç»“æœ</h4>
      ${data.tests.map(t=>`<div class="test-row${t.abnormal?' abn':''}">
        <span class="tn">${t.name}</span>
        <span class="tv">${t.value}${t.unit?' '+t.unit:''} ${t.abnormal?'âš ï¸':''}</span>
        ${t.reference?`<span style="font-size:9px;color:var(--text3)">(${t.reference})</span>`:''}
      </div>`).join('')}</div>`;
  }
  // Medications card
  if(data.medications?.length){
    html+=`<div class="cd" style="border-left:3px solid var(--green)"><h4>ğŸ’Š ç”¨è¯</h4>
      ${data.medications.map(m=>`<div style="padding:4px 0;font-size:12px;border-bottom:1px solid var(--border)">
        <span class="tag t-med">${m.name}</span> ${m.dose||''} ${m.freq||''} ${m.duration||''}
      </div>`).join('')}</div>`;
  }
  // Visit info card
  if(data.hospital||data.date){
    html+=`<div class="cd"><h4>ğŸ¥ å°±è¯Šä¿¡æ¯</h4>
      <div style="font-size:12px;color:var(--text2);line-height:1.8">
      ${data.date?`æ—¥æœŸï¼š<span class="tag t-date">${data.date}</span><br>`:''}
      ${data.hospital?`åŒ»é™¢ï¼š<span class="tag t-hosp">${data.hospital}</span><br>`:''}
      ${data.department?`ç§‘å®¤ï¼š${data.department}<br>`:''}
      ${data.doctor?`åŒ»ç”Ÿï¼š${data.doctor}`:''}
      </div></div>`;
  }
  // Original image
  if(imgSrc){
    html+=`<div class="cd"><h4>ğŸ“„ åŸå§‹æ–‡ä»¶</h4><img src="${imgSrc}" style="width:100%;border-radius:8px;cursor:pointer" onclick="viewImg(this.src)"></div>`;
  }
  el.innerHTML=html;
}

function autoFillForm(data){
  if(data.date)$('#aDate').value=data.date;
  if(data.hospital)$('#aHosp').value=data.hospital;
  if(data.department)$('#aDept').value=data.department;
  if(data.doctor)$('#aDoc').value=data.doctor;
  if(data.diagnosis)$('#aDiag').value=data.diagnosis;
  if(data.medications?.length)$('#aMeds').value=data.medications.map(m=>`${m.name} ${m.dose||''} ${m.freq||''}`).join('\n');
  if(data.notes)$('#aNotes').value=data.notes;
}

function saveRecord(){
  const imgStore=imgs();const recId='r_'+Date.now();
  // Store images
  pendingImgs.forEach((img,i)=>{imgStore[recId+'_'+i]=img.src});
  saveImgs(imgStore);

  const rec={id:recId,
    date:$('#aDate').value||new Date().toISOString().split('T')[0],
    hospital:$('#aHosp').value,department:$('#aDept').value,doctor:$('#aDoc').value,
    diagnosis:$('#aDiag').value,medications:$('#aMeds').value,notes:$('#aNotes').value,
    imgCount:pendingImgs.length,ts:Date.now()};
  const r=recs();r.push(rec);saveRecs(r);
  // Memory
  const m=mem();m.s.push({t:`æ–°æ¡£æ¡ˆ: ${rec.date} ${rec.hospital} ${rec.diagnosis}`,ts:Date.now()});
  if(m.s.length>30)m.s=m.s.slice(-20);saveMem(m);
  // Auto-create meds
  if(rec.medications){rec.medications.split('\n').filter(l=>l.trim()).forEach(line=>{
    const ms=meds();ms.push({id:'m_'+Date.now()+Math.random(),name:line.trim(),dose:'',time:'08:00',on:true});saveMeds(ms)})}
  // Clear
  ['aDate','aHosp','aDept','aDoc','aDiag','aMeds','aNotes'].forEach(id=>$('#'+id).value='');
  pendingImgs=[];$('#uploadPrev').innerHTML='';$('#extractedCards').innerHTML='';$('#ocrSt').textContent='';
  show('âœ… æ¡£æ¡ˆå·²ä¿å­˜');
}

// ---- Records Views ----
let curView='tl';
$$('.vt div').forEach(t=>{t.onclick=()=>{$$('.vt div').forEach(x=>x.classList.remove('on'));t.classList.add('on');curView=t.dataset.v;renderRecs()}});

function renderRecs(){
  const r=recs(),el=$('#recsView'),imgS=imgs();
  if(!r.length){el.innerHTML='<div style="text-align:center;color:var(--text3);padding:30px">æš‚æ— æ¡£æ¡ˆ</div>';return}
  if(curView==='tl'){
    const sorted=[...r].sort((a,b)=>(b.date||'').localeCompare(a.date||''));
    el.innerHTML=sorted.map(x=>buildRecCard(x,imgS)).join('');
  }else if(curView==='dis'){
    const g={};r.forEach(x=>{const d=x.diagnosis||'å…¶ä»–';if(!g[d])g[d]=[];g[d].push(x)});
    el.innerHTML=Object.entries(g).map(([d,rs])=>`<div class="cd"><h4><span class="tag t-diag">${d}</span> ${rs.length}æ¬¡</h4>
      ${rs.map(x=>`<div style="font-size:11px;color:var(--text2);padding:3px 0;border-bottom:1px solid var(--border)">${x.date||'?'} Â· ${x.hospital||''}</div>`).join('')}</div>`).join('');
  }else{
    const g={};r.forEach(x=>{const h=x.hospital||'æœªçŸ¥';if(!g[h])g[h]=[];g[h].push(x)});
    el.innerHTML=Object.entries(g).map(([h,rs])=>`<div class="cd"><h4><span class="tag t-hosp">${h}</span> ${rs.length}æ¬¡</h4>
      ${rs.map(x=>`<div style="font-size:11px;color:var(--text2);padding:3px 0;border-bottom:1px solid var(--border)">${x.date||'?'} Â· ${x.diagnosis||'æ£€æŸ¥'}</div>`).join('')}</div>`).join('');
  }
}
function buildRecCard(rec,imgS){
  const imgKeys=Object.keys(imgS).filter(k=>k.startsWith(rec.id+'_'));
  return`<div class="rec-card">
    <div class="rec-header"><span class="rec-date">ğŸ“… ${rec.date||'?'}</span><span class="rec-hosp">ğŸ¥ ${rec.hospital||''}</span>${rec.department?`<span style="font-size:10px;color:var(--text3)">${rec.department}</span>`:''}</div>
    <div class="rec-body">
      ${rec.diagnosis?`<div class="rec-section"><div class="rs-title">è¯Šæ–­</div><div class="rs-content"><span class="tag t-diag">${rec.diagnosis}</span></div></div>`:''}
      ${rec.medications?`<div class="rec-section"><div class="rs-title">ç”¨è¯</div><div class="rs-content">${rec.medications.split('\n').filter(l=>l.trim()).map(m=>`<span class="tag t-med">${m.trim()}</span>`).join('')}</div></div>`:''}
      ${rec.notes?`<div class="rec-section"><div class="rs-title">å¤‡æ³¨</div><div class="rs-content">${rec.notes}</div></div>`:''}
      ${rec.doctor?`<div class="rec-section"><div class="rs-title">åŒ»ç”Ÿ</div><div class="rs-content">${rec.doctor}</div></div>`:''}
    </div>
    ${imgKeys.length?`<div class="rec-imgs">${imgKeys.map(k=>`<img src="${imgS[k]}" onclick="viewImg(this.src)">`).join('')}</div>`:''}
  </div>`;
}

// ---- Chat (RAG + Web Search) ----
function renderChat(){
  const msgs=chatH(),el=$('#chatW'),imgS=imgs();
  el.innerHTML=msgs.map(m=>{
    let extra='';
    if(m.searching)extra=`<div class="search-badge">ğŸŒ æ­£åœ¨è”ç½‘æœç´¢...</div>`;
    if(m.searched)extra=`<div class="search-badge">ğŸŒ å·²è”ç½‘æœç´¢</div>`;
    if(m.citeId){
      const citeImgKey=Object.keys(imgS).find(k=>k.startsWith(m.citeId+'_'));
      if(citeImgKey)extra+=`<div class="cite" onclick="viewImg('${imgS[citeImgKey]}')"><img src="${imgS[citeImgKey]}"><span>ğŸ“ æŸ¥çœ‹åŸå§‹æ¡£æ¡ˆ</span></div>`;
    }
    return`<div class="cm ${m.role==='user'?'u':'ai'}"><div class="bbl">${extra}${m.text}</div></div>`;
  }).join('');
  el.scrollTop=el.scrollHeight;
}

async function sendMsg(){
  const q=$('#chatInp').value.trim();if(!q)return;$('#chatInp').value='';
  const msgs=chatH();msgs.push({role:'user',text:q});saveChatH(msgs);renderChat();

  const r=recs(),imgS=imgs(),pat=curPatName(),m=mem();
  // Build RAG context with record IDs for citation
  const recCtx=r.slice(-15).map(x=>`[ID:${x.id}][${x.date}] ${x.hospital||''} ${x.department||''} è¯Šæ–­:${x.diagnosis||'æ— '} ç”¨è¯:${x.medications||'æ— '} å¤‡æ³¨:${x.notes||''}`).join('\n');
  const shortMem=m.s.slice(-10).map(x=>x.t).join('\n');
  const longMem=m.l.slice(-5).join('\n');

  // First try without search
  let resp=await callAI([{role:'system',content:`ä½ æ˜¯${pat}çš„å¥åº·åŠ©æ‰‹ã€‚æ ¹æ®çœŸå®æ¡£æ¡ˆå›ç­”ï¼Œå¿…é¡»æ ‡æ³¨æ¥æºã€‚
å›ç­”æ ¼å¼ï¼šå…ˆå›ç­”é—®é¢˜ï¼Œç„¶ååœ¨æœ€åä¸€è¡Œå†™ [æ¥æº:è®°å½•ID] å¦‚ [æ¥æº:r_1234567]ã€‚
å¦‚æœæ¡£æ¡ˆä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œå›ç­”"æ¡£æ¡ˆä¸­æœªæ‰¾åˆ°æ­¤ä¿¡æ¯"å¹¶å»ºè®®è”ç½‘æœç´¢ã€‚
ä¸è¦ç¼–é€ æ•°æ®ã€‚ç®€æ´ä¸“ä¸šã€‚

### æ‚£è€…æ¡£æ¡ˆ ###
${recCtx||'æš‚æ— '}
### çŸ­æœŸè®°å¿† ###
${shortMem||'æš‚æ— '}
### é•¿æœŸè®°å¿† ###
${longMem||'æš‚æ— '}`},{role:'user',content:q}],{maxTok:400});

  // Check if need web search
  let searched=false;
  if(resp&&(resp.includes('æœªæ‰¾åˆ°')||resp.includes('å»ºè®®æœç´¢')||resp.includes('æ— æ³•ç¡®å®š'))){
    msgs.push({role:'ai',text:'ğŸŒ æ­£åœ¨è”ç½‘æœç´¢...',searching:true});saveChatH(msgs);renderChat();
    const webResp=await callAI([{role:'user',content:`${q}\n\nè¯·åŸºäºç½‘ç»œæœç´¢ç»“æœå›ç­”ï¼Œæ ‡æ˜ä¿¡æ¯æ¥æºã€‚`}],{maxTok:500,search:true});
    if(webResp){resp=webResp;searched=true}
    msgs.pop(); // remove searching msg
  }

  // Extract citation
  let citeId=null;
  const citeMatch=resp?.match(/\[æ¥æº:(r_\d+)\]/);
  if(citeMatch){citeId=citeMatch[1];resp=resp.replace(/\[æ¥æº:r_\d+\]/g,'').trim()}

  const aiMsg={role:'ai',text:resp||'æŠ±æ­‰ï¼Œæ— æ³•å›ç­”ã€‚',citeId,searched};
  msgs.push(aiMsg);saveChatH(msgs);renderChat();

  // Update memory
  const memory=mem();memory.s.push({t:`é—®:${q.slice(0,30)} ç­”:${(resp||'').slice(0,50)}`,ts:Date.now()});
  if(memory.s.length>30)memory.s=memory.s.slice(-20);saveMem(memory);
}

async function onChatImg(e){
  const f=e.target.files[0];if(!f)return;
  const reader=new FileReader();
  reader.onload=async ev=>{
    const b64=ev.target.result.split(',')[1];
    const msgs=chatH();msgs.push({role:'user',text:'[ğŸ“· ä¸Šä¼ å›¾ç‰‡åˆ†æ]'});saveChatH(msgs);renderChat();
    const resp=await callVision('ä½ æ˜¯åŒ»ç–—ä¸“å®¶ã€‚åˆ†ææ­¤åŒ»ç–—æ–‡æ¡£/æ£€æŸ¥æŠ¥å‘Šï¼ŒæŒ‡å‡ºå…³é”®ä¿¡æ¯ã€å¼‚å¸¸å€¼å’Œå»ºè®®ã€‚',b64,'åˆ†ææ­¤åŒ»ç–—æ–‡ä»¶');
    msgs.push({role:'ai',text:resp||'æ— æ³•åˆ†æ'});saveChatH(msgs);renderChat();
  };reader.readAsDataURL(f);e.target.value='';
}

// ---- Meds ----
function renderMeds(){
  const m=meds(),today=new Date().toISOString().split('T')[0],ck=checks();
  $('#medsL').innerHTML=m.filter(x=>x.on).map(x=>{
    const done=ck.some(c=>c.mid===x.id&&c.d===today);
    return`<div class="med-i"><div class="mi-icon">ğŸ’Š</div>
      <div class="mi-info"><div class="mi-name">${x.name}</div><div class="mi-dose">${x.dose||''} Â· ${x.time||''}</div></div>
      <div class="mi-chk${done?' done':''}" onclick="toggleChk('${x.id}')">${done?'âœ“':''}</div></div>`}).join('')||'<div style="color:var(--text3);font-size:11px">æš‚æ— </div>';
  const total=m.filter(x=>x.on).length*7;const done7=ck.filter(c=>(Date.now()-new Date(c.d).getTime())<7*864e5).length;
  const rate=total>0?Math.round(done7/total*100):0;
  $('#compli').innerHTML=`è¿‘7å¤©ï¼š<b style="color:${rate>=80?'var(--green)':rate>=50?'var(--warm)':'var(--red)'}">${rate}%</b> (${done7}/${total})`;
}
function addMed(){
  const n=$('#mName').value.trim();if(!n){show('è¾“å…¥è¯å');return}
  const m=meds();m.push({id:'m_'+Date.now(),name:n,dose:$('#mDose').value,time:$('#mTime').value||'08:00',on:true});saveMeds(m);
  $('#mName').value='';$('#mDose').value='';renderMeds();show('âœ…');
  if(window.NativeBridge){const[h,mi]=($('#mTime').value||'08:00').split(':').map(Number);const t=new Date();t.setHours(h,mi,0);if(t<=new Date())t.setDate(t.getDate()+1);
    try{window.NativeBridge.scheduleReminder('ğŸ’Š '+n,n,t.getTime(),Math.floor(Math.random()*1e5))}catch(e){}}
}
function toggleChk(mid){
  const today=new Date().toISOString().split('T')[0],ck=checks();
  const i=ck.findIndex(c=>c.mid===mid&&c.d===today);
  if(i>=0)ck.splice(i,1);else ck.push({mid,d:today,t:new Date().toLocaleTimeString('zh-CN')});
  saveChecks(ck);renderMeds();renderTodayMeds2();
  if(window.NativeBridge)try{window.NativeBridge.vibrate(80)}catch(e){}
}

// ---- Memory (visible to user) ----
function renderMem(){
  const m=mem();
  $('#sMemV').innerHTML=m.s.slice(-10).reverse().map(x=>`<div class="mem-entry"><span class="mt">${new Date(x.ts).toLocaleString('zh-CN')}</span> ${x.t}</div>`).join('')||'æš‚æ— ';
  $('#lMemV').innerHTML=m.l.length?m.l.map(x=>`<div class="mem-entry">${x}</div>`).join(''):'æš‚æ— ';
  $('#rMemV').innerHTML=m.r.length?m.r.map(x=>`<div class="mem-entry"><span class="mt">${x.time||''}</span> ${x.t}</div>`).join(''):'æš‚æ— ';
}
async function triggerReflect(){
  show('ğŸ”® AIåæ€ä¸­...');
  const r=recs(),m=mem(),pat=curPatName();
  const ctx=r.slice(-10).map(x=>`${x.date}: ${x.diagnosis||'æ£€æŸ¥'} @ ${x.hospital||''}`).join('\n');
  const shortM=m.s.slice(-15).map(x=>x.t).join('\n');
  const resp=await callAI([{role:'user',content:`ä½ æ˜¯${pat}çš„å¥åº·é¡¾é—®ã€‚åŸºäºä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆå¥åº·ç”»åƒåæ€ï¼ˆ100å­—å†…ï¼‰ï¼š
æ¡£æ¡ˆï¼š${ctx||'æš‚æ— '}
è¿‘æœŸäº‹ä»¶ï¼š${shortM||'æš‚æ— '}
è¯·æ€»ç»“ï¼š1)ä¸»è¦å¥åº·é—®é¢˜ 2)æ³¨æ„äº‹é¡¹ 3)æƒ…ç»ª/ç”Ÿæ´»å»ºè®®`}],{maxTok:200});
  if(resp){
    m.r.push({t:resp,time:new Date().toLocaleString('zh-CN')});
    // Extract key facts to long-term
    m.l.push(resp.slice(0,100));if(m.l.length>20)m.l=m.l.slice(-15);
    m.s=m.s.slice(-10); // compact short-term
    saveMem(m);renderMem();show('âœ… åæ€å®Œæˆ');
  }
}
function exportMem(){
  const data=JSON.stringify(mem(),null,2);
  const blob=new Blob([data],{type:'application/json'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`${curPatName()}_memory.json`;a.click();
  URL.revokeObjectURL(url);show('å·²å¯¼å‡º');
}

// ---- Settings ----
function saveCfg(){CFG.key=$('#sKey').value.trim();localStorage.setItem('hc_k',CFG.key);show('âœ…')}
function renderSet(){
  const p=pats();$('#patList').innerHTML=p.map(x=>
    `<div style="display:flex;align-items:center;gap:6px;padding:6px 0;border-bottom:1px solid var(--border)">
      <span style="flex:1;font-size:12px">${x.name}${x.id===curPat?' ğŸ‘ˆ':''}</span>
      <button class="btn btn-g" style="padding:4px 10px;font-size:10px" onclick="switchPat('${x.id}')">åˆ‡æ¢</button>
      <button class="btn btn-g" style="padding:4px 10px;font-size:10px;color:var(--red)" onclick="delPat('${x.id}')">åˆ é™¤</button>
    </div>`).join('');
}

// ---- Utils ----
function viewImg(src){$('#modalImg').src=src;$('#imgModal').classList.add('show')}
function show(m){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500)}
</script>
</body>
</html>
