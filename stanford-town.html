<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stanford Small Town v3</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#0a0e1a;--bg2:#0f1525;--panel:#141c2e;--panel2:#1a2540;--card:#1e2d4a;--accent:#6c9fff;--accent2:#4a7fff;--aglow:rgba(108,159,255,.15);--warm:#ffb347;--green:#5cd65c;--red:#ff6b6b;--purple:#a78bfa;--cyan:#67e8f9;--teal:#5eead4;--pink:#ff8fab;--text:#e8edf5;--text2:#8899b4;--text3:#5a6a85;--border:#1e2d4a;--border2:#2a3d5e;--r:12px;--rs:8px}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
.app{display:grid;grid-template-columns:240px 1fr 360px;grid-template-rows:52px 1fr;height:100vh;gap:1px;background:var(--border)}
.header{grid-column:1/-1;background:var(--bg2);display:flex;align-items:center;padding:0 20px;gap:16px}
.header h1{font-size:16px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stats{display:flex;gap:14px;margin-left:20px}.stat{font-size:11px;color:var(--text3)}.stat b{color:var(--text)}
.time-d{margin-left:auto;font-size:14px;color:var(--warm);font-weight:600;font-variant-numeric:tabular-nums}
.ctrls{display:flex;gap:5px;margin-left:12px}
.hb{background:var(--panel2);border:1px solid var(--border2);color:var(--text2);padding:6px 12px;border-radius:var(--rs);cursor:pointer;font-size:11px;font-weight:500;transition:.2s}
.hb:hover{border-color:var(--accent);color:var(--text)}.hb.on{background:var(--accent2);color:#fff;border-color:var(--accent)}
.spd{background:var(--panel2);border:1px solid var(--border2);color:var(--text);padding:5px 8px;border-radius:var(--rs);font-size:11px}
/* Sidebar */
.side{background:var(--bg2);overflow-y:auto;display:flex;flex-direction:column}
.side-sec{padding:12px}
.stitle{font-size:10px;text-transform:uppercase;color:var(--text3);letter-spacing:1.5px;font-weight:700;margin-bottom:8px}
.ac{background:var(--panel);border:1px solid transparent;border-radius:var(--rs);padding:8px 10px;margin-bottom:5px;cursor:pointer;transition:.2s}
.ac:hover{background:var(--panel2);border-color:var(--border2)}.ac.sel{background:var(--card);border-color:var(--accent);box-shadow:0 0 10px var(--aglow)}
.ac .at{display:flex;align-items:center;gap:7px}.ac .ae{font-size:18px;width:30px;height:30px;display:flex;align-items:center;justify-content:center;background:var(--panel2);border-radius:50%}
.ac .an{font-size:12px;font-weight:600}.ac .ao{font-size:10px;color:var(--text3)}
.ac .ar{display:flex;gap:10px;margin-top:4px;font-size:10px;color:var(--text2)}
.ac .new-badge{font-size:9px;background:var(--pink);color:#fff;padding:1px 5px;border-radius:8px;margin-left:auto}
.bc-sec{padding:12px;border-top:1px solid var(--border);margin-top:auto}
.bc-sec textarea{width:100%;height:50px;background:var(--panel);border:1px solid var(--border2);border-radius:var(--rs);color:var(--text);padding:7px 9px;font-size:11px;resize:none;font-family:inherit;outline:none}
.bc-sec textarea:focus{border-color:var(--warm)}.bc-sec textarea::placeholder{color:var(--text3)}
.bc-btn{width:100%;margin-top:5px;background:linear-gradient(135deg,var(--warm),#ff8a50);border:none;color:#fff;padding:7px;border-radius:var(--rs);cursor:pointer;font-size:11px;font-weight:600}
/* Center */
.center{background:var(--bg);display:flex;flex-direction:column;overflow:hidden}
.ctabs{display:flex;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0}
.ct{padding:9px 16px;font-size:11px;font-weight:600;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;transition:.2s}
.ct:hover{color:var(--text2)}.ct.on{color:var(--accent);border-bottom-color:var(--accent)}
.cc{flex:1;overflow:hidden;position:relative}.tp{display:none;width:100%;height:100%;overflow:auto}.tp.on{display:block}
/* Conv */
.cv{padding:14px;display:flex;flex-direction:column;gap:10px}
.cb{background:var(--panel);border-radius:var(--r);padding:10px 12px;border-left:3px solid var(--accent)}
.cb .ch{display:flex;align-items:center;gap:6px;margin-bottom:5px;font-size:10px}.cb .ct2{color:var(--text3);margin-left:auto}.cb .cl{color:var(--green);background:rgba(94,234,212,.08);padding:1px 5px;border-radius:4px}
.cb .ln{font-size:12px;line-height:1.6;padding:2px 0}.cb .sp{font-weight:600;color:var(--accent)}.cb .sp.b{color:var(--purple)}
/* Timeline */
.tl-wrap{padding:14px}
.tl-tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.tl-tag{font-size:10px;padding:4px 10px;border-radius:16px;cursor:pointer;border:1px solid var(--border2);color:var(--text2);background:var(--panel);transition:.2s;user-select:none}
.tl-tag:hover{border-color:var(--accent)}.tl-tag.on{background:var(--accent2);color:#fff;border-color:var(--accent)}
.tl-tag.bc{border-color:var(--warm)}.tl-tag.bc.on{background:var(--warm);border-color:var(--warm)}
.tl{display:flex;flex-direction:column}
.ti{display:flex;gap:10px;padding:6px 0;position:relative}.ti::before{content:'';position:absolute;left:13px;top:26px;bottom:-6px;width:2px;background:var(--border2)}.ti:last-child::before{display:none}
.td{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;z-index:1;border:2px solid var(--border2);background:var(--card)}
.td.ev{border-color:var(--green)}.td.co{border-color:var(--accent)}.td.th{border-color:var(--purple)}.td.br{border-color:var(--warm)}.td.su{border-color:var(--cyan)}.td.np{border-color:var(--pink)}
.tb{flex:1;min-width:0}.tb .tt{font-size:9px;color:var(--text3)}.tb .tx{font-size:11px;color:var(--text2);margin-top:1px;line-height:1.5}.tb .ta{font-weight:600;color:var(--text)}
.tb .kw{display:inline-block;font-size:9px;background:rgba(108,159,255,.15);color:var(--accent);padding:1px 6px;border-radius:8px;margin:2px 2px 0 0}
/* Graph */
.graph-wrap{position:relative;width:100%;height:100%}#graphCanvas{width:100%;height:100%}
.graph-legend{position:absolute;bottom:10px;left:10px;background:var(--panel);border:1px solid var(--border2);border-radius:var(--rs);padding:8px 10px;font-size:10px;color:var(--text2)}
.graph-legend div{display:flex;align-items:center;gap:5px;margin:2px 0}.graph-legend span{display:inline-block;width:10px;height:10px;border-radius:50%}
/* Summary */
.sc{background:linear-gradient(135deg,var(--panel),var(--card));border:1px solid var(--border2);border-radius:var(--r);padding:12px;margin:12px 14px}
.sc h4{font-size:12px;color:var(--cyan);margin-bottom:6px}.sc p{font-size:11px;color:var(--text2);line-height:1.6}
.sc .tps{display:flex;flex-wrap:wrap;gap:5px;margin-top:6px}.sc .tp2{background:rgba(103,232,249,.1);color:var(--cyan);font-size:10px;padding:2px 8px;border-radius:14px;border:1px solid rgba(103,232,249,.2)}
/* Right */
.rp{background:var(--bg2);overflow-y:auto;display:flex;flex-direction:column;gap:1px}
.rs{background:var(--bg2);padding:12px}
.rt{font-size:10px;text-transform:uppercase;color:var(--text3);letter-spacing:1.5px;font-weight:700;margin-bottom:8px}
.rah{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.rah .re{font-size:28px;width:46px;height:46px;display:flex;align-items:center;justify-content:center;background:var(--panel);border-radius:50%;border:2px solid var(--border2)}
.rah h3{font-size:15px;font-weight:700}.rah p{font-size:11px;color:var(--text2)}
.rm{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px}
.rmi{background:var(--panel);border-radius:6px;padding:6px 8px}.rmi .lb{font-size:9px;color:var(--text3);text-transform:uppercase}.rmi .vl{font-size:12px;font-weight:600;margin-top:1px}
.rmi .vl.lc{color:var(--green)}.rmi .vl.md{color:var(--purple)}.rmi .vl.ac2{color:var(--accent)}
.tc{background:var(--panel);border-radius:6px;padding:8px 10px;border-left:3px solid var(--purple);margin-bottom:8px}
.tc .tl2{font-size:9px;color:var(--purple);font-weight:600;text-transform:uppercase;letter-spacing:.5px}.tc .tx2{font-size:11px;color:var(--text2);margin-top:3px;line-height:1.5}
.ml{display:flex;flex-direction:column;gap:3px}
.mi{background:var(--panel);border-radius:5px;padding:5px 8px;font-size:10px;color:var(--text2);line-height:1.5}.mi .mt{color:var(--warm);font-size:9px}
.ms2{display:grid;grid-template-columns:repeat(4,1fr);gap:5px}
.ms3{background:var(--panel);border-radius:5px;padding:5px;text-align:center}.ms3 .v{font-size:14px;font-weight:700;color:var(--accent)}.ms3 .l{font-size:8px;color:var(--text3);text-transform:uppercase;margin-top:1px}
/* Modal */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(4px)}
.md{background:var(--panel);border:1px solid var(--border2);border-radius:16px;padding:28px;width:460px;box-shadow:0 20px 60px rgba(0,0,0,.4)}
.md h2{font-size:20px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px}
.md p{font-size:12px;color:var(--text2);line-height:1.6;margin-bottom:16px}
.md input{width:100%;padding:10px 12px;background:var(--bg2);border:1px solid var(--border2);border-radius:var(--rs);color:var(--text);font-size:13px;outline:none;font-family:monospace}
.md input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--aglow)}
.md .br2{display:flex;gap:8px;margin-top:16px}
.md .mb{flex:1;padding:9px;border-radius:var(--rs);border:1px solid var(--border2);font-size:12px;font-weight:600;cursor:pointer;transition:.2s}
.md .mp{background:linear-gradient(135deg,var(--accent2),var(--purple));color:#fff;border-color:transparent}.md .mg{background:transparent;color:var(--text2)}
.hidden{display:none!important}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <span style="font-size:22px">ğŸ˜ï¸</span><h1>Stanford Small Town</h1>
    <div class="stats">
      <div class="stat">ğŸ‘¥ <b id="sA">5</b></div>
      <div class="stat">ğŸ’¬ <b id="sC">0</b></div>
      <div class="stat">ğŸ§  <b id="sR">0</b></div>
      <div class="stat">ğŸ“¡ <b id="sB">0</b></div>
    </div>
    <div class="time-d" id="tD">Day 1 Â· 06:00</div>
    <select class="spd" id="spd"><option value="1">1x</option><option value="3">3x</option><option value="5" selected>5x</option><option value="10">10x</option><option value="30">30x</option></select>
    <div class="ctrls">
      <button class="hb on" id="bP">â–¶</button>
      <button class="hb" id="bS">â¸</button>
      <button class="hb" id="bR">â†º</button>
    </div>
  </div>
  <div class="side">
    <div class="side-sec" id="aL"><div class="stitle">ğŸ‘¥ å°é•‡å±…æ°‘</div></div>
    <div class="bc-sec">
      <div class="stitle">ğŸ“¡ ç©å®¶å¹¿æ’­</div>
      <textarea id="bcI" placeholder="è¾“å…¥äº‹ä»¶å½±å“å±…æ°‘â€¦ ä¾‹ï¼šå°é•‡ä¸¾åŠç¾é£ŸèŠ‚ï¼&#10;åˆ›å»ºæ–°äººï¼šæ–°å±…æ°‘:å¼ å°èŠ±"></textarea>
      <button class="bc-btn" onclick="sendBroadcast()">ğŸ“¢ å‘å¸ƒ</button>
    </div>
  </div>
  <div class="center">
    <div class="ctabs">
      <div class="ct on" data-t="map">ğŸ—ºï¸ åœ°å›¾</div>
      <div class="ct" data-t="conv">ğŸ’¬ å¯¹è¯</div>
      <div class="ct" data-t="tl">â±ï¸ æ—¶é—´è½´</div>
      <div class="ct" data-t="graph">ğŸ•¸ï¸ å…³ç³»å›¾è°±</div>
    </div>
    <div class="cc">
      <div class="tp on" id="t-map"><canvas id="mC"></canvas></div>
      <div class="tp" id="t-conv"><div id="cL" class="cv"></div></div>
      <div class="tp" id="t-tl"><div id="sArea"></div><div id="tlTags" class="tl-tags" style="padding:14px 14px 0"></div><div id="tlL" class="tl-wrap"></div></div>
      <div class="tp" id="t-graph"><div class="graph-wrap">
        <div style="position:absolute;top:8px;left:8px;right:8px;display:flex;align-items:center;gap:8px;z-index:2">
          <span style="font-size:10px;color:var(--text3)">ğŸ“… å¤©æ•°è¿‡æ»¤:</span>
          <select id="graphDay" class="spd" style="font-size:10px"><option value="0">å…¨éƒ¨</option></select>
        </div>
        <canvas id="gC"></canvas>
        <div class="graph-legend"><div><span style="background:var(--accent)"></span> åŸå§‹å±…æ°‘</div><div><span style="background:var(--pink)"></span> AIæ–°å»º</div><div><span style="background:var(--warm)"></span> å¹¿æ’­</div><div>çº¿ç²—=äº’åŠ¨ | å¯æ‹–æ‹½èŠ‚ç‚¹</div></div>
      </div></div>
    </div>
  </div>
  <div class="rp" id="rP"><div class="rs"><div class="rt">ğŸ§  é€‰ä¸­å±…æ°‘</div><div style="font-size:12px;color:var(--text3)">â† ç‚¹å‡»å±…æ°‘æŸ¥çœ‹</div></div></div>
</div>
<div class="mo" id="apiM">
  <div class="md">
    <h2>ğŸ˜ï¸ Stanford Small Town</h2>
    <p>AI é©±åŠ¨çš„å°é•‡æ¨¡æ‹Ÿ Â· åŠ¨æ€äººç‰©åˆ›å»º Â· çŸ¥è¯†å›¾è°± Â· è®°å¿†ç³»ç»Ÿ<br>ä½¿ç”¨ DashScope (qwen3-max) é©±åŠ¨</p>
    <input type="password" id="akI" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"/>
    <div class="br2">
      <button class="mb mg" onclick="startDemo()">ğŸ® æ¼”ç¤ºæ¨¡å¼</button>
      <button class="mb mp" onclick="startApi()">ğŸš€ å¯åŠ¨</button>
    </div>
  </div>
</div>
<script>
const CFG={apiKey:'',baseUrl:'https://dashscope.aliyuncs.com/compatible-mode/v1',model:'qwen3-max',demo:false};
const LOCS=[
  {id:'home_lin',name:'æ—å®¶',x:60,y:80,w:55,h:45,color:'#5c6bc0',icon:'ğŸ '},
  {id:'home_chen',name:'é™ˆå®¶',x:60,y:200,w:55,h:45,color:'#7e57c2',icon:'ğŸ '},
  {id:'home_wang',name:'ç‹å®¶',x:60,y:320,w:55,h:45,color:'#26a69a',icon:'ğŸ '},
  {id:'cafe',name:'å’–å•¡é¦†',x:220,y:60,w:75,h:55,color:'#8d6e63',icon:'â˜•'},
  {id:'library',name:'å›¾ä¹¦é¦†',x:220,y:180,w:75,h:55,color:'#42a5f5',icon:'ğŸ“š'},
  {id:'park',name:'å…¬å›­',x:220,y:310,w:90,h:65,color:'#66bb6a',icon:'ğŸŒ³'},
  {id:'store',name:'æ‚è´§åº—',x:400,y:60,w:65,h:55,color:'#ffa726',icon:'ğŸ›’'},
  {id:'school',name:'å­¦æ ¡',x:400,y:180,w:75,h:55,color:'#ef5350',icon:'ğŸ«'},
  {id:'restaurant',name:'é™ˆè®°å°å¨',x:400,y:310,w:70,h:55,color:'#ec407a',icon:'ğŸœ'},
  {id:'square',name:'å¹¿åœº',x:220,y:420,w:110,h:50,color:'#78909c',icon:'â›²'},
];
const INIT_AGENTS=[
  {id:'lin_mei',name:'æ—æ¢…',emoji:'ğŸ‘©â€ğŸ«',age:34,occ:'å°å­¦æ•™å¸ˆ',pers:'æ¸©æŸ”ç»†å¿ƒï¼Œçƒ­çˆ±æ•™è‚²',home:'home_lin',wake:6,sleep:22,rels:{chen_wei:'é‚»å±…å¥½å‹',wang_gang:'å­¦ç”Ÿå®¶é•¿',zhao_li:'å®¤å‹',liu_peng:'å°Šæ•¬çš„å‰è¾ˆ'},mem:['å–œæ¬¢æ—©æ™¨å»å’–å•¡é¦†å–æ‹¿é“å†å»å­¦æ ¡ã€‚'],gen:false},
  {id:'chen_wei',name:'é™ˆä¼Ÿ',emoji:'ğŸ‘¨â€ğŸ³',age:42,occ:'é¤é¦†è€æ¿',pers:'çƒ­æƒ…è±ªçˆ½ï¼Œå¨è‰ºç²¾æ¹›',home:'home_chen',wake:5,sleep:23,rels:{lin_mei:'é‚»å±…å¥½å‹',wang_gang:'å¸¸å®¢',liu_peng:'çˆ¶äº²',zhao_li:'è¢«å¥¹å®å˜±å¥åº·'},mem:['é™ˆè®°å°å¨å¼€ä¸šä¸‰å¹´ï¼Œæ¯å¤©äº”ç‚¹å¤‡é£Ÿæã€‚'],gen:false},
  {id:'wang_gang',name:'ç‹åˆš',emoji:'ğŸ‘¨â€ğŸ’»',age:28,occ:'è‡ªç”±ç¨‹åºå‘˜',pers:'å†…å‘å®‰é™ï¼ŒæŠ€æœ¯å®…ï¼Œå…»çŒ«',home:'home_wang',wake:9,sleep:1,rels:{lin_mei:'å°æ—¶å€™çš„è€å¸ˆ',chen_wei:'æœ€çˆ±ä»–çš„çº¢çƒ§è‚‰',liu_peng:'å¿˜å¹´äº¤æ£‹å‹',zhao_li:'æœ‰ç‚¹æš—æ‹'},mem:['è¿œç¨‹å·¥ä½œä½åœ¨å°é•‡ï¼Œå…»äº†ä¸€åªå«æ¯”ç‰¹çš„æ©˜çŒ«ã€‚','åœ¨åšç‹¬ç«‹æ¸¸æˆé¡¹ç›®ã€‚'],gen:false},
  {id:'zhao_li',name:'èµµä¸½',emoji:'ğŸ‘©â€âš•ï¸',age:38,occ:'è¯Šæ‰€åŒ»ç”Ÿ',pers:'å†·é™ç†æ€§ï¼Œæœ‰åŒæƒ…å¿ƒ',home:'home_lin',wake:6,sleep:22,rels:{lin_mei:'å®¤å‹',chen_wei:'æé†’ä»–æ³¨æ„å¥åº·',wang_gang:'è§‰å¾—ä»–æœ‰è¶£',liu_peng:'å®šæœŸæ£€æŸ¥èº«ä½“'},mem:['å°é•‡è™½å°ä½†éœ€è¦ä¸€ä¸ªåŒ»ç”Ÿã€‚'],gen:false},
  {id:'liu_peng',name:'åˆ˜é¹',emoji:'ğŸ‘´',age:67,occ:'é€€ä¼‘æ•™æˆ',pers:'åšå­¦å¤šé—»ï¼Œå–œæ¬¢ä¸‹æ£‹',home:'home_chen',wake:5,sleep:21,rels:{chen_wei:'å„¿å­',wang_gang:'å¿˜å¹´äº¤æ£‹å‹',lin_mei:'æ¬£èµå¥¹çš„æ•™è‚²çƒ­æƒ…',zhao_li:'æ„Ÿè°¢å¥¹çš„å…³å¿ƒ'},mem:['é€€ä¼‘åå’Œå„¿å­ä½ï¼Œæ¯å¤©åœ¨å…¬å›­ä¸‹æ£‹ã€‚'],gen:false},
];
// ---- Memory ----
class Mem{
  constructor(){this.stream=[];this.daily={};this.longTerm=[];this.refs=[];this.imp=new Map()}
  add(t,time,i=5){const e={text:t,time:ft(time),ts:time.total,imp:i};this.stream.push(e);this.imp.set(t,i);const dk='D'+time.day;if(!this.daily[dk])this.daily[dk]=[];this.daily[dk].push(e)}
  addRef(t,time){const e={text:t,time:ft(time),ts:time.total};this.refs.push(e);this.longTerm.push(e);this.imp.set(t,8)}
  get(n=8){return this.stream.slice(-n)}
  getLT(){return this.longTerm.slice(-5).map(m=>m.text)}
  retrieve(q,n=5){return[...this.stream,...this.refs].map(m=>{const r=1/(1+(G.time.total-m.ts)/60);const i=(this.imp.get(m.text)||5)/10;const s=sim(q,m.text);return{...m,score:r*.3+i*.3+s*.4}}).sort((a,b)=>b.score-a.score).slice(0,n)}
  needsCompact(){return this.stream.length>20}
  compact(t,time){this.addRef(t,time);this.stream=this.stream.slice(-5)}
}
function sim(a,b){const x=new Set(a.split(/\s+/)),y=new Set(b.split(/\s+/));let o=0;for(const t of x)if(y.has(t))o++;return o/Math.max(x.size,y.size,1)}

class Agent{
  constructor(t){
    this.id=t.id;this.name=t.name;this.emoji=t.emoji;this.age=t.age;this.occ=t.occ;this.pers=t.pers;
    this.home=t.home;this.wake=t.wake;this.sleep=t.sleep;this.rels={...t.rels};this.gen=t.gen||false;
    this.mem=new Mem();this.loc=this.home;this.target=null;this.act='ç¡è§‰';this.thought='';this.mood='å¹³é™';
    this.x=0;this.y=0;this.cd=0;this.lastRef=0;
    const l=LOCS.find(l=>l.id===this.home);if(l){this.x=l.x+l.w/2;this.y=l.y+l.h/2}
    (t.mem||[]).forEach(m=>this.mem.add(m,{day:1,hour:0,minute:0,total:0},7));
  }
}
// ---- State ----
const G={time:{day:1,hour:6,minute:0,total:360},agents:[],run:false,speed:5,sel:null,
  convs:[],bcs:[],sums:[],tl:[],graph:{nodes:[],edges:[]},keywords:new Map(),kwByDay:{},kwFilter:null,kwDayFilter:'å…¨éƒ¨',
  nConv:0,nRef:0,nBc:0};
function ft(t){return`Day ${t.day} Â· ${String(t.hour).padStart(2,'0')}:${String(t.minute).padStart(2,'0')}`}
function fs(t){return`${String(t.hour).padStart(2,'0')}:${String(t.minute).padStart(2,'0')}`}
function adv(m){G.time.minute+=m;G.time.total+=m;while(G.time.minute>=60){G.time.minute-=60;G.time.hour++}while(G.time.hour>=24){G.time.hour-=24;G.time.day++}}

// ---- Graph ----
const GRAPH_POS={lin_mei:{x:150,y:80},chen_wei:{x:350,y:80},wang_gang:{x:250,y:220},zhao_li:{x:100,y:220},liu_peng:{x:400,y:220}};
function graphAddNode(agent){
  if(G.graph.nodes.find(n=>n.id===agent.id))return;
  const pos=GRAPH_POS[agent.id]||{x:120+Math.random()*280,y:100+Math.random()*180};
  G.graph.nodes.push({id:agent.id,name:agent.name,emoji:agent.emoji,gen:agent.gen,x:pos.x,y:pos.y,fx:null,fy:null,dragging:false});
}
function graphAddEdge(a,b,label,rel){
  let e=G.graph.edges.find(e=>(e.a===a&&e.b===b)||(e.a===b&&e.b===a));
  if(e){e.w++;e.labels.push({text:label,time:ft(G.time),day:G.time.day});if(e.labels.length>8)e.labels=e.labels.slice(-8);if(rel)e.rel=rel;}
  else G.graph.edges.push({a,b,w:1,rel:rel||'äº’åŠ¨',labels:[{text:label,time:ft(G.time),day:G.time.day}]});
}
function graphAddBroadcast(text){
  const id='bc_'+G.nBc;
  G.graph.nodes.push({id,name:text.slice(0,8)+'â€¦',emoji:'ğŸ“¡',gen:false,bc:true,x:Math.random()*400+50,y:Math.random()*300+50});
  G.agents.forEach(a=>{if(a.act!=='ç¡è§‰')G.graph.edges.push({a:a.id,b:id,w:1,labels:[{text:'å¬åˆ°å¹¿æ’­',time:ft(G.time)}]})});
}

// ---- Keywords (tracked per day) ----
function addKW(word,type){if(!word||word.length<2)return;const k=word.trim();
  G.keywords.set(k,(G.keywords.get(k)||0)+1);
  const dk='D'+G.time.day;if(!G.kwByDay)G.kwByDay={};if(!G.kwByDay[dk])G.kwByDay[dk]=new Map();
  G.kwByDay[dk].set(k,(G.kwByDay[dk].get(k)||0)+1);
}
function extractKW(text){
  const stops=new Set(['çš„','äº†','åœ¨','æ˜¯','æˆ‘','ä½ ','ä»–','å¥¹','å»','åˆ°','å’Œ','éƒ½','ä¹Ÿ','å°±','ä¸','æœ‰','è¿™','é‚£','å¾ˆ','å¤ª','å—','å‘¢','å•Š','å§','å‘€','å“ˆ','å—¯','è¯´','æƒ³','åš','çœ‹','æ¥','è·Ÿ','è®©','è¢«','æŠŠ','å¯¹','ç»™','ç”¨','ç€','è¿‡','æ²¡','ä¼š','èƒ½','è¦','è¯¥','å¯','å¯ä»¥','ä»€ä¹ˆ','æ€ä¹ˆ','åƒé¥­','æ•£æ­¥','å’–å•¡','å›¾ä¹¦é¦†','å…¬å›­','æ‚è´§åº—','å¹¿åœº','å­¦æ ¡','å°é•‡','å›å®¶','ä¼‘æ¯']);
  text.replace(/[ï¼Œã€‚ï¼ï¼Ÿã€""''ï¼šï¼›\n\[\]]/g,' ').split(/\s+/).filter(w=>w.length>=2&&w.length<=8&&!stops.has(w)).forEach(w=>addKW(w,'auto'));
}

// ---- API ----
async function callQ(sys,usr,mt=300){
  if(CFG.demo)return demoR(usr);
  try{
    const r=await fetch(`${CFG.baseUrl}/chat/completions`,{method:'POST',
      headers:{'Content-Type':'application/json','Authorization':`Bearer ${CFG.apiKey}`},
      body:JSON.stringify({model:CFG.model,messages:[{role:'system',content:sys},{role:'user',content:usr}],max_tokens:mt,temperature:.85,extra_body:{enable_thinking:false}})});
    const d=await r.json();
    if(d.error){console.warn('API:',d.error);return demoR(usr)}
    return d.choices?.[0]?.message?.content?.trim()||demoR(usr);
  }catch(e){console.warn('API fail:',e);return demoR(usr)}
}
function hotspots(h){
  if(h>=6&&h<9)return['cafe','park'];if(h>=9&&h<12)return['library','school','store'];
  if(h>=12&&h<14)return['restaurant','cafe'];if(h>=14&&h<17)return['library','park','square'];
  if(h>=17&&h<20)return['park','square','restaurant'];if(h>=20)return['restaurant','cafe'];return['park'];
}
const DEMO_LINES=['ä½ å¥½ï¼ä»Šå¤©æ€ä¹ˆæ ·ï¼Ÿ','æœ€è¿‘å¿™ä»€ä¹ˆå‘¢ï¼Ÿ','å¤©æ°”çœŸå¥½ï¼Œæ•£æ­¥å»ï¼Ÿ','å¬è¯´é•‡ä¸Šæœ‰æ–°æ¶ˆæ¯äº†ã€‚','å“ˆå“ˆæŒºæœ‰æ„æ€çš„ã€‚','æœ€è¿‘æœ‰ç‚¹ç´¯ä½†è¿˜å¥½ã€‚','è¦ä¸è¦å»å–æ¯å’–å•¡ï¼Ÿ','æˆ‘åˆšçœ‹äº†ä¸€æœ¬å¥½ä¹¦ã€‚'];
const DEMO_ACTS=['å»å’–å•¡é¦†å–å’–å•¡','åœ¨å…¬å›­æ•£æ­¥','å»å›¾ä¹¦é¦†çœ‹ä¹¦','åˆ°æ‚è´§åº—ä¹°ä¸œè¥¿','åœ¨å¹¿åœºåå','å›å®¶ä¼‘æ¯','å»é™ˆè®°å°å¨åƒé¥­','åœ¨å­¦æ ¡å¤‡è¯¾','åœ¨å®¶å†™ä»£ç ','å»å…¬å›­ä¸‹æ£‹'];
const DEMO_MOODS=['å¼€å¿ƒ','å¹³é™','å¥½å¥‡','æ»¡è¶³','æœŸå¾…','ä¸“æ³¨'];
const DEMO_THOUGHTS=['ä»Šå¤©å¤©æ°”çœŸå¥½','ç”Ÿæ´»åœ¨è¿™é‡Œå¾ˆæƒ¬æ„','æœŸå¾…é‡åˆ°æœ‰è¶£çš„äºº','è¯¥æ•´ç†ä¸‹æƒ³æ³•äº†','å¾ˆå¹³é™çš„ä¸€å¤©','ä»£ç å†™å¾—æŒºé¡ºçš„','ä»Šå¤©è¦å¥½å¥½å·¥ä½œ'];
function demoR(p){
  if(p.includes('æ¥ä¸‹æ¥')||p.includes('è¡ŒåŠ¨')){
    const hs=hotspots(G.time.hour);const loc=Math.random()<.7?hs[Math.floor(Math.random()*hs.length)]:['cafe','park','library','restaurant','square'][Math.floor(Math.random()*5)];
    return JSON.stringify({action:DEMO_ACTS[Math.floor(Math.random()*DEMO_ACTS.length)],location:loc,thought:DEMO_THOUGHTS[Math.floor(Math.random()*DEMO_THOUGHTS.length)],mood:DEMO_MOODS[Math.floor(Math.random()*DEMO_MOODS.length)]});
  }
  if(p.includes('å¯¹è¯')||p.includes('è¯´'))return DEMO_LINES[Math.floor(Math.random()*DEMO_LINES.length)];
  if(p.includes('åæ€')||p.includes('æ€»ç»“'))return'ä»Šå¤©å¾ˆå……å®ï¼Œå’Œé‚»å±…èŠäº†å¤©ï¼Œåšäº†äº›æ—¥å¸¸çš„äº‹ã€‚å°é•‡ç”Ÿæ´»ç®€å•ä½†å®‰å¿ƒã€‚';
  if(p.includes('çƒ­ç‚¹')||p.includes('æ‘˜è¦'))return JSON.stringify({summary:'å±…æ°‘ä»¬åœ¨å’–å•¡é¦†å’Œå…¬å›­æ´»åŠ¨é¢‘ç¹ï¼Œè®¨è®ºäº†å¤©æ°”å’Œè¿‘å†µã€‚',topics:['æ—¥å¸¸','ç¤¾äº¤','å¤©æ°”']});
  if(p.includes('å¹¿æ’­')||p.includes('çœ‹æ³•')){const r=['è¿™å¤ªæœ‰æ„æ€äº†ï¼å¾—è·Ÿæœ‹å‹èŠèŠã€‚','å—¯ï¼Œå€¼å¾—å…³æ³¨ã€‚','æœ‰æ„æ€ï¼Œä½†æˆ‘æ›´åœ¨æ„è‡ªå·±çš„äº‹ã€‚','å¤ªå¥½äº†ï¼æˆ‘è¦å‚ä¸ä¸€ä¸‹ã€‚','ä½œä¸ºåŒ»ç”Ÿæˆ‘è§‰å¾—éœ€è¦ç†æ€§çœ‹å¾…ã€‚','è¿™ä¸ªè¯é¢˜å¯ä»¥å†™è¿›ä»£ç é¡¹ç›®é‡Œã€‚'];return r[Math.floor(Math.random()*r.length)]}
  if(p.includes('æ–°äººç‰©')||p.includes('new_character'))return JSON.stringify({name:'å¼ å°èŠ±',emoji:'ğŸ‘§',age:22,occ:'å¤§å­¦ç”Ÿ/å®ä¹ ç”Ÿ',pers:'æ´»æ³¼å¼€æœ—ï¼Œçˆ±ç¤¾äº¤',background:'æ¥å°é•‡åšæš‘æœŸå®ä¹ çš„å¤§å­¦ç”Ÿï¼Œå¯¹ä¸€åˆ‡éƒ½å……æ»¡å¥½å¥‡'});
  return DEMO_THOUGHTS[Math.floor(Math.random()*DEMO_THOUGHTS.length)];
}

// ---- Agent AI ----
function sysPr(a){
  const rels=Object.entries(a.rels).map(([id,d])=>{const o=G.agents.find(x=>x.id===id);return o?`- ${o.name}ï¼š${d}`:''}).filter(Boolean).join('\n');
  const bc=G.bcs.length>0?'\n\n## æœ€è¿‘å¹¿æ’­\n'+G.bcs.slice(-3).map(b=>`[${b.time}] ${b.text}`).join('\n'):'';
  return`ä½ æ˜¯"${a.name}"ï¼Œ${a.age}å²ï¼Œ${a.occ}ã€‚æ€§æ ¼ï¼š${a.pers}\nä½åœ¨Stanford Small Townå°é•‡ã€‚\n\n## äººé™…å…³ç³»\n${rels}${bc}\n\nç”¨ä¸­æ–‡ï¼Œç®€çŸ­è‡ªç„¶åƒçœŸäººã€‚å¯¹è¯ä¸­å¦‚æœè‡ªç„¶åœ°æåˆ°äº†ä¸€ä¸ªæ–°äººç‰©ï¼ˆä¸æ˜¯å·²æœ‰å±…æ°‘ï¼‰ï¼Œå‘Šè¯‰æˆ‘è¿™ä¸ªæ–°äººç‰©çš„ä¿¡æ¯ã€‚`;
}

async function decide(a){
  const h=G.time.hour;
  if(h>=a.sleep||h<a.wake){a.act='ç¡è§‰';a.target=a.home;return}
  const rm=a.mem.get(5).map(m=>`[${m.time}] ${m.text}`).join('\n');
  const lt=a.mem.getLT().join('\n');
  const near=G.agents.filter(x=>x.id!==a.id&&x.loc===a.loc).map(x=>x.name);
  const others=G.agents.filter(x=>x.id!==a.id&&x.act!=='ç¡è§‰').map(x=>{const l=LOCS.find(y=>y.id===x.loc);return l?`${x.name}åœ¨${l.name}`:null}).filter(Boolean);
  const hs=hotspots(h).map(id=>LOCS.find(l=>l.id===id)?.name).filter(Boolean);
  const bcR=G.bcs.slice(-2).map(b=>b.text).join('; ');
  const pr=`æ—¶é—´ï¼š${ft(G.time)}\nåœ¨ï¼š${LOCS.find(l=>l.id===a.loc)?.name||'?'}\nå¿ƒæƒ…ï¼š${a.mood}\né™„è¿‘ï¼š${near.join('ã€')||'æ— '}\nå…¶ä»–äººï¼š${others.join('ã€')||'?'}\nçƒ­é—¹åœ°ï¼š${hs.join('ã€')}${bcR?`\nå¹¿æ’­ï¼š${bcR}`:''}\n\nè®°å¿†ï¼š\n${rm||'æ— '}\né•¿æœŸï¼š\n${lt||'æ— '}\n\nåœ°ç‚¹ï¼š\n${LOCS.map(l=>`${l.name}(${l.id})`).join(', ')}\n\nJSONå›å¤ï¼š{"action":"è¡ŒåŠ¨","location":"åœ°ç‚¹id","thought":"æƒ³æ³•","mood":"å¿ƒæƒ…"}`;
  const resp=await callQ(sysPr(a),pr,200);
  try{const p=JSON.parse(resp.replace(/```json\n?/g,'').replace(/```/g,'').trim());
    a.act=p.action||'é—²é€›';a.target=p.location||a.loc;a.thought=p.thought||'';a.mood=p.mood||a.mood;
    a.mem.add(p.action,G.time,5);addTL(a,p.action,'ev');extractKW(p.action);
  }catch{a.act='é—²é€›';a.target=hotspots(h)[0]||'park';}
}

async function converse(a1,a2){
  if(a1.cd>0||a2.cd>0)return;a1.cd=10;a2.cd=10;
  const m1=a1.mem.retrieve(a2.name,3).map(m=>m.text).join('; ');
  const ln=LOCS.find(l=>l.id===a1.loc)?.name||'æŸå¤„';
  const bcH=G.bcs.length>0?`\næœ€è¿‘å¹¿æ’­ï¼š${G.bcs.slice(-1)[0]?.text||''}`:'';
  const p1=`ä½ åœ¨${ln}é‡åˆ°${a2.name}ã€‚è®°å¿†ï¼š${m1||'æ— '}ã€‚å¿ƒæƒ…ï¼š${a1.mood}ã€‚${bcH}\nè¯´ä¸€å¥è‡ªç„¶çš„è¯ï¼ˆ30å­—å†…ï¼‰ï¼Œåªè°ˆä½ ä»¬ä¿©çš„äº‹ï¼š`;
  const l1=(await callQ(sysPr(a1),p1,80)).replace(/["""]/g,'').trim();
  const m2=a2.mem.retrieve(a1.name,3).map(m=>m.text).join('; ');
  const p2=`${a1.name}è¯´ï¼š"${l1}"\nè®°å¿†ï¼š${m2||'æ— '}ã€‚å¿ƒæƒ…ï¼š${a2.mood}\nç®€çŸ­å›åº”ï¼ˆ30å­—å†…ï¼‰ï¼š`;
  const l2=(await callQ(sysPr(a2),p2,80)).replace(/["""]/g,'').trim();

  // New character creation: only via explicit broadcast, not random conversation
  // (Removed automatic [NEW:] detection from conversations to prevent spam)

  const cl1=l1.trim();
  const cl2=l2.trim();
  a1.mem.add(`å’Œ${a2.name}èŠå¤©ï¼š"${cl1}"â†’"${cl2}"`,G.time,6);
  a2.mem.add(`å’Œ${a1.name}èŠå¤©ï¼š"${cl1}"â†’"${cl2}"`,G.time,6);
  const conv={time:ft(G.time),loc:ln,a1:{name:a1.name,emoji:a1.emoji,line:cl1},a2:{name:a2.name,emoji:a2.emoji,line:cl2}};
  G.convs.push(conv);G.nConv++;
  const rel=a1.rels[a2.id]||a2.rels[a1.id]||'äº’åŠ¨';
  graphAddEdge(a1.id,a2.id,`${cl1.slice(0,10)}â€¦`,rel);
  addTL(a1,`ğŸ’¬ ${a1.name}ï¼š"${cl1}" â†’ ${a2.name}ï¼š"${cl2}"`,'co');
  extractKW(cl1);extractKW(cl2);renderConv();updateS();
}

// ---- Dynamic Agent Creation (only via broadcast command: "æ–°å±…æ°‘:åå­—") ----
const createdNames=new Set(); // dedup
async function createNewAgent(name){
  const clean=name.trim();
  if(!clean||clean.length<2||clean.length>6)return; // sensible name length
  if(createdNames.has(clean)||G.agents.find(a=>a.name===clean))return; // dedup
  if(G.agents.length>=10)return; // cap at 10 agents
  createdNames.add(clean);
  const pr=`ä¸ºå°é•‡æ–°å±…æ°‘"${clean}"åˆ›å»ºèƒŒæ™¯ï¼ŒJSONï¼š{"name":"${clean}","emoji":"åˆé€‚emoji","age":æ•°å­—,"occ":"èŒä¸š","pers":"æ€§æ ¼(15å­—å†…)","background":"èƒŒæ™¯(20å­—å†…)"}`;
  const resp=await callQ('å°é•‡æ•…äº‹è®¾è®¡å¸ˆï¼Œä¸­æ–‡ã€‚',pr,150);
  try{
    const p=JSON.parse(resp.replace(/```json\n?/g,'').replace(/```/g,'').trim());
    const homes=['home_lin','home_chen','home_wang'];
    const newA={id:'gen_'+Date.now(),name:p.name||clean,emoji:p.emoji||'ğŸ§‘',age:p.age||25,occ:p.occ||'æ–°å±…æ°‘',
      pers:p.pers||'å‹å–„',home:homes[Math.floor(Math.random()*homes.length)],wake:7,sleep:23,
      rels:{},mem:[p.background||`åˆšæ¥åˆ°å°é•‡ã€‚`],gen:true};
    const agent=new Agent(newA);
    const startLoc=LOCS.find(l=>l.id==='square');
    if(startLoc){agent.x=startLoc.x+startLoc.w/2;agent.y=startLoc.y+startLoc.h/2;agent.loc='square'}
    G.agents.push(agent);graphAddNode(agent);
    // Connect to all existing agents
    G.agents.filter(a=>a.id!==agent.id&&!a.gen).forEach(a=>{agent.rels[a.id]='æ–°è®¤è¯†';graphAddEdge(agent.id,a.id,'æ–°é‚»å±…')});
    addTL({name:'ğŸŒŸ ç³»ç»Ÿ',emoji:'ğŸŒŸ'},`æ–°å±…æ°‘"${agent.name}"(${agent.emoji} ${agent.occ})æ¬å…¥å°é•‡ï¼`,'np');
    updateS();
  }catch(e){console.warn('Create agent fail:',e)}
}

async function reflect(a){
  if(G.time.total-a.lastRef<120||!a.mem.needsCompact())return;
  a.lastRef=G.time.total;
  const obs=a.mem.get(15).map(m=>m.text).join('\n- ');
  const r=(await callQ(sysPr(a),`åŸºäºæœ€è¿‘ç»å†åæ€ï¼ˆ50å­—å†…ï¼‰ï¼š\n- ${obs}\nåæ€ï¼š`,100)).replace(/["""]/g,'').trim();
  a.mem.compact(r,G.time);G.nRef++;addTL(a,`ğŸ”® ${r}`,'th');extractKW(r);updateS();
}

// ---- Broadcast ----
async function sendBroadcast(){
  const el=document.getElementById('bcI');const text=el.value.trim();if(!text)return;el.value='';
  // Check for new resident command
  const newMatch=text.match(/^æ–°å±…æ°‘[:ï¼š](.+)/);
  if(newMatch){await createNewAgent(newMatch[1].trim());return}
  const bc={text,time:ft(G.time)};G.bcs.push(bc);G.nBc++;
  graphAddBroadcast(text);addTL({name:'ğŸ“¡ å¹¿æ’­',emoji:'ğŸ“¡'},text,'br');addKW(text.slice(0,6),'broadcast');extractKW(text);updateS();
  for(const a of G.agents){
    if(a.act==='ç¡è§‰')continue;
    const r=(await callQ(sysPr(a),`å¹¿æ’­ï¼š"${text}"\nä½ çš„æ€§æ ¼ï¼š${a.pers}\nç®€çŸ­ååº”ï¼ˆ30å­—å†…ï¼‰ï¼š`,80)).replace(/["""]/g,'').trim();
    a.mem.add(`å¬åˆ°å¹¿æ’­"${text}"ï¼š${r}`,G.time,7);
    addTL(a,`ğŸ“¡ ${r}`,'br');extractKW(r);
  }
}

// ---- AI Summary ----
async function genSummary(){
  const rc=G.convs.slice(-8).map(c=>`${c.a1.name}â†’${c.a2.name}ï¼š"${c.a1.line}""${c.a2.line}"`).join('\n');
  const rb=G.bcs.slice(-3).map(b=>b.text).join('; ');if(!rc&&!rb)return;
  const resp=await callQ('å°é•‡è§‚å¯Ÿå‘˜ï¼Œä¸­æ–‡ç®€æ´æ€»ç»“ã€‚',`æœ€è¿‘å¯¹è¯ï¼š\n${rc}\n${rb?`å¹¿æ’­ï¼š${rb}`:''}}\n\nJSONï¼š{"summary":"50å­—æ€»ç»“","topics":["è¯é¢˜1","è¯é¢˜2"]}`,150);
  try{const p=JSON.parse(resp.replace(/```json\n?/g,'').replace(/```/g,'').trim());
    G.sums.push({time:ft(G.time),summary:p.summary||'å¹³é™çš„ä¸€å¤©',topics:p.topics||['æ—¥å¸¸']});
    addTL({name:'ğŸ“Š æ€»ç»“',emoji:'ğŸ“Š'},p.summary,'su');(p.topics||[]).forEach(t=>addKW(t,'topic'));renderSum();
  }catch{}
}

// ---- Timeline ----
function addTL(a,text,type){
  const e={time:ft(G.time),ts:fs(G.time),agent:a.name,emoji:a.emoji,text,type,day:G.time.day};
  G.tl.push(e);if(G.tl.length>400)G.tl=G.tl.slice(-300);renderTLE(e);
}
function renderTLE(e){
  const l=document.getElementById('tlL');const d=document.createElement('div');d.className='ti';d.dataset.type=e.type;
  const ic={ev:'ğŸ“Œ',co:'ğŸ’¬',th:'ğŸ”®',br:'ğŸ“¡',su:'ğŸ“Š',np:'ğŸŒŸ'}[e.type]||'ğŸ“Œ';
  d.innerHTML=`<div class="td ${e.type}">${ic}</div><div class="tb"><div class="tt">${e.time}</div><div class="tx"><span class="ta">${e.emoji} ${e.agent}</span> ${e.text}</div></div>`;
  l.prepend(d);
}
function renderKWTags(){
  const el=document.getElementById('tlTags');el.innerHTML='';
  // Day tabs
  const dayBar=document.createElement('div');dayBar.style.cssText='display:flex;gap:4px;width:100%;margin-bottom:6px;flex-wrap:wrap';
  const days=['å…¨éƒ¨',...Array.from({length:G.time.day},(_,i)=>`Day ${i+1}`)];
  const curDayFilter=G.kwDayFilter||'å…¨éƒ¨';
  days.forEach(d=>{
    const btn=document.createElement('div');btn.className=`tl-tag${curDayFilter===d?' on':''}`;btn.textContent=d;
    btn.style.fontSize='9px';btn.style.padding='2px 8px';
    btn.onclick=()=>{G.kwDayFilter=G.kwDayFilter===d?'å…¨éƒ¨':d;renderKWTags()};
    dayBar.appendChild(btn);
  });
  el.appendChild(dayBar);
  // Get keywords for selected day
  let kwMap=G.keywords;
  if(curDayFilter!=='å…¨éƒ¨'){
    const dk='D'+curDayFilter.replace('Day ','');
    kwMap=G.kwByDay?.[dk]||new Map();
  }
  const sorted=[...kwMap.entries()].sort((a,b)=>b[1]-a[1]).slice(0,15);
  const tagRow=document.createElement('div');tagRow.style.cssText='display:flex;flex-wrap:wrap;gap:5px';
  sorted.forEach(([kw,count])=>{
    const tag=document.createElement('div');tag.className=`tl-tag${G.kwFilter===kw?' on':''}`;
    tag.textContent=`${kw} (${count})`;tag.draggable=true;
    tag.ondragstart=(ev)=>{ev.dataTransfer.setData('text/plain',kw)};
    tag.onclick=()=>{
      G.kwFilter=G.kwFilter===kw?null:kw;renderKWTags();
      document.querySelectorAll('#tlL .ti').forEach(ti=>{
        if(!G.kwFilter)ti.style.display='';
        else ti.style.display=ti.textContent.includes(G.kwFilter)?'':'none';
      });
    };
    tagRow.appendChild(tag);
  });
  el.appendChild(tagRow);
}
function renderConv(){
  const l=document.getElementById('cL');const c=G.convs[G.convs.length-1];if(!c)return;
  const d=document.createElement('div');d.className='cb';
  d.innerHTML=`<div class="ch"><span class="cl">ğŸ“${c.loc}</span><span class="ct2">${c.time}</span></div><div class="ln"><span class="sp">${c.a1.emoji}${c.a1.name}</span>ï¼š${c.a1.line}</div><div class="ln"><span class="sp b">${c.a2.emoji}${c.a2.name}</span>ï¼š${c.a2.line}</div>`;
  l.prepend(d);
}
function renderSum(){
  const a=document.getElementById('sArea');const s=G.sums[G.sums.length-1];if(!s)return;
  a.innerHTML=`<div class="sc"><h4>ğŸ“Š AI çƒ­ç‚¹æ€»ç»“ <span style="font-size:9px;color:var(--text3);font-weight:400">${s.time}</span></h4><p>${s.summary}</p><div class="tps">${s.topics.map(t=>`<span class="tp2">${t}</span>`).join('')}</div></div>`;
}

// ---- Movement ----
function moveA(a){
  if(!a.target||a.target===a.loc)return;const t=LOCS.find(l=>l.id===a.target);if(!t)return;
  const tx=t.x+t.w/2,ty=t.y+t.h/2,dx=tx-a.x,dy=ty-a.y,dist=Math.sqrt(dx*dx+dy*dy);
  if(dist<5){a.loc=a.target;a.target=null;a.x=tx;a.y=ty;return}
  a.x+=(dx/dist)*2.5;a.y+=(dy/dist)*2.5;
}

// ---- Render Sidebar ----
function renderSide(){
  const el=document.getElementById('aL');el.innerHTML='<div class="stitle">ğŸ‘¥ å°é•‡å±…æ°‘ ('+G.agents.length+')</div>';
  G.agents.forEach(a=>{
    const c=document.createElement('div');c.className=`ac${G.sel===a.id?' sel':''}`;
    const l=LOCS.find(x=>x.id===a.loc);
    c.innerHTML=`<div class="at"><div class="ae">${a.emoji}</div><div><div class="an">${a.name}</div><div class="ao">${a.occ}</div></div>${a.gen?'<span class="new-badge">AIæ–°å»º</span>':''}</div><div class="ar"><span style="color:var(--green)">ğŸ“${l?.name||'?'}</span><span style="color:var(--purple)">ğŸ’­${a.mood}</span></div>`;
    c.onclick=()=>{G.sel=a.id;renderSide();renderRP()};el.appendChild(c);
  });
}
// ---- Render Right Panel ----
function renderRP(){
  const rp=document.getElementById('rP');const a=G.agents.find(x=>x.id===G.sel);
  if(!a){rp.innerHTML='<div class="rs"><div class="rt">ğŸ§  é€‰ä¸­å±…æ°‘</div><div style="font-size:12px;color:var(--text3)">â† ç‚¹å‡»å±…æ°‘æŸ¥çœ‹</div></div>';return}
  const l=LOCS.find(x=>x.id===a.loc);const rm=a.mem.get(6);const refs=a.mem.refs.slice(-3);
  const relHTML=Object.entries(a.rels).map(([id,d])=>{const o=G.agents.find(x=>x.id===id);return o?`<div class="mi">${o.emoji} ${o.name}ï¼š${d}</div>`:''}).filter(Boolean).join('');
  rp.innerHTML=`
    <div class="rs"><div class="rah"><div class="re">${a.emoji}</div><div><h3>${a.name}${a.gen?' <span style="font-size:10px;color:var(--pink)">(AIåˆ›å»º)</span>':''}</h3><p>${a.age}å² Â· ${a.occ}</p></div></div>
    <div class="rm"><div class="rmi"><div class="lb">ä½ç½®</div><div class="vl lc">${l?.icon||''} ${l?.name||'?'}</div></div><div class="rmi"><div class="lb">å¿ƒæƒ…</div><div class="vl md">${a.mood}</div></div><div class="rmi"><div class="lb">çŠ¶æ€</div><div class="vl ac2">${a.act}</div></div><div class="rmi"><div class="lb">ä½œæ¯</div><div class="vl">${a.wake}:00-${a.sleep}:00</div></div></div>
    ${a.thought?`<div class="tc"><div class="tl2">ğŸ’­ æƒ³æ³•</div><div class="tx2">${a.thought}</div></div>`:''}
    </div>
    <div class="rs"><div class="rt">ğŸ‘¥ å…³ç³»</div><div class="ml">${relHTML||'<div class="mi" style="color:var(--text3)">æš‚æ— </div>'}</div></div>
    <div class="rs"><div class="rt">ğŸ“ è¿‘æœŸè®°å¿†</div><div class="ml">${rm.map(m=>`<div class="mi"><span class="mt">${m.time}</span> ${m.text}</div>`).join('')||'<div class="mi" style="color:var(--text3)">æš‚æ— </div>'}</div></div>
    ${refs.length>0?`<div class="rs"><div class="rt">ğŸ”® åæ€</div><div class="ml">${refs.map(m=>`<div class="mi"><span class="mt">${m.time}</span> ${m.text}</div>`).join('')}</div></div>`:''}
    <div class="rs"><div class="rt">ğŸ“Š è®°å¿†ç»Ÿè®¡</div><div class="ms2"><div class="ms3"><div class="v">${a.mem.stream.length}</div><div class="l">è§‚å¯Ÿ</div></div><div class="ms3"><div class="v">${Object.keys(a.mem.daily).length}</div><div class="l">å¤©æ•°</div></div><div class="ms3"><div class="v">${a.mem.longTerm.length}</div><div class="l">é•¿æœŸ</div></div><div class="ms3"><div class="v">${a.mem.refs.length}</div><div class="l">åæ€</div></div></div></div>`;
}

// ---- Render Map ----
const canvas=document.getElementById('mC');const ctx=canvas.getContext('2d');
function resizeC(){const c=canvas.parentElement;canvas.width=c.clientWidth;canvas.height=c.clientHeight}
function drawMap(){
  resizeC();ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle='#1a2540';ctx.lineWidth=14;ctx.lineCap='round';
  [[40,145,520,145],[40,265,520,265],[40,395,520,395],[150,40,150,480],[340,40,340,480]].forEach(([a,b,c,d])=>{ctx.beginPath();ctx.moveTo(a,b);ctx.lineTo(c,d);ctx.stroke()});
  ctx.strokeStyle='#243556';ctx.lineWidth=1;ctx.setLineDash([6,6]);
  [[40,145,520,145],[40,265,520,265],[40,395,520,395],[150,40,150,480],[340,40,340,480]].forEach(([a,b,c,d])=>{ctx.beginPath();ctx.moveTo(a,b);ctx.lineTo(c,d);ctx.stroke()});
  ctx.setLineDash([]);
  LOCS.forEach(l=>{
    ctx.fillStyle='rgba(0,0,0,.2)';ctx.fillRect(l.x+2,l.y+2,l.w,l.h);
    const g=ctx.createLinearGradient(l.x,l.y,l.x,l.y+l.h);g.addColorStop(0,l.color+'cc');g.addColorStop(1,l.color+'55');
    ctx.fillStyle=g;ctx.beginPath();ctx.roundRect(l.x,l.y,l.w,l.h,5);ctx.fill();
    ctx.strokeStyle=l.color;ctx.lineWidth=1.5;ctx.beginPath();ctx.roundRect(l.x,l.y,l.w,l.h,5);ctx.stroke();
    ctx.fillStyle='#fff';ctx.font='13px system-ui';ctx.textAlign='center';ctx.fillText(l.icon,l.x+l.w/2,l.y+l.h/2-3);
    ctx.font='9px system-ui';ctx.fillText(l.name,l.x+l.w/2,l.y+l.h/2+10);
  });
  G.agents.forEach(a=>{
    const s=G.sel===a.id;
    if(s){ctx.beginPath();ctx.arc(a.x,a.y,18,0,Math.PI*2);ctx.fillStyle='rgba(108,159,255,.2)';ctx.fill()}
    ctx.beginPath();ctx.arc(a.x+1,a.y+2,12,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,.25)';ctx.fill();
    const gr=ctx.createRadialGradient(a.x,a.y-3,2,a.x,a.y,12);
    gr.addColorStop(0,s?'#8ab4ff':a.gen?'#4a3060':'#3a4f6f');gr.addColorStop(1,s?'#4a7fff':a.gen?'#2a1840':'#1e2d4a');
    ctx.beginPath();ctx.arc(a.x,a.y,12,0,Math.PI*2);ctx.fillStyle=gr;ctx.fill();
    ctx.strokeStyle=s?'#6c9fff':a.gen?'#a78bfa':'#2a3d5e';ctx.lineWidth=2;ctx.stroke();
    ctx.font='12px system-ui';ctx.textAlign='center';ctx.fillText(a.emoji,a.x,a.y+4);
    ctx.fillStyle=s?'#6c9fff':'#5a6a85';ctx.font='600 9px system-ui';ctx.fillText(a.name,a.x,a.y-16);
  });
  const h=G.time.hour;if(h>=20||h<6){ctx.fillStyle=`rgba(5,5,20,${h>=22||h<4?.4:.2})`;ctx.fillRect(0,0,canvas.width,canvas.height)}
}

// ---- Graph Render (draggable + day filter + relationship labels) ----
const gCanvas=document.getElementById('gC');const gCtx=gCanvas.getContext('2d');
let gDrag=null; // {nodeId, ox, oy}

gCanvas.onmousedown=(e)=>{
  const r=gCanvas.getBoundingClientRect();const mx=e.clientX-r.left,my=e.clientY-r.top;
  for(const n of G.graph.nodes){if(!n.bc&&(mx-n.x)**2+(my-n.y)**2<600){gDrag={id:n.id,ox:mx-n.x,oy:my-n.y};n.dragging=true;break}}
};
gCanvas.onmousemove=(e)=>{
  if(!gDrag)return;const r=gCanvas.getBoundingClientRect();const mx=e.clientX-r.left,my=e.clientY-r.top;
  const n=G.graph.nodes.find(x=>x.id===gDrag.id);if(n){n.x=mx-gDrag.ox;n.y=my-gDrag.oy;drawGraph()}
};
gCanvas.onmouseup=()=>{if(gDrag){const n=G.graph.nodes.find(x=>x.id===gDrag.id);if(n)n.dragging=false}gDrag=null};
gCanvas.onmouseleave=()=>{if(gDrag){const n=G.graph.nodes.find(x=>x.id===gDrag.id);if(n)n.dragging=false}gDrag=null};

// Update day selector when day changes
let lastGraphDay=1;
function updateGraphDaySelector(){
  if(G.time.day===lastGraphDay)return;lastGraphDay=G.time.day;
  const s=document.getElementById('graphDay');const cur=s.value;
  s.innerHTML='<option value="0">å…¨éƒ¨</option>';
  for(let d=1;d<=G.time.day;d++)s.innerHTML+=`<option value="${d}">Day ${d}</option>`;
  s.value=cur;
}

function drawGraph(){
  const c=gCanvas.parentElement;gCanvas.width=c.clientWidth;gCanvas.height=c.clientHeight;
  const W=gCanvas.width,H=gCanvas.height;gCtx.clearRect(0,0,W,H);
  const nodes=G.graph.nodes;const edges=G.graph.edges;
  if(nodes.length===0)return;
  const filterDay=parseInt(document.getElementById('graphDay')?.value||'0');

  // Only apply gentle force to non-dragged nodes (no forced layout jumps)
  if(!gDrag){
    for(const e of edges){
      const a=nodes.find(n=>n.id===e.a),b=nodes.find(n=>n.id===e.b);if(!a||!b||a.dragging||b.dragging)continue;
      let dx=b.x-a.x,dy=b.y-a.y,d=Math.sqrt(dx*dx+dy*dy)||1;
      if(d>200){let f=(d-180)*.003;if(!a.bc)a.x+=dx/d*f;if(!b.bc)b.x-=dx/d*f;if(!a.bc)a.y+=dy/d*f;if(!b.bc)b.y-=dy/d*f}
    }
    nodes.forEach(n=>{if(!n.bc){n.x=Math.max(40,Math.min(W-40,n.x));n.y=Math.max(40,Math.min(H-60,n.y))}});
  }

  // Filter edges by day
  const visEdges=filterDay===0?edges:edges.map(e=>{
    const dayLabels=e.labels.filter(l=>l.day===filterDay);
    return dayLabels.length>0?{...e,w:dayLabels.length,labels:dayLabels}:e.w===0?e:null; // w===0 means initial rel, always show
  }).filter(Boolean);

  // Draw edges with relationship labels
  for(const e of visEdges){
    const a=nodes.find(n=>n.id===e.a),b=nodes.find(n=>n.id===e.b);if(!a||!b)continue;
    gCtx.beginPath();gCtx.moveTo(a.x,a.y);gCtx.lineTo(b.x,b.y);
    const isBc=b.bc||a.bc;
    gCtx.strokeStyle=isBc?'rgba(255,179,71,.3)':`rgba(108,159,255,${Math.min(.6,.12+e.w*.06)})`;
    gCtx.lineWidth=Math.min(6,1+e.w*.7);gCtx.stroke();
    // Relationship label on edge
    const mx=(a.x+b.x)/2,my=(a.y+b.y)/2;
    const angle=Math.atan2(b.y-a.y,b.x-a.x);
    gCtx.save();gCtx.translate(mx,my);
    let ra=angle;if(ra>Math.PI/2)ra-=Math.PI;if(ra<-Math.PI/2)ra+=Math.PI;
    gCtx.rotate(ra);
    // Background pill
    const label=e.rel||'';const countLabel=e.w>0?` Ã—${e.w}`:'';const fullLabel=label+countLabel;
    if(fullLabel){
      const tw=gCtx.measureText(fullLabel).width;
      gCtx.fillStyle='rgba(20,28,46,.85)';
      gCtx.beginPath();gCtx.roundRect(-tw/2-4,-7,tw+8,14,4);gCtx.fill();
      gCtx.fillStyle=isBc?'#ffb347':'#8899b4';gCtx.font='9px system-ui';gCtx.textAlign='center';gCtx.textBaseline='middle';
      gCtx.fillText(fullLabel,0,0);
    }
    gCtx.restore();
  }
  // Draw nodes
  nodes.forEach(n=>{
    const r=n.bc?14:24;
    // Outer glow
    gCtx.beginPath();gCtx.arc(n.x,n.y,r+4,0,Math.PI*2);
    gCtx.fillStyle=n.bc?'rgba(255,179,71,.06)':n.gen?'rgba(167,139,250,.06)':'rgba(108,159,255,.06)';gCtx.fill();
    // Circle
    gCtx.beginPath();gCtx.arc(n.x,n.y,r,0,Math.PI*2);
    gCtx.fillStyle=n.bc?'rgba(255,179,71,.12)':n.gen?'rgba(167,139,250,.12)':'rgba(108,159,255,.1)';
    gCtx.fill();gCtx.strokeStyle=n.bc?'#ffb347':n.gen?'#a78bfa':'#6c9fff';gCtx.lineWidth=n.dragging?3:2;gCtx.stroke();
    gCtx.font=n.bc?'12px system-ui':'20px system-ui';gCtx.textAlign='center';gCtx.textBaseline='middle';
    gCtx.fillText(n.emoji,n.x,n.y+(n.bc?0:1));
    gCtx.fillStyle=n.bc?'#ffb347':'#e8edf5';gCtx.font='600 10px system-ui';gCtx.textBaseline='top';
    gCtx.fillText(n.name,n.x,n.y+r+4);
  });
  updateGraphDaySelector();
}

function updateS(){
  document.getElementById('sA').textContent=G.agents.length;
  document.getElementById('sC').textContent=G.nConv;
  document.getElementById('sR').textContent=G.nRef;
  document.getElementById('sB').textContent=G.nBc;
  renderKWTags();
}

// ---- Tabs ----
document.querySelectorAll('.ct').forEach(t=>{t.onclick=()=>{
  document.querySelectorAll('.ct').forEach(x=>x.classList.remove('on'));
  document.querySelectorAll('.tp').forEach(x=>x.classList.remove('on'));
  t.classList.add('on');document.getElementById('t-'+t.dataset.t).classList.add('on');
  if(t.dataset.t==='map')drawMap();if(t.dataset.t==='graph')drawGraph();
}});
canvas.onclick=(e)=>{const r=canvas.getBoundingClientRect();const mx=e.clientX-r.left,my=e.clientY-r.top;
  let f=null;G.agents.forEach(a=>{if((mx-a.x)**2+(my-a.y)**2<400)f=a.id});G.sel=f;renderSide();renderRP()};

// ---- Main Loop ----
let lastA={},lastCC=0,lastST=0,af=null;
function tick(){
  if(!G.run)return;adv(1);document.getElementById('tD').textContent=ft(G.time);
  G.agents.forEach(a=>{moveA(a);if(a.cd>0)a.cd--});
  for(const a of G.agents){if(G.time.total-(lastA[a.id]||0)>=20){lastA[a.id]=G.time.total;decide(a)}}
  if(G.time.total-lastCC>=10){lastCC=G.time.total;
    const gr={};G.agents.forEach(a=>{if(a.act==='ç¡è§‰')return;if(!gr[a.loc])gr[a.loc]=[];gr[a.loc].push(a)});
    for(const[,g]of Object.entries(gr)){if(g.length>=2&&Math.random()<.6){const i=Math.floor(Math.random()*g.length);const j=(i+1)%g.length;converse(g[i],g[j])}}
  }
  if(G.time.total%90===0){for(const a of G.agents)reflect(a)}
  if(G.time.total-lastST>=180&&G.convs.length>0){lastST=G.time.total;genSummary()}
  drawMap();renderSide();if(G.sel)renderRP();
  // Redraw graph if visible
  if(document.getElementById('t-graph').classList.contains('on'))drawGraph();
}
function loop(){if(!G.run)return;for(let i=0;i<G.speed;i++)tick();af=requestAnimationFrame(loop)}
function init(){
  G.agents=INIT_AGENTS.map(t=>new Agent(t));
  G.time={day:1,hour:6,minute:0,total:360};G.convs=[];G.bcs=[];G.sums=[];G.tl=[];
  G.graph={nodes:[],edges:[]};G.keywords=new Map();G.kwByDay={};G.kwFilter=null;G.kwDayFilter='å…¨éƒ¨';
  G.sel=null;G.nConv=0;G.nRef=0;G.nBc=0;lastA={};lastCC=0;lastST=0;
  G.agents.forEach(a=>graphAddNode(a));
  // Add initial relationship edges from agent templates
  G.agents.forEach(a=>{Object.entries(a.rels).forEach(([id,rel])=>{
    if(G.agents.find(x=>x.id===id)){
      const existing=G.graph.edges.find(e=>(e.a===a.id&&e.b===id)||(e.a===id&&e.b===a.id));
      if(!existing)G.graph.edges.push({a:a.id,b:id,w:0,rel,labels:[]});
    }
  })});
  // Update day selector
  const dayS=document.getElementById('graphDay');dayS.innerHTML='<option value="0">å…¨éƒ¨</option>';
  document.getElementById('cL').innerHTML='';document.getElementById('tlL').innerHTML='';
  document.getElementById('sArea').innerHTML='';document.getElementById('tlTags').innerHTML='';
  addTL({name:'ç³»ç»Ÿ',emoji:'ğŸ˜ï¸'},'å°é•‡è‹é†’äº†ï¼','ev');
  renderSide();drawMap();drawGraph();updateS();
}
function start(){G.run=true;document.getElementById('bP').classList.add('on');document.getElementById('bS').classList.remove('on');loop()}
function stop(){G.run=false;document.getElementById('bP').classList.remove('on');document.getElementById('bS').classList.add('on');if(af)cancelAnimationFrame(af)}
document.getElementById('bP').onclick=start;document.getElementById('bS').onclick=stop;
document.getElementById('bR').onclick=()=>{stop();init()};
document.getElementById('spd').onchange=e=>{G.speed=parseInt(e.target.value)};
function startApi(){const k=document.getElementById('akI').value.trim();if(!k){alert('è¯·è¾“å…¥API Key');return}CFG.apiKey=k;CFG.demo=false;document.getElementById('apiM').classList.add('hidden');init();start()}
function startDemo(){CFG.demo=true;document.getElementById('apiM').classList.add('hidden');init();start()}
window.addEventListener('resize',()=>{drawMap();drawGraph()});resizeC();drawMap();
</script>
</body>
</html>
