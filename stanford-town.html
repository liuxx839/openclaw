<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stanford Small Town - AI å°é•‡æ¨¡æ‹Ÿ</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0a0e1a; --bg2: #0f1525; --panel: #141c2e; --panel2: #1a2540;
  --card: #1e2d4a; --card-hover: #243556;
  --accent: #6c9fff; --accent2: #4a7fff; --accent-glow: rgba(108,159,255,.15);
  --warm: #ffb347; --warm2: #ffd699;
  --green: #5cd65c; --green2: #2ecc71;
  --red: #ff6b6b; --pink: #ff8fab;
  --purple: #a78bfa; --purple2: #c4b5fd;
  --cyan: #67e8f9; --teal: #5eead4;
  --text: #e8edf5; --text2: #8899b4; --text3: #5a6a85;
  --border: #1e2d4a; --border2: #2a3d5e;
  --shadow: rgba(0,0,0,.4);
  --radius: 12px; --radius-sm: 8px;
}
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

/* ---- App Layout ---- */
.app { display: grid; grid-template-columns: 260px 1fr 380px; grid-template-rows: 60px 1fr; height: 100vh; gap: 1px; background: var(--border); }

/* ---- Header ---- */
.header { grid-column: 1/-1; background: var(--bg2); display: flex; align-items: center; padding: 0 24px; gap: 20px; }
.header .logo { display: flex; align-items: center; gap: 10px; }
.header .logo h1 { font-size: 17px; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.header .stats { display: flex; gap: 16px; margin-left: 24px; }
.header .stat { font-size: 12px; color: var(--text2); display: flex; align-items: center; gap: 4px; }
.header .stat b { color: var(--text); font-variant-numeric: tabular-nums; }
.header .time-display { margin-left: auto; font-size: 15px; color: var(--warm); font-weight: 600; font-variant-numeric: tabular-nums; letter-spacing: .5px; }
.header .controls { display: flex; gap: 6px; margin-left: 16px; }
.hbtn { background: var(--panel2); border: 1px solid var(--border2); color: var(--text2); padding: 7px 14px; border-radius: var(--radius-sm); cursor: pointer; font-size: 12px; font-weight: 500; transition: all .2s; }
.hbtn:hover { background: var(--card); color: var(--text); border-color: var(--accent); }
.hbtn.active { background: var(--accent2); color: #fff; border-color: var(--accent); }
.speed-sel { background: var(--panel2); border: 1px solid var(--border2); color: var(--text); padding: 6px 10px; border-radius: var(--radius-sm); font-size: 12px; cursor: pointer; }

/* ---- Left Sidebar ---- */
.sidebar { background: var(--bg2); overflow-y: auto; display: flex; flex-direction: column; }
.sidebar-section { padding: 14px; }
.sidebar-title { font-size: 11px; text-transform: uppercase; color: var(--text3); letter-spacing: 1.5px; font-weight: 700; margin-bottom: 10px; }
.agent-card { background: var(--panel); border: 1px solid transparent; border-radius: var(--radius-sm); padding: 10px 12px; margin-bottom: 6px; cursor: pointer; transition: all .2s; }
.agent-card:hover { background: var(--panel2); border-color: var(--border2); }
.agent-card.sel { background: var(--card); border-color: var(--accent); box-shadow: 0 0 12px var(--accent-glow); }
.agent-card .ac-top { display: flex; align-items: center; gap: 8px; }
.agent-card .ac-emoji { font-size: 22px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--panel2); border-radius: 50%; }
.agent-card .ac-name { font-size: 13px; font-weight: 600; }
.agent-card .ac-occ { font-size: 11px; color: var(--text3); }
.agent-card .ac-row { display: flex; gap: 12px; margin-top: 6px; font-size: 11px; color: var(--text2); }
.agent-card .ac-loc { color: var(--green); }
.agent-card .ac-mood { color: var(--purple2); }

/* Broadcast input */
.broadcast-section { padding: 14px; border-top: 1px solid var(--border); margin-top: auto; }
.broadcast-section textarea { width: 100%; height: 60px; background: var(--panel); border: 1px solid var(--border2); border-radius: var(--radius-sm); color: var(--text); padding: 8px 10px; font-size: 12px; resize: none; font-family: inherit; outline: none; }
.broadcast-section textarea:focus { border-color: var(--warm); }
.broadcast-section textarea::placeholder { color: var(--text3); }
.broadcast-btn { width: 100%; margin-top: 6px; background: linear-gradient(135deg, var(--warm), #ff8a50); border: none; color: #fff; padding: 8px; border-radius: var(--radius-sm); cursor: pointer; font-size: 12px; font-weight: 600; transition: opacity .2s; }
.broadcast-btn:hover { opacity: .85; }

/* ---- Center: Map + Tabs ---- */
.center { background: var(--bg); display: flex; flex-direction: column; overflow: hidden; }
.center-tabs { display: flex; background: var(--bg2); border-bottom: 1px solid var(--border); flex-shrink: 0; }
.ctab { padding: 10px 20px; font-size: 12px; font-weight: 600; color: var(--text3); cursor: pointer; border-bottom: 2px solid transparent; transition: all .2s; }
.ctab:hover { color: var(--text2); }
.ctab.active { color: var(--accent); border-bottom-color: var(--accent); }
.center-content { flex: 1; overflow: hidden; position: relative; }
.tab-panel { display: none; width: 100%; height: 100%; overflow: auto; }
.tab-panel.active { display: block; }

/* Map */
#mapCanvas { width: 100%; height: 100%; }

/* Conversations panel */
.conv-list { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
.conv-bubble { background: var(--panel); border-radius: var(--radius); padding: 12px 14px; border-left: 3px solid var(--accent); }
.conv-bubble .cb-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
.conv-bubble .cb-time { font-size: 10px; color: var(--text3); margin-left: auto; }
.conv-bubble .cb-loc { font-size: 10px; color: var(--green); background: rgba(94,234,212,.1); padding: 2px 6px; border-radius: 4px; }
.conv-bubble .cb-line { font-size: 13px; line-height: 1.6; padding: 4px 0; }
.conv-bubble .cb-line .speaker { font-weight: 600; color: var(--accent); }
.conv-bubble .cb-line .speaker.b { color: var(--purple); }

/* Timeline */
.timeline { padding: 16px; }
.tl-item { display: flex; gap: 12px; padding: 8px 0; position: relative; }
.tl-item::before { content: ''; position: absolute; left: 15px; top: 28px; bottom: -8px; width: 2px; background: var(--border2); }
.tl-item:last-child::before { display: none; }
.tl-dot { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; z-index: 1; }
.tl-dot.event { background: var(--card); border: 2px solid var(--green); }
.tl-dot.conv { background: var(--card); border: 2px solid var(--accent); }
.tl-dot.thought { background: var(--card); border: 2px solid var(--purple); }
.tl-dot.broadcast { background: var(--card); border: 2px solid var(--warm); }
.tl-dot.summary { background: var(--card); border: 2px solid var(--cyan); }
.tl-body { flex: 1; min-width: 0; }
.tl-body .tl-time { font-size: 10px; color: var(--text3); }
.tl-body .tl-text { font-size: 12px; color: var(--text2); margin-top: 2px; line-height: 1.5; }
.tl-body .tl-agent { font-weight: 600; color: var(--text); }

/* AI Summary card */
.summary-card { background: linear-gradient(135deg, var(--panel), var(--card)); border: 1px solid var(--border2); border-radius: var(--radius); padding: 14px; margin: 12px 16px; }
.summary-card h4 { font-size: 13px; color: var(--cyan); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
.summary-card p { font-size: 12px; color: var(--text2); line-height: 1.7; }
.summary-card .topics { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
.summary-card .topic-tag { background: rgba(103,232,249,.1); color: var(--cyan); font-size: 11px; padding: 3px 10px; border-radius: 20px; border: 1px solid rgba(103,232,249,.2); }

/* ---- Right Panel ---- */
.right-panel { background: var(--bg2); overflow-y: auto; display: flex; flex-direction: column; gap: 1px; }
.rp-section { background: var(--bg2); padding: 14px; }
.rp-title { font-size: 11px; text-transform: uppercase; color: var(--text3); letter-spacing: 1.5px; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
.rp-agent-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.rp-agent-header .rp-emoji { font-size: 32px; width: 52px; height: 52px; display: flex; align-items: center; justify-content: center; background: var(--panel); border-radius: 50%; border: 2px solid var(--border2); }
.rp-agent-header .rp-info h3 { font-size: 16px; font-weight: 700; }
.rp-agent-header .rp-info p { font-size: 12px; color: var(--text2); }
.rp-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
.rp-meta-item { background: var(--panel); border-radius: var(--radius-sm); padding: 8px 10px; }
.rp-meta-item .label { font-size: 10px; color: var(--text3); text-transform: uppercase; }
.rp-meta-item .value { font-size: 13px; font-weight: 600; margin-top: 2px; }
.rp-meta-item .value.loc { color: var(--green); }
.rp-meta-item .value.mood { color: var(--purple2); }
.rp-meta-item .value.act { color: var(--accent); }

.thought-card { background: var(--panel); border-radius: var(--radius-sm); padding: 10px 12px; border-left: 3px solid var(--purple); margin-bottom: 10px; }
.thought-card .tc-label { font-size: 10px; color: var(--purple); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
.thought-card .tc-text { font-size: 12px; color: var(--text2); margin-top: 4px; line-height: 1.5; }

.mem-list { display: flex; flex-direction: column; gap: 4px; }
.mem-item { background: var(--panel); border-radius: 6px; padding: 6px 10px; font-size: 11px; color: var(--text2); line-height: 1.5; }
.mem-item .mt { color: var(--warm); font-size: 10px; font-variant-numeric: tabular-nums; }
.mem-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
.mem-stat { background: var(--panel); border-radius: 6px; padding: 6px 8px; text-align: center; }
.mem-stat .ms-val { font-size: 16px; font-weight: 700; color: var(--accent); }
.mem-stat .ms-label { font-size: 9px; color: var(--text3); text-transform: uppercase; margin-top: 2px; }

/* ---- Modal ---- */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.75); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
.modal { background: var(--panel); border: 1px solid var(--border2); border-radius: 16px; padding: 32px; width: 480px; box-shadow: 0 20px 60px var(--shadow); }
.modal h2 { font-size: 22px; font-weight: 700; background: linear-gradient(135deg, var(--accent), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
.modal p { font-size: 13px; color: var(--text2); line-height: 1.6; margin-bottom: 20px; }
.modal input { width: 100%; padding: 12px 14px; background: var(--bg2); border: 1px solid var(--border2); border-radius: var(--radius-sm); color: var(--text); font-size: 14px; outline: none; font-family: monospace; }
.modal input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
.modal .btn-row { display: flex; gap: 10px; margin-top: 20px; }
.modal .mbtn { flex: 1; padding: 10px; border-radius: var(--radius-sm); border: 1px solid var(--border2); font-size: 13px; font-weight: 600; cursor: pointer; transition: all .2s; }
.modal .mbtn-primary { background: linear-gradient(135deg, var(--accent2), var(--purple)); color: #fff; border-color: transparent; }
.modal .mbtn-ghost { background: transparent; color: var(--text2); }
.modal .mbtn:hover { opacity: .85; }

.hidden { display: none !important; }
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text3); }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo"><span style="font-size:24px">ğŸ˜ï¸</span><h1>Stanford Small Town</h1></div>
    <div class="stats">
      <div class="stat">ğŸ’¬ å¯¹è¯ <b id="statConv">0</b></div>
      <div class="stat">ğŸ§  åæ€ <b id="statRef">0</b></div>
      <div class="stat">ğŸ“¡ å¹¿æ’­ <b id="statBc">0</b></div>
      <div class="stat">âš¡ é˜Ÿåˆ— <b id="statQueue">0</b></div>
    </div>
    <div class="time-display" id="timeDisplay">Day 1 Â· 06:00</div>
    <select class="speed-sel" id="speedSelect">
      <option value="1">1x</option><option value="3">3x</option>
      <option value="5" selected>5x</option><option value="10">10x</option><option value="30">30x</option>
    </select>
    <div class="controls">
      <button class="hbtn active" id="btnPlay">â–¶ è¿è¡Œ</button>
      <button class="hbtn" id="btnPause">â¸ æš‚åœ</button>
      <button class="hbtn" id="btnReset">â†º é‡ç½®</button>
    </div>
  </div>

  <div class="sidebar">
    <div class="sidebar-section" id="agentList">
      <div class="sidebar-title">ğŸ‘¥ å°é•‡å±…æ°‘</div>
    </div>
    <div class="broadcast-section">
      <div class="sidebar-title">ğŸ“¡ ç©å®¶å¹¿æ’­</div>
      <textarea id="broadcastInput" placeholder="è¾“å…¥çƒ­ç‚¹äº‹ä»¶ï¼Œå±…æ°‘ä¼šè‡ªä¸»å†³å®šæ˜¯å¦è®¨è®ºâ€¦&#10;ä¾‹ï¼šå°é•‡å°†ä¸¾åŠé¦–å±Šç¾é£ŸèŠ‚ï¼"></textarea>
      <button class="broadcast-btn" onclick="sendBroadcast()">ğŸ“¢ å‘å¸ƒå¹¿æ’­</button>
    </div>
  </div>

  <div class="center">
    <div class="center-tabs">
      <div class="ctab active" data-tab="map">ğŸ—ºï¸ åœ°å›¾</div>
      <div class="ctab" data-tab="conversations">ğŸ’¬ å¯¹è¯</div>
      <div class="ctab" data-tab="timeline">â±ï¸ æ—¶é—´è½´</div>
    </div>
    <div class="center-content">
      <div class="tab-panel active" id="tab-map"><canvas id="mapCanvas"></canvas></div>
      <div class="tab-panel" id="tab-conversations"><div id="convList" class="conv-list"></div></div>
      <div class="tab-panel" id="tab-timeline">
        <div id="summaryArea"></div>
        <div id="timelineList" class="timeline"></div>
      </div>
    </div>
  </div>

  <div class="right-panel" id="rightPanel">
    <div class="rp-section">
      <div class="rp-title">ğŸ§  é€‰ä¸­å±…æ°‘è¯¦æƒ…</div>
      <div style="font-size:13px;color:var(--text3);">â† ç‚¹å‡»å·¦ä¾§å±…æ°‘æŸ¥çœ‹</div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="apiModal">
  <div class="modal">
    <h2>ğŸ˜ï¸ Stanford Small Town</h2>
    <p>AI é©±åŠ¨çš„å°é•‡ç”Ÿæ´»æ¨¡æ‹Ÿã€‚æ¯ä½å±…æ°‘æ‹¥æœ‰ç‹¬ç«‹è®°å¿†ã€æ€§æ ¼å’Œç¤¾äº¤å…³ç³»ã€‚<br>
    ä½¿ç”¨ DashScope API (qwen3-max) é©±åŠ¨æ€è€ƒä¸å¯¹è¯ã€‚</p>
    <input type="password" id="apiKeyInput" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" />
    <div class="btn-row">
      <button class="mbtn mbtn-ghost" onclick="startWithDemo()">ğŸ® æ¼”ç¤ºæ¨¡å¼</button>
      <button class="mbtn mbtn-primary" onclick="startWithApi()">ğŸš€ å¯åŠ¨</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// Stanford Small Town v2 â€” Generative Agents
// ============================================================
const CONFIG = { apiKey: '', baseUrl: 'https://dashscope.aliyuncs.com/compatible-mode/v1', model: 'qwen3-max', demoMode: false };

const LOCATIONS = [
  { id: 'home_lin', name: 'æ—å®¶', x: 60, y: 80, w: 55, h: 45, color: '#5c6bc0', icon: 'ğŸ ' },
  { id: 'home_chen', name: 'é™ˆå®¶', x: 60, y: 200, w: 55, h: 45, color: '#7e57c2', icon: 'ğŸ ' },
  { id: 'home_wang', name: 'ç‹å®¶', x: 60, y: 320, w: 55, h: 45, color: '#26a69a', icon: 'ğŸ ' },
  { id: 'cafe', name: 'å’–å•¡é¦†', x: 220, y: 60, w: 75, h: 55, color: '#8d6e63', icon: 'â˜•' },
  { id: 'library', name: 'å›¾ä¹¦é¦†', x: 220, y: 180, w: 75, h: 55, color: '#42a5f5', icon: 'ğŸ“š' },
  { id: 'park', name: 'å…¬å›­', x: 220, y: 310, w: 90, h: 65, color: '#66bb6a', icon: 'ğŸŒ³' },
  { id: 'store', name: 'æ‚è´§åº—', x: 400, y: 60, w: 65, h: 55, color: '#ffa726', icon: 'ğŸ›’' },
  { id: 'school', name: 'å­¦æ ¡', x: 400, y: 180, w: 75, h: 55, color: '#ef5350', icon: 'ğŸ«' },
  { id: 'restaurant', name: 'é™ˆè®°å°å¨', x: 400, y: 310, w: 70, h: 55, color: '#ec407a', icon: 'ğŸœ' },
  { id: 'town_square', name: 'å°é•‡å¹¿åœº', x: 220, y: 420, w: 110, h: 50, color: '#78909c', icon: 'â›²' },
];

const AGENT_TEMPLATES = [
  { id: 'lin_mei', name: 'æ—æ¢…', emoji: 'ğŸ‘©â€ğŸ«', age: 34, occupation: 'å°å­¦æ•™å¸ˆ',
    personality: 'æ¸©æŸ”ç»†å¿ƒï¼Œçƒ­çˆ±æ•™è‚²ï¼Œå–œæ¬¢è¯»ä¹¦å’Œå›­è‰º', home: 'home_lin',
    routine: { wake: 6, sleep: 22 },
    relationships: { chen_wei: 'é‚»å±…å’Œå¥½å‹', wang_gang: 'å­¦ç”Ÿå®¶é•¿', zhao_li: 'å®¤å‹', liu_peng: 'å°Šæ•¬çš„å‰è¾ˆ' },
    initialMemory: ['ä»Šå¤©æ˜¯æ¥åˆ°å°é•‡çš„ç¬¬ä¸€å¤©ï¼Œæ„Ÿè§‰ä¸€åˆ‡éƒ½å¾ˆæ–°é²œã€‚', 'æˆ‘å–œæ¬¢åœ¨æ—©æ™¨å»å’–å•¡é¦†å–ä¸€æ¯æ‹¿é“å†å»å­¦æ ¡ã€‚'] },
  { id: 'chen_wei', name: 'é™ˆä¼Ÿ', emoji: 'ğŸ‘¨â€ğŸ³', age: 42, occupation: 'é¤é¦†è€æ¿',
    personality: 'çƒ­æƒ…è±ªçˆ½ï¼Œå¨è‰ºç²¾æ¹›ï¼Œçˆ±å¼€ç©ç¬‘', home: 'home_chen',
    routine: { wake: 5, sleep: 23 },
    relationships: { lin_mei: 'é‚»å±…å’Œå¥½å‹', wang_gang: 'å¸¸å®¢', liu_peng: 'çˆ¶äº²', zhao_li: 'ç»å¸¸è¢«å¥¹å®å˜±å¥åº·' },
    initialMemory: ['æˆ‘çš„é¤é¦†"é™ˆè®°å°å¨"å¼€ä¸šä¸‰å¹´äº†ï¼Œç”Ÿæ„è¿˜ä¸é”™ã€‚', 'æ¯å¤©æ—©ä¸Šäº”ç‚¹èµ·æ¥å‡†å¤‡é£Ÿææ˜¯æˆ‘çš„ä¹ æƒ¯ã€‚'] },
  { id: 'wang_gang', name: 'ç‹åˆš', emoji: 'ğŸ‘¨â€ğŸ’»', age: 28, occupation: 'è‡ªç”±ç¨‹åºå‘˜',
    personality: 'å†…å‘å®‰é™ï¼ŒæŠ€æœ¯å®…ï¼Œæ™šç¡æ™šèµ·ï¼Œå–œæ¬¢çŒ«', home: 'home_wang',
    routine: { wake: 9, sleep: 1 },
    relationships: { lin_mei: 'å°æ—¶å€™çš„è€å¸ˆ', chen_wei: 'æœ€å–œæ¬¢ä»–çš„çº¢çƒ§è‚‰', liu_peng: 'å¿˜å¹´äº¤æ£‹å‹', zhao_li: 'æœ‰ç‚¹æš—æ‹' },
    initialMemory: ['è¿œç¨‹å·¥ä½œè®©æˆ‘å¯ä»¥ä½åœ¨è¿™ä¸ªå®‰é™çš„å°é•‡ã€‚', 'æˆ‘å…»äº†ä¸€åªå«"æ¯”ç‰¹"çš„æ©˜çŒ«ã€‚', 'æœ€è¿‘åœ¨åšä¸€ä¸ªç‹¬ç«‹æ¸¸æˆé¡¹ç›®ã€‚'] },
  { id: 'zhao_li', name: 'èµµä¸½', emoji: 'ğŸ‘©â€âš•ï¸', age: 38, occupation: 'è¯Šæ‰€åŒ»ç”Ÿ',
    personality: 'å†·é™ç†æ€§ï¼Œæœ‰åŒæƒ…å¿ƒï¼Œå·¥ä½œè®¤çœŸ', home: 'home_lin',
    routine: { wake: 6, sleep: 22 },
    relationships: { lin_mei: 'å®¤å‹', chen_wei: 'ç»å¸¸æé†’ä»–æ³¨æ„å¥åº·', wang_gang: 'è§‰å¾—ä»–æŒºæœ‰è¶£', liu_peng: 'å®šæœŸç»™ä»–æ£€æŸ¥èº«ä½“' },
    initialMemory: ['å°é•‡è™½å°ä½†éœ€è¦ä¸€ä¸ªåŒ»ç”Ÿã€‚', 'å’Œæ—æ¢…åˆç§Ÿçœé’±åˆæœ‰ä¸ªä¼´ã€‚'] },
  { id: 'liu_peng', name: 'åˆ˜é¹', emoji: 'ğŸ‘´', age: 67, occupation: 'é€€ä¼‘æ•™æˆ',
    personality: 'åšå­¦å¤šé—»ï¼Œå–œæ¬¢ä¸‹æ£‹ï¼Œå¿ƒåœ°å–„è‰¯', home: 'home_chen',
    routine: { wake: 5, sleep: 21 },
    relationships: { chen_wei: 'å„¿å­', wang_gang: 'å¿˜å¹´äº¤æ£‹å‹', lin_mei: 'æ¬£èµå¥¹å¯¹æ•™è‚²çš„çƒ­æƒ…', zhao_li: 'æ„Ÿè°¢å¥¹çš„å…³å¿ƒ' },
    initialMemory: ['é€€ä¼‘åæ¬æ¥å’Œå„¿å­ä½ï¼Œäº«å—å°é•‡çš„å®é™ã€‚', 'æ¯å¤©åœ¨å…¬å›­ä¸‹æ£‹æ˜¯æœ€å¿«ä¹çš„æ—¶å…‰ã€‚'] },
];

// ---- Memory Manager ----
class MemoryManager {
  constructor(id) {
    this.agentId = id;
    this.stream = []; this.dailyLogs = {}; this.longTerm = []; this.reflections = [];
    this.importanceScores = new Map();
  }
  addObservation(text, time, importance = 5) {
    const e = { text, time: fmtTime(time), ts: time.total, importance, type: 'obs' };
    this.stream.push(e); this.importanceScores.set(text, importance);
    const dk = `Day${time.day}`; if (!this.dailyLogs[dk]) this.dailyLogs[dk] = []; this.dailyLogs[dk].push(e);
  }
  addReflection(text, time) {
    const e = { text, time: fmtTime(time), ts: time.total, type: 'ref' };
    this.reflections.push(e); this.longTerm.push(e); this.importanceScores.set(text, 8);
  }
  retrieve(query, limit = 5) {
    const all = [...this.stream, ...this.reflections];
    return all.map(m => {
      const rec = 1 / (1 + (S.time.total - m.ts) / 60);
      const imp = (this.importanceScores.get(m.text) || 5) / 10;
      const rel = simText(query, m.text);
      return { ...m, score: rec * .3 + imp * .3 + rel * .4 };
    }).sort((a, b) => b.score - a.score).slice(0, limit);
  }
  getRecent(n = 8) { return this.stream.slice(-n); }
  getLongTermSummary() { return this.longTerm.slice(-5).map(m => m.text); }
  needsCompaction() { return this.stream.length > 20; }
  compact(text, time) { this.addReflection(text, time); this.stream = this.stream.slice(-5); }
}
function simText(a, b) { const tA = new Set(a.split(/\s+/)); const tB = new Set(b.split(/\s+/)); let o = 0; for (const t of tA) if (tB.has(t)) o++; return o / Math.max(tA.size, tB.size, 1); }

// ---- Agent ----
class Agent {
  constructor(t) {
    Object.assign(this, t); this.memory = new MemoryManager(this.id);
    this.currentLocation = this.home; this.targetLocation = null;
    this.currentAction = 'ç¡è§‰'; this.currentThought = ''; this.mood = 'å¹³é™';
    this.x = 0; this.y = 0; this.actionTimer = 0; this.lastReflectionTime = 0;
    this.conversationCooldown = 0;
    const loc = LOCATIONS.find(l => l.id === this.home);
    if (loc) { this.x = loc.x + loc.w / 2; this.y = loc.y + loc.h / 2; }
    t.initialMemory.forEach(m => this.memory.addObservation(m, { day: 1, hour: 0, minute: 0, total: 0 }, 7));
  }
}

// ---- State ----
const S = {
  time: { day: 1, hour: 6, minute: 0, total: 360 }, agents: [], running: false, speed: 5,
  selectedAgent: null, logs: [], conversations: [], broadcasts: [], summaries: [],
  timeline: [], totalConv: 0, totalRef: 0, totalBc: 0, pendingApi: 0,
};

function fmtTime(t) { return `Day ${t.day} Â· ${String(t.hour).padStart(2, '0')}:${String(t.minute).padStart(2, '0')}`; }
function fmtShort(t) { return `${String(t.hour).padStart(2, '0')}:${String(t.minute).padStart(2, '0')}`; }
function advTime(m) { S.time.minute += m; S.time.total += m; while (S.time.minute >= 60) { S.time.minute -= 60; S.time.hour++; } while (S.time.hour >= 24) { S.time.hour -= 24; S.time.day++; } }

// ---- API with concurrency control ----
const apiQueue = []; let apiRunning = 0; const API_MAX_CONCURRENT = 3;

function processApiQueue() {
  while (apiRunning < API_MAX_CONCURRENT && apiQueue.length > 0) {
    const { resolve, sys, usr, maxTok } = apiQueue.shift();
    apiRunning++;
    _callQwenRaw(sys, usr, maxTok).then(resolve).finally(() => { apiRunning--; processApiQueue(); });
  }
}

async function callQwen(sys, usr, maxTok = 300) {
  if (CONFIG.demoMode) return demoResp(usr);
  // Drop request if queue is too deep (prevents resource exhaustion)
  if (apiQueue.length >= 10) return demoResp(usr);
  return new Promise(resolve => { apiQueue.push({ resolve, sys, usr, maxTok }); processApiQueue(); });
}

async function _callQwenRaw(sys, usr, maxTok) {
  S.pendingApi++;
  try {
    const r = await fetch(`${CONFIG.baseUrl}/chat/completions`, {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${CONFIG.apiKey}` },
      body: JSON.stringify({ model: CONFIG.model, messages: [{ role: 'system', content: sys }, { role: 'user', content: usr }], max_tokens: maxTok, temperature: 0.85, extra_body: { enable_thinking: false } }),
    });
    const d = await r.json();
    if (d.error) { console.warn('API error:', d.error); return demoResp(usr); }
    return d.choices?.[0]?.message?.content?.trim() || demoResp(usr);
  } catch (e) { console.warn('API fail:', e); return demoResp(usr); }
  finally { S.pendingApi--; }
}

function getSocialHotspots(h) {
  if (h >= 6 && h < 9) return ['cafe', 'park'];
  if (h >= 9 && h < 12) return ['library', 'school', 'store'];
  if (h >= 12 && h < 14) return ['restaurant', 'cafe'];
  if (h >= 14 && h < 17) return ['library', 'park', 'town_square'];
  if (h >= 17 && h < 20) return ['park', 'town_square', 'restaurant'];
  if (h >= 20) return ['restaurant', 'cafe'];
  return ['park'];
}

function demoResp(p) {
  const acts = ['å»å’–å•¡é¦†å–æ¯å’–å•¡', 'åœ¨å…¬å›­æ•£æ­¥', 'å»å›¾ä¹¦é¦†çœ‹çœ‹æ–°ä¹¦', 'åˆ°æ‚è´§åº—ä¹°æ—¥ç”¨å“', 'åœ¨å°é•‡å¹¿åœºåå', 'å›å®¶ä¼‘æ¯', 'å»é™ˆè®°å°å¨åƒé¥­', 'åœ¨å­¦æ ¡å¤‡è¯¾'];
  const thoughts = ['ä»Šå¤©å¤©æ°”çœŸå¥½', 'ç”Ÿæ´»åœ¨è¿™é‡Œå¾ˆæƒ¬æ„', 'æœŸå¾…é‡åˆ°æœ‰è¶£çš„äºº', 'è¯¥æ•´ç†ä¸‹æƒ³æ³•äº†', 'å¾ˆå¹³é™çš„ä¸€å¤©'];
  const moods = ['å¼€å¿ƒ', 'å¹³é™', 'å¥½å¥‡', 'æ»¡è¶³', 'æœŸå¾…'];
  if (p.includes('æ¥ä¸‹æ¥') || p.includes('è¡ŒåŠ¨')) {
    const hs = getSocialHotspots(S.time.hour);
    const loc = Math.random() < .7 ? hs[Math.floor(Math.random() * hs.length)] : ['cafe', 'park', 'library', 'restaurant', 'town_square'][Math.floor(Math.random() * 5)];
    return JSON.stringify({ action: acts[Math.floor(Math.random() * acts.length)], location: loc, thought: thoughts[Math.floor(Math.random() * thoughts.length)], mood: moods[Math.floor(Math.random() * moods.length)] });
  }
  if (p.includes('å¯¹è¯') || p.includes('äº¤è°ˆ') || p.includes('è¯´')) {
    const lines = ['ä½ å¥½å•Šï¼ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ', 'æœ€è¿‘åœ¨å¿™ä»€ä¹ˆå‘¢ï¼Ÿ', 'å¤©æ°”è¿™ä¹ˆå¥½ï¼Œè¦ä¸è¦ä¸€èµ·æ•£æ­¥ï¼Ÿ', 'æˆ‘æœ€è¿‘å‘ç°äº†ä¸€ä»¶æœ‰æ„æ€çš„äº‹ã€‚', 'ä½ å¬è¯´é•‡ä¸Šçš„æ–°æ¶ˆæ¯äº†å—ï¼Ÿ', 'å“ˆå“ˆï¼Œè¯´èµ·æ¥æŒºæœ‰æ„æ€çš„ã€‚'];
    return lines[Math.floor(Math.random() * lines.length)];
  }
  if (p.includes('åæ€') || p.includes('æ€»ç»“')) return 'ä»Šå¤©å¾ˆå……å®ã€‚å’Œé‚»å±…èŠäº†å‡ å¥ï¼Œå»äº†å¸¸å»çš„åœ°æ–¹ã€‚å°é•‡çš„ç”Ÿæ´»ç®€å•ä½†å®‰å¿ƒã€‚';
  if (p.includes('çƒ­ç‚¹') || p.includes('æ‘˜è¦')) return JSON.stringify({ summary: 'ä»Šå¤©å°é•‡å±…æ°‘ä¸»è¦åœ¨å’–å•¡é¦†å’Œå…¬å›­æ´»åŠ¨ã€‚å¤§å®¶è®¨è®ºäº†å¤©æ°”å’Œè¿‘å†µã€‚', topics: ['æ—¥å¸¸ç”Ÿæ´»', 'é‚»é‡Œäº¤æµ', 'å¤©æ°”'] });
  if (p.includes('å¹¿æ’­') || p.includes('çœ‹æ³•')) {
    const reactions = ['è¿™å¤ªæœ‰æ„æ€äº†ï¼æˆ‘å¾—è·Ÿæœ‹å‹ä»¬èŠèŠã€‚', 'å—¯ï¼Œå¬èµ·æ¥ä¸é”™ï¼Œå€¼å¾—å…³æ³¨ã€‚', 'æœ‰æ„æ€ï¼Œä½†æˆ‘æ›´åœ¨æ„è‡ªå·±çš„äº‹ã€‚', 'å¤ªå¥½äº†ï¼æˆ‘è¦å‚ä¸ä¸€ä¸‹ã€‚'];
    return reactions[Math.floor(Math.random() * reactions.length)];
  }
  return thoughts[Math.floor(Math.random() * thoughts.length)];
}

// ---- Agent AI ----
function buildSysPrompt(a) {
  const rels = Object.entries(a.relationships).map(([id, desc]) => { const o = S.agents.find(x => x.id === id); return o ? `- ${o.name}ï¼š${desc}` : ''; }).filter(Boolean).join('\n');
  let bp = '';
  if (S.broadcasts.length > 0) {
    bp = '\n\n## æœ€è¿‘çš„å°é•‡å¹¿æ’­\n' + S.broadcasts.slice(-3).map(b => `[${b.time}] ${b.text}`).join('\n');
  }
  return `ä½ æ˜¯"${a.name}"ï¼Œ${a.age}å²ï¼Œ${a.occupation}ã€‚æ€§æ ¼ï¼š${a.personality}\nä½ ä½åœ¨ Stanford Small Town å°é•‡ã€‚\n\n## äººé™…å…³ç³»\n${rels}${bp}\n\n## æŒ‡ä»¤\nå§‹ç»ˆä»¥è§’è‰²èº«ä»½å›åº”ï¼Œç®€çŸ­è‡ªç„¶åƒçœŸäººã€‚ç”¨ä¸­æ–‡ã€‚`;
}

async function decideAction(agent) {
  const h = S.time.hour;
  if (h >= agent.routine.sleep || h < agent.routine.wake) { agent.currentAction = 'ç¡è§‰'; agent.targetLocation = agent.home; return; }
  const recMem = agent.memory.getRecent(5).map(m => `[${m.time}] ${m.text}`).join('\n');
  const ltMem = agent.memory.getLongTermSummary().join('\n');
  const nearby = S.agents.filter(a => a.id !== agent.id && a.currentLocation === agent.currentLocation).map(a => a.name);
  const others = S.agents.filter(a => a.id !== agent.id && a.currentAction !== 'ç¡è§‰').map(a => { const l = LOCATIONS.find(x => x.id === a.currentLocation); return l ? `${a.name}åœ¨${l.name}` : null; }).filter(Boolean);
  const hs = getSocialHotspots(h).map(id => LOCATIONS.find(l => l.id === id)?.name).filter(Boolean);
  const bcRecent = S.broadcasts.slice(-2).map(b => b.text).join('; ');

  const prompt = `å½“å‰æ—¶é—´ï¼š${fmtTime(S.time)}\nä½ åœ¨ï¼š${LOCATIONS.find(l => l.id === agent.currentLocation)?.name || '?'}\nå¿ƒæƒ…ï¼š${agent.mood}\né™„è¿‘ï¼š${nearby.length > 0 ? nearby.join('ã€') : 'æ— '}\nå…¶ä»–äººï¼š${others.join('ã€') || '?'}\nçƒ­é—¹çš„åœ°æ–¹ï¼š${hs.join('ã€')}${bcRecent ? `\næœ€è¿‘å¹¿æ’­ï¼š${bcRecent}` : ''}\n\n## è®°å¿†\n${recMem || 'æ— '}\n\n## é•¿æœŸè®°å¿†\n${ltMem || 'æ— '}\n\n## åœ°ç‚¹\n${LOCATIONS.map(l => `- ${l.name}(${l.id})`).join('\n')}\n\nä½ å–œæ¬¢ç¤¾äº¤ã€‚ä»¥JSONå›å¤ï¼š{"action":"è¡ŒåŠ¨","location":"åœ°ç‚¹id","thought":"æƒ³æ³•","mood":"å¿ƒæƒ…"}`;
  const resp = await callQwen(buildSysPrompt(agent), prompt, 200);
  try {
    const p = JSON.parse(resp.replace(/```json\n?/g, '').replace(/```/g, '').trim());
    agent.currentAction = p.action || 'é—²é€›'; agent.targetLocation = p.location || agent.currentLocation;
    agent.currentThought = p.thought || ''; agent.mood = p.mood || agent.mood;
    agent.memory.addObservation(p.action, S.time, 5);
    addTimeline(agent, p.action, 'event');
  } catch { agent.currentAction = 'é—²é€›'; agent.targetLocation = getSocialHotspots(h)[0] || 'park'; }
}

async function generateConversation(a1, a2) {
  if (a1.conversationCooldown > 0 || a2.conversationCooldown > 0) return;
  a1.conversationCooldown = 8; a2.conversationCooldown = 8;
  const mem1 = a1.memory.retrieve(a2.name, 3).map(m => m.text).join('; ');
  const locN = LOCATIONS.find(l => l.id === a1.currentLocation)?.name || 'æŸå¤„';
  const bcHint = S.broadcasts.length > 0 ? `\næœ€è¿‘å°é•‡å¹¿æ’­ï¼š${S.broadcasts.slice(-1)[0]?.text || ''}` : '';
  const p1 = `ä½ åœ¨${locN}é‡åˆ°${a2.name}ã€‚è®°å¿†ï¼š${mem1 || 'æ— '}ã€‚å¿ƒæƒ…ï¼š${a1.mood}ã€‚${bcHint}\nè¯´ä¸€å¥è‡ªç„¶çš„è¯ï¼ˆ30å­—å†…ï¼‰ï¼š`;
  const l1 = (await callQwen(buildSysPrompt(a1), p1, 60)).replace(/["""]/g, '').trim();
  const mem2 = a2.memory.retrieve(a1.name, 3).map(m => m.text).join('; ');
  const p2 = `${a1.name}å¯¹ä½ è¯´ï¼š"${l1}"\nè®°å¿†ï¼š${mem2 || 'æ— '}ã€‚å¿ƒæƒ…ï¼š${a2.mood}ã€‚\nç®€çŸ­å›åº”ï¼ˆ30å­—å†…ï¼‰ï¼š`;
  const l2 = (await callQwen(buildSysPrompt(a2), p2, 60)).replace(/["""]/g, '').trim();

  a1.memory.addObservation(`å’Œ${a2.name}èŠå¤©ï¼š"${l1}"â†’"${l2}"`, S.time, 6);
  a2.memory.addObservation(`å’Œ${a1.name}èŠå¤©ï¼š"${l1}"â†’"${l2}"`, S.time, 6);

  const conv = { time: fmtTime(S.time), timeShort: fmtShort(S.time), loc: locN, a1: { name: a1.name, emoji: a1.emoji, line: l1 }, a2: { name: a2.name, emoji: a2.emoji, line: l2 } };
  S.conversations.push(conv); S.totalConv++;
  addTimeline(a1, `ğŸ’¬ ${a1.name}ï¼š"${l1}" â†’ ${a2.name}ï¼š"${l2}"`, 'conv');
  renderConversations(); updateStats();
}

async function reflect(agent) {
  if (S.time.total - agent.lastReflectionTime < 120) return;
  if (!agent.memory.needsCompaction()) return;
  agent.lastReflectionTime = S.time.total;
  const obs = agent.memory.getRecent(15).map(m => m.text).join('\n- ');
  const r = (await callQwen(buildSysPrompt(agent), `åŸºäºæœ€è¿‘ç»å†ï¼Œç®€çŸ­åæ€ï¼ˆ50å­—å†…ï¼‰ï¼š\n- ${obs}\nåæ€ï¼š`, 100)).replace(/["""]/g, '').trim();
  agent.memory.compact(r, S.time);
  S.totalRef++; addTimeline(agent, `ğŸ”® ${r}`, 'thought'); updateStats();
}

// ---- Broadcast ----
async function sendBroadcast() {
  const input = document.getElementById('broadcastInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  const bc = { text, time: fmtTime(S.time), timeShort: fmtShort(S.time) };
  S.broadcasts.push(bc); S.totalBc++;
  addTimeline({ name: 'ğŸ“¡ å¹¿æ’­', emoji: 'ğŸ“¡' }, text, 'broadcast');
  updateStats();

  // Each agent reacts to the broadcast
  for (const agent of S.agents) {
    if (agent.currentAction === 'ç¡è§‰') continue;
    const prompt = `å°é•‡å¹¿æ’­äº†ä¸€æ¡æ¶ˆæ¯ï¼š"${text}"\nä½ çš„æ€§æ ¼ï¼š${agent.personality}\nä½ çš„å¿ƒæƒ…ï¼š${agent.mood}\n\nè¯·ç®€çŸ­è¡¨è¾¾ä½ å¯¹è¿™æ¡å¹¿æ’­çš„ååº”å’Œçœ‹æ³•ï¼ˆ30å­—å†…ï¼‰ï¼š`;
    const reaction = (await callQwen(buildSysPrompt(agent), prompt, 80)).replace(/["""]/g, '').trim();
    agent.memory.addObservation(`å¬åˆ°å¹¿æ’­"${text}"ï¼Œæƒ³æ³•ï¼š${reaction}`, S.time, 7);
    addTimeline(agent, `ğŸ“¡ å¬åˆ°å¹¿æ’­åï¼š${reaction}`, 'broadcast');
  }
}

// ---- AI Summary ----
async function generateSummary() {
  const recentConvs = S.conversations.slice(-8).map(c => `${c.a1.name}å¯¹${c.a2.name}è¯´"${c.a1.line}"ï¼Œ${c.a2.name}å›"${c.a2.line}"`).join('\n');
  const recentBc = S.broadcasts.slice(-3).map(b => b.text).join('; ');
  if (!recentConvs && !recentBc) return;
  const prompt = `ä»¥ä¸‹æ˜¯å°é•‡æœ€è¿‘çš„å¯¹è¯å’Œäº‹ä»¶ï¼š\n${recentConvs}\n${recentBc ? `å¹¿æ’­ï¼š${recentBc}` : ''}\n\nè¯·ç”¨JSONæ ¼å¼æ€»ç»“ï¼š{"summary":"50å­—ä»¥å†…çš„æ€»ç»“","topics":["è¯é¢˜1","è¯é¢˜2","è¯é¢˜3"]}`;
  const resp = await callQwen('ä½ æ˜¯å°é•‡è§‚å¯Ÿå‘˜ï¼Œç”¨ä¸­æ–‡ç®€æ´æ€»ç»“å°é•‡åŠ¨æ€ã€‚', prompt, 150);
  try {
    const parsed = JSON.parse(resp.replace(/```json\n?/g, '').replace(/```/g, '').trim());
    const summary = { time: fmtTime(S.time), summary: parsed.summary || 'å°é•‡ä¸€åˆ‡å¹³é™ã€‚', topics: parsed.topics || ['æ—¥å¸¸'] };
    S.summaries.push(summary);
    addTimeline({ name: 'ğŸ“Š AIæ€»ç»“', emoji: 'ğŸ“Š' }, summary.summary, 'summary');
    renderSummary();
  } catch {}
}

// ---- Timeline ----
function addTimeline(agent, text, type) {
  S.timeline.push({ time: fmtTime(S.time), timeShort: fmtShort(S.time), agent: agent.name, emoji: agent.emoji, text, type, day: S.time.day });
  if (S.timeline.length > 300) S.timeline = S.timeline.slice(-200);
  renderTimelineEntry(S.timeline[S.timeline.length - 1]);
}

function renderTimelineEntry(e) {
  const list = document.getElementById('timelineList');
  const div = document.createElement('div'); div.className = 'tl-item';
  const icons = { event: 'ğŸ“Œ', conv: 'ğŸ’¬', thought: 'ğŸ”®', broadcast: 'ğŸ“¡', summary: 'ğŸ“Š' };
  div.innerHTML = `<div class="tl-dot ${e.type}">${icons[e.type] || 'ğŸ“Œ'}</div>
    <div class="tl-body"><div class="tl-time">${e.time}</div><div class="tl-text"><span class="tl-agent">${e.emoji} ${e.agent}</span> ${e.text}</div></div>`;
  list.prepend(div);
}

// ---- Movement ----
function moveAgent(a) {
  if (!a.targetLocation || a.targetLocation === a.currentLocation) return;
  const t = LOCATIONS.find(l => l.id === a.targetLocation); if (!t) return;
  const tx = t.x + t.w / 2, ty = t.y + t.h / 2;
  const dx = tx - a.x, dy = ty - a.y, dist = Math.sqrt(dx * dx + dy * dy);
  if (dist < 5) { a.currentLocation = a.targetLocation; a.targetLocation = null; a.x = tx; a.y = ty; return; }
  const spd = 2.5; a.x += (dx / dist) * spd; a.y += (dy / dist) * spd;
}

// ---- Render: Conversations ----
function renderConversations() {
  const list = document.getElementById('convList');
  // Only render last one to avoid re-rendering all
  const c = S.conversations[S.conversations.length - 1]; if (!c) return;
  const div = document.createElement('div'); div.className = 'conv-bubble';
  div.innerHTML = `<div class="cb-header"><span class="cb-loc">ğŸ“ ${c.loc}</span><span class="cb-time">${c.time}</span></div>
    <div class="cb-line"><span class="speaker">${c.a1.emoji} ${c.a1.name}</span>ï¼š${c.a1.line}</div>
    <div class="cb-line"><span class="speaker b">${c.a2.emoji} ${c.a2.name}</span>ï¼š${c.a2.line}</div>`;
  list.prepend(div);
}

function renderSummary() {
  const area = document.getElementById('summaryArea');
  const s = S.summaries[S.summaries.length - 1]; if (!s) return;
  area.innerHTML = `<div class="summary-card">
    <h4>ğŸ“Š AI çƒ­ç‚¹æ€»ç»“ <span style="font-size:10px;color:var(--text3);font-weight:400">${s.time}</span></h4>
    <p>${s.summary}</p>
    <div class="topics">${s.topics.map(t => `<span class="topic-tag">${t}</span>`).join('')}</div>
  </div>`;
}

// ---- Render: Sidebar ----
function renderSidebar() {
  const el = document.getElementById('agentList');
  el.innerHTML = '<div class="sidebar-title">ğŸ‘¥ å°é•‡å±…æ°‘</div>';
  S.agents.forEach(a => {
    const card = document.createElement('div');
    card.className = `agent-card${S.selectedAgent === a.id ? ' sel' : ''}`;
    const loc = LOCATIONS.find(l => l.id === a.currentLocation);
    card.innerHTML = `<div class="ac-top"><div class="ac-emoji">${a.emoji}</div><div><div class="ac-name">${a.name}</div><div class="ac-occ">${a.occupation}</div></div></div>
      <div class="ac-row"><span class="ac-loc">ğŸ“ ${loc?.name || '?'}</span><span class="ac-mood">ğŸ’­ ${a.mood}</span></div>`;
    card.onclick = () => { S.selectedAgent = a.id; renderSidebar(); renderRightPanel(); };
    el.appendChild(card);
  });
}

// ---- Render: Right Panel ----
function renderRightPanel() {
  const rp = document.getElementById('rightPanel');
  const a = S.agents.find(x => x.id === S.selectedAgent);
  if (!a) { rp.innerHTML = '<div class="rp-section"><div class="rp-title">ğŸ§  é€‰ä¸­å±…æ°‘è¯¦æƒ…</div><div style="font-size:13px;color:var(--text3)">â† ç‚¹å‡»å·¦ä¾§å±…æ°‘æŸ¥çœ‹</div></div>'; return; }
  const loc = LOCATIONS.find(l => l.id === a.currentLocation);
  const recMem = a.memory.getRecent(6);
  const refs = a.memory.reflections.slice(-3);
  rp.innerHTML = `
    <div class="rp-section">
      <div class="rp-agent-header"><div class="rp-emoji">${a.emoji}</div><div class="rp-info"><h3>${a.name}</h3><p>${a.age}å² Â· ${a.occupation}</p></div></div>
      <div class="rp-meta">
        <div class="rp-meta-item"><div class="label">ä½ç½®</div><div class="value loc">${loc?.icon || ''} ${loc?.name || '?'}</div></div>
        <div class="rp-meta-item"><div class="label">å¿ƒæƒ…</div><div class="value mood">${a.mood}</div></div>
        <div class="rp-meta-item"><div class="label">çŠ¶æ€</div><div class="value act">${a.currentAction}</div></div>
        <div class="rp-meta-item"><div class="label">æ€§æ ¼</div><div class="value" style="font-size:11px">${a.personality.slice(0, 12)}â€¦</div></div>
      </div>
      ${a.currentThought ? `<div class="thought-card"><div class="tc-label">ğŸ’­ å½“å‰æƒ³æ³•</div><div class="tc-text">${a.currentThought}</div></div>` : ''}
    </div>
    <div class="rp-section">
      <div class="rp-title">ğŸ“ è¿‘æœŸè®°å¿†</div>
      <div class="mem-list">${recMem.map(m => `<div class="mem-item"><span class="mt">${m.time}</span> ${m.text}</div>`).join('') || '<div class="mem-item" style="color:var(--text3)">æš‚æ— </div>'}</div>
    </div>
    ${refs.length > 0 ? `<div class="rp-section"><div class="rp-title">ğŸ”® åæ€ Â· é•¿æœŸè®°å¿†</div><div class="mem-list">${refs.map(m => `<div class="mem-item"><span class="mt">${m.time}</span> ${m.text}</div>`).join('')}</div></div>` : ''}
    <div class="rp-section">
      <div class="rp-title">ğŸ“Š è®°å¿†ç»Ÿè®¡</div>
      <div class="mem-stats">
        <div class="mem-stat"><div class="ms-val">${a.memory.stream.length}</div><div class="ms-label">è§‚å¯Ÿ</div></div>
        <div class="mem-stat"><div class="ms-val">${Object.keys(a.memory.dailyLogs).length}</div><div class="ms-label">å¤©æ•°</div></div>
        <div class="mem-stat"><div class="ms-val">${a.memory.longTerm.length}</div><div class="ms-label">é•¿æœŸ</div></div>
        <div class="mem-stat"><div class="ms-val">${a.memory.reflections.length}</div><div class="ms-label">åæ€</div></div>
      </div>
    </div>`;
}

// ---- Render: Map ----
const canvas = document.getElementById('mapCanvas');
const ctx = canvas.getContext('2d');
function resizeCanvas() { const c = canvas.parentElement; canvas.width = c.clientWidth; canvas.height = c.clientHeight; }

function drawMap() {
  resizeCanvas(); ctx.clearRect(0, 0, canvas.width, canvas.height);
  // Roads
  ctx.strokeStyle = '#1a2540'; ctx.lineWidth = 16; ctx.lineCap = 'round';
  [[40, 145, 520, 145], [40, 265, 520, 265], [40, 395, 520, 395], [150, 40, 150, 480], [340, 40, 340, 480]].forEach(([x1, y1, x2, y2]) => { ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke(); });
  ctx.strokeStyle = '#243556'; ctx.lineWidth = 1; ctx.setLineDash([6, 6]);
  [[40, 145, 520, 145], [40, 265, 520, 265], [40, 395, 520, 395], [150, 40, 150, 480], [340, 40, 340, 480]].forEach(([x1, y1, x2, y2]) => { ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke(); });
  ctx.setLineDash([]);
  // Buildings
  LOCATIONS.forEach(l => {
    ctx.fillStyle = 'rgba(0,0,0,.25)'; ctx.fillRect(l.x + 2, l.y + 2, l.w, l.h);
    const grad = ctx.createLinearGradient(l.x, l.y, l.x, l.y + l.h);
    grad.addColorStop(0, l.color + 'cc'); grad.addColorStop(1, l.color + '66');
    ctx.fillStyle = grad; ctx.beginPath(); ctx.roundRect(l.x, l.y, l.w, l.h, 6); ctx.fill();
    ctx.strokeStyle = l.color; ctx.lineWidth = 1.5; ctx.beginPath(); ctx.roundRect(l.x, l.y, l.w, l.h, 6); ctx.stroke();
    ctx.fillStyle = '#fff'; ctx.font = '14px system-ui'; ctx.textAlign = 'center';
    ctx.fillText(l.icon, l.x + l.w / 2, l.y + l.h / 2 - 4);
    ctx.font = '10px system-ui'; ctx.fillText(l.name, l.x + l.w / 2, l.y + l.h / 2 + 10);
  });
  // Agents
  S.agents.forEach(a => {
    const sel = S.selectedAgent === a.id;
    if (sel) { ctx.beginPath(); ctx.arc(a.x, a.y, 20, 0, Math.PI * 2); ctx.fillStyle = 'rgba(108,159,255,.2)'; ctx.fill(); }
    // Shadow
    ctx.beginPath(); ctx.arc(a.x + 1, a.y + 2, 13, 0, Math.PI * 2); ctx.fillStyle = 'rgba(0,0,0,.3)'; ctx.fill();
    // Circle
    const grd = ctx.createRadialGradient(a.x, a.y - 4, 2, a.x, a.y, 13);
    grd.addColorStop(0, sel ? '#8ab4ff' : '#3a4f6f'); grd.addColorStop(1, sel ? '#4a7fff' : '#1e2d4a');
    ctx.beginPath(); ctx.arc(a.x, a.y, 13, 0, Math.PI * 2); ctx.fillStyle = grd; ctx.fill();
    ctx.strokeStyle = sel ? '#6c9fff' : '#2a3d5e'; ctx.lineWidth = 2; ctx.stroke();
    ctx.font = '14px system-ui'; ctx.textAlign = 'center'; ctx.fillText(a.emoji, a.x, a.y + 5);
    ctx.fillStyle = sel ? '#6c9fff' : '#5a6a85'; ctx.font = '600 10px system-ui'; ctx.fillText(a.name, a.x, a.y - 18);
  });
  // Night
  const h = S.time.hour;
  if (h >= 20 || h < 6) { ctx.fillStyle = `rgba(5,5,20,${h >= 22 || h < 4 ? .45 : .25})`; ctx.fillRect(0, 0, canvas.width, canvas.height); }
}

function updateStats() {
  document.getElementById('statConv').textContent = S.totalConv;
  document.getElementById('statRef').textContent = S.totalRef;
  document.getElementById('statBc').textContent = S.totalBc;
  document.getElementById('statQueue').textContent = apiQueue.length + apiRunning;
}

// ---- Tabs ----
document.querySelectorAll('.ctab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('.ctab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
    if (tab.dataset.tab === 'map') drawMap();
  };
});

// Canvas click
canvas.onclick = (e) => {
  const r = canvas.getBoundingClientRect();
  const mx = e.clientX - r.left, my = e.clientY - r.top;
  let found = null;
  S.agents.forEach(a => { if ((mx - a.x) ** 2 + (my - a.y) ** 2 < 500) found = a.id; });
  S.selectedAgent = found; renderSidebar(); renderRightPanel();
};

// ---- Main Loop ----
let lastAct = {}, lastConvCheck = 0, lastSummaryTime = 0, animFrame = null;

function tick() {
  if (!S.running) return;
  advTime(1); document.getElementById('timeDisplay').textContent = fmtTime(S.time);
  S.agents.forEach(a => { moveAgent(a); if (a.conversationCooldown > 0) a.conversationCooldown--; });

  // Throttle AI calls: only trigger new actions if API queue is not backed up
  const apiOk = apiQueue.length < 6;

  for (const a of S.agents) {
    if (apiOk && S.time.total - (lastAct[a.id] || 0) >= 20) { lastAct[a.id] = S.time.total; decideAction(a); }
  }

  if (apiOk && S.time.total - lastConvCheck >= 10) {
    lastConvCheck = S.time.total;
    const groups = {};
    S.agents.forEach(a => { if (a.currentAction === 'ç¡è§‰') return; if (!groups[a.currentLocation]) groups[a.currentLocation] = []; groups[a.currentLocation].push(a); });
    for (const [, g] of Object.entries(groups)) {
      // Only one conversation per location per check to avoid API flood
      if (g.length >= 2 && Math.random() < .6) {
        const i = Math.floor(Math.random() * g.length);
        const j = (i + 1) % g.length;
        generateConversation(g[i], g[j]);
      }
    }
  }

  if (apiOk && S.time.total % 90 === 0) { for (const a of S.agents) reflect(a); }
  // AI summary every ~3 hours game time
  if (apiOk && S.time.total - lastSummaryTime >= 180 && S.conversations.length > 0) { lastSummaryTime = S.time.total; generateSummary(); }

  drawMap(); renderSidebar(); if (S.selectedAgent) renderRightPanel(); updateStats();
}

function gameLoop() { if (!S.running) return; for (let i = 0; i < S.speed; i++) tick(); animFrame = requestAnimationFrame(gameLoop); }

function initSim() {
  S.agents = AGENT_TEMPLATES.map(t => new Agent(t));
  S.time = { day: 1, hour: 6, minute: 0, total: 360 };
  S.logs = []; S.conversations = []; S.broadcasts = []; S.summaries = []; S.timeline = [];
  S.selectedAgent = null; S.totalConv = 0; S.totalRef = 0; S.totalBc = 0;
  lastAct = {}; lastConvCheck = 0; lastSummaryTime = 0;
  document.getElementById('convList').innerHTML = '';
  document.getElementById('timelineList').innerHTML = '';
  document.getElementById('summaryArea').innerHTML = '';
  addTimeline({ name: 'ç³»ç»Ÿ', emoji: 'ğŸ˜ï¸' }, 'å°é•‡è‹é†’äº†ï¼æ–°çš„ä¸€å¤©å¼€å§‹ã€‚', 'event');
  renderSidebar(); drawMap(); updateStats();
}

function startSim() { S.running = true; document.getElementById('btnPlay').classList.add('active'); document.getElementById('btnPause').classList.remove('active'); gameLoop(); }
function pauseSim() { S.running = false; document.getElementById('btnPlay').classList.remove('active'); document.getElementById('btnPause').classList.add('active'); if (animFrame) cancelAnimationFrame(animFrame); }

document.getElementById('btnPlay').onclick = startSim;
document.getElementById('btnPause').onclick = pauseSim;
document.getElementById('btnReset').onclick = () => { pauseSim(); initSim(); };
document.getElementById('speedSelect').onchange = (e) => { S.speed = parseInt(e.target.value); };

function startWithApi() {
  const k = document.getElementById('apiKeyInput').value.trim();
  if (!k) { alert('è¯·è¾“å…¥ API Key'); return; }
  CONFIG.apiKey = k; CONFIG.demoMode = false;
  document.getElementById('apiModal').classList.add('hidden'); initSim(); startSim();
}
function startWithDemo() { CONFIG.demoMode = true; document.getElementById('apiModal').classList.add('hidden'); initSim(); startSim(); }

window.addEventListener('resize', drawMap);
resizeCanvas(); drawMap();
</script>
</body>
</html>
