<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>AI Avatar</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{--bg:#08090e;--bg2:#10121a;--glass:rgba(16,18,26,.85);--card:rgba(28,35,58,.6);--accent:#7b8cff;--accent2:#5b6bff;--glow:rgba(123,140,255,.12);--purple:#a78bfa;--warm:#ffb347;--green:#34d399;--red:#fb7185;--cyan:#67e8f9;--text:#f0f2f8;--text2:#7c8497;--text3:#3d4355;--border:rgba(255,255,255,.06);--r:16px;--rs:12px}
body{font-family:'SF Pro Display',-apple-system,system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;padding-bottom:env(safe-area-inset-bottom)}
.nav{position:fixed;bottom:0;left:0;right:0;background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom)}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;padding:10px 0 6px;font-size:10px;color:var(--text3);cursor:pointer;transition:.3s}.ni.on{color:var(--accent)}.ni .ic{font-size:22px;margin-bottom:3px}
.page{display:none;min-height:100vh;padding:20px 16px 90px}.page.on{display:flex;flex-direction:column;align-items:center}
/* Avatar */
.av-wrap{padding-top:24px;display:flex;flex-direction:column;align-items:center;width:100%}
.av-ring{width:220px;height:220px;border-radius:50%;padding:4px;background:linear-gradient(135deg,var(--accent),var(--purple));box-shadow:0 0 40px var(--glow),0 0 80px rgba(123,140,255,.06)}
.av-inner{width:100%;height:100%;border-radius:50%;overflow:hidden;background:#000;position:relative}
.av-inner video{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0}
.av-inner .ph{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:80px;background:linear-gradient(135deg,#1a1a3e,#2d1b69)}
.badge{font-size:11px;padding:4px 14px;border-radius:20px;margin-top:14px;font-weight:500;letter-spacing:.5px}
.badge.on{background:rgba(52,211,153,.12);color:var(--green);border:1px solid rgba(52,211,153,.2)}
.badge.off{background:rgba(124,132,151,.08);color:var(--text2);border:1px solid var(--border)}
/* Mic */
.mic-wrap{margin:24px 0 16px;display:flex;align-items:center;gap:16px}
.mic{width:68px;height:68px;border-radius:50%;border:none;font-size:26px;cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--purple));color:#fff;box-shadow:0 8px 32px var(--glow);transition:.3s}
.mic.rec{background:linear-gradient(135deg,#fb7185,#f43f5e);animation:glow 2s infinite}
.mic:disabled{background:var(--text3);box-shadow:none;cursor:not-allowed}
@keyframes glow{0%,100%{box-shadow:0 0 0 0 rgba(244,63,94,.3)}50%{box-shadow:0 0 0 20px rgba(244,63,94,0)}}
.side-btn{width:44px;height:44px;border-radius:50%;border:1px solid var(--border);background:var(--card);color:var(--text2);font-size:18px;cursor:pointer;transition:.2s;backdrop-filter:blur(10px)}
.side-btn:active{transform:scale(.9)}.side-btn.on{border-color:var(--accent);color:var(--accent);background:var(--glow)}
.status{font-size:12px;color:var(--text2);text-align:center}
/* Actions */
.actions{display:flex;gap:10px;margin:16px 0;flex-wrap:wrap;justify-content:center}
.abtn{padding:8px 18px;border-radius:24px;border:1px solid var(--border);background:var(--card);backdrop-filter:blur(10px);color:var(--text2);font-size:12px;cursor:pointer;transition:.2s;font-weight:500}
.abtn:active{transform:scale(.95)}.abtn.on{border-color:var(--accent);color:var(--accent);background:var(--glow)}
/* Chat */
.chat{width:100%;max-height:260px;overflow-y:auto;background:var(--card);backdrop-filter:blur(10px);border-radius:var(--r);padding:14px;margin-top:12px;border:1px solid var(--border)}
.cm{padding:5px 0;font-size:13px;line-height:1.6;border-bottom:1px solid var(--border)}.cm:last-child{border:none}
.cm.user{color:var(--accent)}.cm.ai{color:var(--green)}.cm.sys{color:var(--text3);font-size:11px}
/* Camera */
.cam-box{position:fixed;bottom:80px;right:12px;width:130px;height:100px;background:#000;border-radius:var(--rs);overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,.6);opacity:0;transition:.3s;z-index:50;pointer-events:none;border:1px solid var(--border)}
.cam-box.show{opacity:1;pointer-events:auto}
.cam-box video{width:100%;height:100%;object-fit:cover}
.cam-box .cx{position:absolute;top:4px;right:4px;width:22px;height:22px;background:rgba(0,0,0,.6);border:none;color:#fff;border-radius:50%;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.cam-box .flip{position:absolute;bottom:4px;right:4px;width:22px;height:22px;background:rgba(0,0,0,.6);border:none;color:#fff;border-radius:50%;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center}
/* Cards */
.cg{display:flex;flex-direction:column;gap:12px;width:100%}
.ci{background:var(--card);backdrop-filter:blur(10px);border-radius:var(--r);padding:16px;border:1px solid var(--border);border-left:3px solid var(--accent)}
.ci .ct{font-size:10px;color:var(--text3)}.ci .ch{font-size:15px;font-weight:600;margin:4px 0}.ci .cb{font-size:12px;color:var(--text2);line-height:1.7}
.ci .tags{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px}
.ci .tag{font-size:10px;background:var(--glow);color:var(--accent);padding:3px 10px;border-radius:12px;border:1px solid rgba(123,140,255,.15)}
.ci .ca{display:flex;gap:6px;margin-top:10px}
.ci .ca button{font-size:11px;padding:5px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer}
/* Memory */
.ms{background:var(--card);backdrop-filter:blur(10px);border-radius:var(--r);padding:16px;margin-bottom:12px;width:100%;border:1px solid var(--border)}
.ms h3{font-size:13px;color:var(--accent);margin-bottom:10px;font-weight:600}
.me{font-size:11px;color:var(--text2);padding:5px 0;border-bottom:1px solid var(--border);line-height:1.6}.me:last-child{border:none}
.me .mt{color:var(--warm);font-size:10px}
.mstats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:100%;margin-top:12px}
.mst{background:var(--card);backdrop-filter:blur(10px);border-radius:var(--rs);padding:12px;text-align:center;border:1px solid var(--border)}
.mst .v{font-size:22px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.mst .l{font-size:9px;color:var(--text3);margin-top:3px;text-transform:uppercase}
/* Settings */
.sg{background:var(--card);backdrop-filter:blur(10px);border-radius:var(--r);padding:16px;margin-bottom:14px;width:100%;border:1px solid var(--border)}
.sg h3{font-size:13px;color:var(--text2);margin-bottom:12px;font-weight:600}
.sr{display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap}
.sr label{font-size:12px;color:var(--text2);min-width:65px;font-weight:500}
.sr input,.sr select{flex:1;min-width:0;padding:10px 14px;border:1px solid var(--border);border-radius:var(--rs);background:var(--bg2);color:var(--text);font-size:13px;outline:none;transition:.2s}
.sr input:focus,.sr select:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--glow)}
.sb{padding:10px 20px;border:none;border-radius:var(--rs);font-size:12px;font-weight:600;cursor:pointer;transition:.2s;letter-spacing:.3px}
.sb.pr{background:linear-gradient(135deg,var(--accent),var(--purple));color:#fff;box-shadow:0 4px 16px var(--glow)}
.sb.gh{background:var(--bg2);color:var(--text2);border:1px solid var(--border)}
.sb:active{transform:scale(.96)}
.pg-h{font-size:20px;font-weight:700;margin-bottom:18px;width:100%;letter-spacing:-.3px}
/* Toast */
/* Reminders */
.rem-item{background:var(--card);backdrop-filter:blur(10px);border-radius:var(--rs);padding:14px;margin-bottom:8px;border:1px solid var(--border);display:flex;align-items:flex-start;gap:12px}
.rem-item.done{opacity:.5}
.rem-check{width:24px;height:24px;border-radius:50%;border:2px solid var(--accent);background:transparent;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;margin-top:2px;transition:.2s}
.rem-check.done{background:var(--green);border-color:var(--green);color:#fff}
.rem-info{flex:1;min-width:0}
.rem-title{font-size:14px;font-weight:600}.rem-time{font-size:11px;color:var(--warm);margin-top:2px}
.rem-created{font-size:10px;color:var(--text3);margin-top:1px}
.rem-item .rem-del{background:none;border:none;color:var(--text3);font-size:16px;cursor:pointer;padding:4px}
.rem-countdown{font-size:10px;color:var(--accent);margin-top:2px}
.rem-overdue{color:var(--red)}
.toast{position:fixed;top:50px;left:50%;transform:translateX(-50%);background:var(--glass);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:var(--rs);padding:10px 24px;font-size:12px;color:var(--text);z-index:200;opacity:0;transition:.3s;font-weight:500}
.toast.show{opacity:1}
</style>
</head>
<body>
<div class="page on" id="p-chat">
  <div class="av-wrap">
    <div class="av-ring"><div class="av-inner" id="avBox">
      <div class="ph" id="avPh">ğŸ¤–</div>
      <video id="vI" loop muted playsinline autoplay style="display:none"></video>
      <video id="vT" loop muted playsinline style="display:none"></video>
    </div></div>
    <div class="badge off" id="badge">âšª å¾…æœº</div>
  </div>
  <div class="mic-wrap">
    <button class="side-btn" id="btnCam" onclick="toggleCam()">ğŸ“¹</button>
    <button class="mic" id="micBtn" onclick="toggleSession()" disabled>ğŸ¤</button>
    <button class="side-btn" onclick="uploadImg()">ğŸ–¼ï¸</button>
  </div>
  <div class="status" id="stLine">è®¾ç½®ä¸­è¾“å…¥ API Key åå¼€å§‹</div>
  <div class="actions" style="margin-top:6px;margin-bottom:0">
    <button class="abtn" id="btnWake" onclick="toggleWakeService()">ğŸ”Š åå°å”¤é†’</button>
  </div>
  <div class="actions">
    <button class="abtn" id="btnFlip" onclick="flipCam()" style="display:none">ğŸ”„ ç¿»è½¬</button>
    <button class="abtn" id="btnScreen" onclick="toggleScreen()">ğŸ–¥ï¸ å±å¹•</button>
    <button class="abtn" onclick="toggleChat()">ğŸ’¬ å¯¹è¯</button>
    <button class="abtn" id="btnDebug" onclick="toggleDebug()">ğŸ›</button>
  </div>
  <div id="debugPanel" style="display:none;width:100%;margin-top:8px;background:rgba(255,0,0,.1);border:1px solid rgba(255,0,0,.3);border-radius:10px;padding:10px;font-size:10px;color:#f88;font-family:monospace;max-height:250px;overflow-y:auto">
    <div style="display:flex;gap:6px;margin-bottom:6px;flex-wrap:wrap">
      <button onclick="debugTestFrame()" style="font-size:10px;padding:4px 8px;background:#a33;border:none;color:#fff;border-radius:4px">ğŸ§ª æ‹‰å¸§</button>
      <button onclick="debugCheckState()" style="font-size:10px;padding:4px 8px;background:#33a;border:none;color:#fff;border-radius:4px">ğŸ“Š çŠ¶æ€</button>
      <button onclick="debugTestTap()" style="font-size:10px;padding:4px 8px;background:#3a3;border:none;color:#fff;border-radius:4px">ğŸ–ï¸ æµ‹è¯•ç‚¹å‡»</button>
      <button onclick="debugShowElements()" style="font-size:10px;padding:4px 8px;background:#a3a;border:none;color:#fff;border-radius:4px">ğŸ“‹ å±å¹•å…ƒç´ </button>
    </div>
    <div id="debugLog">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¯Šæ–­...</div>
    <div style="margin-top:6px"><b>å¸§é¢„è§ˆ:</b></div>
    <img id="debugImg" style="width:160px;height:auto;border:1px solid #f44;border-radius:4px;margin-top:4px;display:none">
  </div>
  <div class="chat" id="chatEl" style="display:none"></div>
  <input type="file" id="imgIn" accept="image/*" style="display:none" onchange="onImgPick(event)">
</div>

<div class="page" id="p-cards">
  <div class="pg-h">ğŸ“‹ å¡ç‰‡æ•´ç†</div>
  <div style="display:flex;gap:10px;margin-bottom:16px;width:100%">
    <button class="sb pr" onclick="genCard()" style="flex:1;padding:14px 20px;font-size:14px">âœ¨ AI ç”Ÿæˆå¡ç‰‡</button>
    <button class="sb gh" onclick="clearCards()" style="padding:14px 16px">ğŸ—‘ï¸</button>
  </div>
  <div class="cg" id="cGrid"></div>
</div>

<div class="page" id="p-mem">
  <div class="pg-h">ğŸ§  è®°å¿†ç³»ç»Ÿ</div>
  <div class="ms"><h3>ğŸ“ çŸ­æœŸè®°å¿†</h3><div id="sMem">æš‚æ— </div></div>
  <div class="ms"><h3>ğŸ’ é•¿æœŸè®°å¿†</h3><div id="lMem">æš‚æ— </div></div>
  <div class="ms"><h3>ğŸ”® åæ€</h3><div id="rMem">æš‚æ— </div></div>
  <div class="mstats">
    <div class="mst"><div class="v" id="msO">0</div><div class="l">è§‚å¯Ÿ</div></div>
    <div class="mst"><div class="v" id="msD">0</div><div class="l">å¤©æ•°</div></div>
    <div class="mst"><div class="v" id="msR">0</div><div class="l">åæ€</div></div>
  </div>
  <div style="display:flex;gap:10px;margin-top:14px;width:100%">
    <button class="sb gh" onclick="manualFlush()" style="flex:1">ğŸ“ ç«‹å³æ€»ç»“</button>
    <button class="sb gh" onclick="exportMem()" style="flex:1">ğŸ“¤ å¯¼å‡º</button>
  </div>
</div>

<div class="page" id="p-set">
  <div class="pg-h">âš™ï¸ è®¾ç½®</div>
  <div class="sg"><h3>ğŸ”‘ API</h3>
    <div class="sr"><label>Key:</label><input type="password" id="sKey" placeholder="sk-xxxxxxxx"></div>
    <button class="sb pr" onclick="saveCfg()" style="width:100%">ä¿å­˜å¹¶åº”ç”¨</button>
  </div>
  <div class="sg"><h3>ğŸ—£ï¸ è¯­éŸ³åŠ©æ‰‹</h3>
    <div class="sr"><label>æ¿€æ´»è¯:</label><input type="text" id="sWake" placeholder="å°åŠ©æ‰‹,ä½ å¥½ï¼ˆé€—å·åˆ†éš”ï¼‰"></div>
    <div class="sr"><label>è½®æ•°:</label><input type="text" id="sTurns" value="10"></div>
    <div class="sr"><label>è¯­éŸ³:</label><select id="sVoice"><option value="Serena">Serena å¥³å£°</option><option value="Ethan">Ethan ç”·å£°</option><option value="Chelsie">Chelsie</option></select></div>
    <button class="sb pr" onclick="saveCfg()" style="width:100%">ä¿å­˜å¹¶åº”ç”¨</button>
  </div>
  <div class="sg"><h3>â° æé†’è®¾ç½®</h3>
    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:8px 0">
      <input type="checkbox" id="sSysCal" checked style="width:20px;height:20px;accent-color:var(--accent);flex-shrink:0">
      <span style="font-size:13px;color:var(--text2)">è®¾æé†’æ—¶åŒæ—¶æ·»åŠ åˆ°ç³»ç»Ÿæ—¥å†</span>
    </label>
    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:8px 0">
      <input type="checkbox" id="sSysAlarm" checked style="width:20px;height:20px;accent-color:var(--warm);flex-shrink:0">
      <span style="font-size:13px;color:var(--text2)">è®¾æé†’æ—¶åŒæ—¶è®¾ç½®ç³»ç»Ÿé—¹é“ƒ</span>
    </label>
    <button class="sb pr" onclick="saveCfg()" style="width:100%">ä¿å­˜å¹¶åº”ç”¨</button>
  </div>
  <div class="sg"><h3>ğŸ¬ å¤´åƒè§†é¢‘</h3>
    <button class="sb gh" onclick="pickVid()" style="width:100%">é€‰æ‹©è§†é¢‘æ–‡ä»¶</button>
    <div id="vidSt" style="font-size:11px;color:var(--text3);margin-top:6px"></div>
    <input type="file" id="vidIn" accept="video/*" multiple style="display:none" onchange="onVidPick(event)">
  </div>
  <div class="sg"><h3>â™¿ æ— éšœç¢è§¦æ§</h3>
    <div style="font-size:12px;color:var(--text2);line-height:1.8;margin-bottom:10px">
      å¼€å¯å AI å¯ä»¥è¯­éŸ³æ§åˆ¶å±å¹•ç‚¹å‡»/æ»‘åŠ¨ã€‚<br>
      è¯´"ç‚¹å‡»XX"æˆ–"å¾€ä¸‹æ»‘"å³å¯æ“ä½œã€‚
    </div>
    <div id="a11yStatus" style="font-size:12px;margin-bottom:8px"></div>
    <button class="sb pr" onclick="openA11y()" style="width:100%">æ‰“å¼€æ— éšœç¢è®¾ç½®</button>
    <div style="font-size:10px;color:var(--text3);margin-top:6px">æ‰¾åˆ°"AI Avatar"â†’ å¼€å¯å¼€å…³</div>
  </div>
  <div class="sg"><h3>â„¹ï¸ å…³äº</h3>
    <div style="font-size:11px;color:var(--text3);line-height:2">
      AI Avatar v1.2<br>
      ğŸ¤ è¯­éŸ³: qwen3-omni-flash-realtime<br>
      ğŸ—£ï¸ ASR: qwen3-asr-flash-realtime<br>
      ğŸ‘ï¸ è§†è§‰/å±å¹•: qwen3.5-plus<br>
      ğŸ“ æ–‡å­—ä»»åŠ¡: qwen-plus<br>
      ğŸ§  è®°å¿†: OpenClaw pattern
    </div>
  </div>
</div>

<div class="page" id="p-rem">
  <div class="pg-h">â° æé†’äº‹é¡¹</div>
  <div style="display:flex;gap:10px;margin-bottom:16px;width:100%">
    <button class="sb gh" onclick="addManualReminder()" style="flex:1">â• æ‰‹åŠ¨æ·»åŠ </button>
    <button class="sb gh" onclick="clearDoneReminders()">ğŸ—‘ï¸ æ¸…é™¤å·²å®Œæˆ</button>
  </div>
  <div id="remPending" style="width:100%"></div>
  <div style="margin-top:16px;width:100%">
    <div style="font-size:12px;color:var(--text3);margin-bottom:8px">å·²å®Œæˆ</div>
    <div id="remDone"></div>
  </div>
</div>

<div class="nav">
  <div class="ni on" data-p="p-chat"><div class="ic">ğŸ¤</div>å¯¹è¯</div>
  <div class="ni" data-p="p-rem"><div class="ic">â°</div>æé†’</div>
  <div class="ni" data-p="p-cards"><div class="ic">ğŸ“‹</div>å¡ç‰‡</div>
  <div class="ni" data-p="p-mem"><div class="ic">ğŸ§ </div>è®°å¿†</div>
  <div class="ni" data-p="p-set"><div class="ic">âš™ï¸</div>è®¾ç½®</div>
</div>
<div class="cam-box" id="camBox"><video id="camVid" autoplay muted playsinline></video><button class="cx" onclick="toggleCam()">âœ•</button><button class="flip" onclick="flipCam()">ğŸ”„</button></div>
<div class="toast" id="toast"></div>
<canvas id="fCvs" style="display:none"></canvas>

<script>
// ========== Config ==========
let C={key:localStorage.getItem('av_k')||'',wake:(localStorage.getItem('av_w')||'å°åŠ©æ‰‹,ä½ å¥½,å—¨').split(',').map(s=>s.trim()).filter(Boolean),turns:parseInt(localStorage.getItem('av_t')||'10'),voice:localStorage.getItem('av_v')||'Serena',sysCalendar:localStorage.getItem('av_syscal')!=='false',sysAlarm:localStorage.getItem('av_sysalm')!=='false'};
const BYE=['æ‹œæ‹œ','å¥½äº†','è°¢è°¢','å†è§','åœåœ','æ²¡äº‹äº†','å°±è¿™æ ·'];
const MODEL='qwen3-omni-flash-realtime-2025-12-01';

// ========== Memory (OpenClaw) ==========
class Mem{
  constructor(){this.st=[];this.dl={};this.lt=[];this.rf=[];this.imp=new Map();this._load()}
  _save(){try{localStorage.setItem('av_m',JSON.stringify({st:this.st.slice(-100),dl:this.dl,lt:this.lt.slice(-50),rf:this.rf.slice(-20)}))}catch{}}
  _load(){try{const d=JSON.parse(localStorage.getItem('av_m')||'null');if(d){this.st=d.st||[];this.dl=d.dl||{};this.lt=d.lt||[];this.rf=d.rf||[];[...this.st,...this.rf].forEach(m=>this.imp.set(m.t,m.i||5))}}catch{}}
  add(t,i=5){const n=new Date(),e={t,time:fD(n),ts:n.getTime(),i};this.st.push(e);this.imp.set(t,i);const k=n.toISOString().split('T')[0];if(!this.dl[k])this.dl[k]=[];this.dl[k].push(e);this._save()}
  addRef(t){const n=new Date(),e={t,time:fD(n),ts:n.getTime(),i:8};this.rf.push(e);this.lt.push(e);this.imp.set(t,8);this._save()}
  recent(n=10){return this.st.slice(-n)}
  longT(){return this.lt.slice(-10).map(m=>m.t)}
  today(){const k=new Date().toISOString().split('T')[0];return this.dl[k]||[]}
  needsFlush(){return this.st.length>20}
  compact(s){this.addRef(s);this.st=this.st.slice(-5);this._save()}
  stats(){return{o:this.st.length,d:Object.keys(this.dl).length,r:this.rf.length}}
  exportAll(){return JSON.stringify({stream:this.st,daily:this.dl,longTerm:this.lt,reflections:this.rf},null,2)}
}
function fD(d){const p=n=>String(n).padStart(2,'0');return`${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`}
const mem=new Mem();

// ========== State ==========
let ws=null,actx=null,mProc=null,mSrc=null,mStr=null;
let active=false,gate=false,aBuf=[],nxt=0,aSrcs=[];
let sess={on:false,t:0};
let camStr=null,frameInt=null,audioSent=false,facingBack=true;
let hasVid=false,talkU=null,pauseU=null,lastImg='';
let cards=JSON.parse(localStorage.getItem('av_c')||'[]');
let reminders=JSON.parse(localStorage.getItem('av_rem')||'[]');
let chatVis=false;

function saveReminders(){localStorage.setItem('av_rem',JSON.stringify(reminders))}
function cleanExpiredReminders(){const now=Date.now();reminders.forEach(r=>{if(r.timeMs<=now&&!r.done)r.done=true});saveReminders()}
// Check reminders every 30s and show in-app alert
setInterval(()=>{const now=Date.now();reminders.forEach(r=>{if(!r.fired&&!r.done&&r.timeMs<=now){r.fired=true;saveReminders();show('â° '+r.title);addC('sys','â° æé†’æ—¶é—´åˆ°: '+r.title);if(window.NativeBridge)try{window.NativeBridge.vibrate(500)}catch(e){}}})},15000);

// ========== Nav ==========
document.querySelectorAll('.ni').forEach(n=>{n.onclick=()=>{
  document.querySelectorAll('.ni').forEach(x=>x.classList.remove('on'));
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('on'));
  n.classList.add('on');document.getElementById(n.dataset.p).classList.add('on');
  if(n.dataset.p==='p-mem')renderMem();if(n.dataset.p==='p-cards')renderCards();if(n.dataset.p==='p-rem')renderReminders();
}});

// ========== Init ==========
window.addEventListener('load',()=>{
  if(C.key){document.getElementById('sKey').value=C.key;document.getElementById('micBtn').disabled=false;document.getElementById('stLine').textContent='å‡†å¤‡å°±ç»ª'}
  document.getElementById('sWake').value=C.wake.join(',');
  document.getElementById('sTurns').value=C.turns;
  document.getElementById('sVoice').value=C.voice;
  document.getElementById('sSysCal').checked=C.sysCalendar;
  document.getElementById('sSysAlarm').checked=C.sysAlarm;
  renderCards();cleanExpiredReminders();updateScreenSize();
  // Auto-load bundled videos
  const vI=document.getElementById('vI'),vT=document.getElementById('vT');
  vI.src='pause.mp4';vT.src='talk.mp4';
  vI.oncanplay=()=>{hasVid=true;pauseU='pause.mp4';talkU='talk.mp4';document.getElementById('avPh').style.display='none';vI.style.display='block';vI.play().catch(()=>{});document.getElementById('vidSt').textContent='âœ“ å†…ç½®è§†é¢‘'};
});

// ========== Settings (live apply) ==========
function saveCfg(){
  C.key=document.getElementById('sKey').value.trim();
  C.wake=document.getElementById('sWake').value.split(',').map(s=>s.trim()).filter(Boolean);
  C.turns=parseInt(document.getElementById('sTurns').value)||10;
  C.voice=document.getElementById('sVoice').value;
  C.sysCalendar=document.getElementById('sSysCal').checked;
  C.sysAlarm=document.getElementById('sSysAlarm').checked;
  localStorage.setItem('av_k',C.key);localStorage.setItem('av_w',C.wake.join(','));
  localStorage.setItem('av_t',C.turns);localStorage.setItem('av_v',C.voice);
  localStorage.setItem('av_syscal',C.sysCalendar);localStorage.setItem('av_sysalm',C.sysAlarm);
  document.getElementById('micBtn').disabled=!C.key;
  if(C.key)document.getElementById('stLine').textContent='å‡†å¤‡å°±ç»ª';
  if(ws&&ws.readyState===WebSocket.OPEN){
    ws.send(JSON.stringify({type:'session.update',session:{voice:C.voice,instructions:sysPr()}}));
    show('è®¾ç½®å·²ä¿å­˜å¹¶å®æ—¶ç”Ÿæ•ˆ');
  }else show('è®¾ç½®å·²ä¿å­˜');
}

// ========== Video ==========
function pickVid(){document.getElementById('vidIn').click()}
function onVidPick(e){for(const f of e.target.files){const u=URL.createObjectURL(f),n=f.name.toLowerCase();if(n.includes('talk')){talkU=u;document.getElementById('vT').src=u}else{pauseU=u;document.getElementById('vI').src=u}}
  if(pauseU){hasVid=true;document.getElementById('avPh').style.display='none';document.getElementById('vI').style.display='block';document.getElementById('vI').play().catch(()=>{});document.getElementById('vidSt').textContent='âœ“ å·²åŠ è½½'}}
function setAv(s){if(!hasVid){document.getElementById('avPh').textContent=s==='talk'?'ğŸ—£ï¸':'ğŸ¤–';return}const i=document.getElementById('vI'),t=document.getElementById('vT');if(s==='talk'&&talkU){i.style.display='none';i.pause();t.style.display='block';t.play().catch(()=>{})}else{t.style.display='none';t.pause();i.style.display='block';i.play().catch(()=>{})}}

// ========== Camera (from original ai_avatar.html logic) ==========
function toggleCam(){if(camStr)stopCam();else startCam()}
async function startCam(){
  try{
    camStr=await navigator.mediaDevices.getUserMedia({video:{facingMode:facingBack?'environment':'user',width:{ideal:640},height:{ideal:480}},audio:false});
    document.getElementById('camVid').srcObject=camStr;
    document.getElementById('camBox').classList.add('show');
    document.getElementById('btnCam').classList.add('on');
    document.getElementById('btnFlip').style.display='';
    frameInt=setInterval(sendFrame,500);
    addC('sys','ğŸ“¹ æ‘„åƒå¤´å·²æ‰“å¼€');mem.add('æ‰“å¼€äº†æ‘„åƒå¤´',5);
  }catch(e){show('æ‘„åƒå¤´å¤±è´¥: '+e.message)}
}
function stopCam(){
  if(frameInt){clearInterval(frameInt);frameInt=null}
  if(camStr){camStr.getTracks().forEach(t=>t.stop());camStr=null}
  document.getElementById('camVid').srcObject=null;
  document.getElementById('camBox').classList.remove('show');
  document.getElementById('btnCam').classList.remove('on');
  document.getElementById('btnFlip').style.display='none';
  addC('sys','ğŸ“¹ æ‘„åƒå¤´å·²å…³é—­');
}
async function flipCam(){
  facingBack=!facingBack;
  if(camStr){stopCam();await startCam()}
  // Mirror front camera
  document.getElementById('camVid').style.transform=facingBack?'none':'scaleX(-1)';
}

// Send video frame â€” EXACT same protocol as original ai_avatar.html
function sendFrame(){
  if(!ws||ws.readyState!==WebSocket.OPEN)return;
  if(!audioSent)return;
  const v=document.getElementById('camVid');
  if(!v.videoWidth||!v.videoHeight)return;
  try{
    const c=document.getElementById('fCvs'),x=c.getContext('2d');
    c.width=640;c.height=480;
    x.drawImage(v,0,0,640,480);
    let q=0.6,d=c.toDataURL('image/jpeg',q),b=d.split(',')[1];
    const mx=450*1024;
    while(b.length>mx&&q>0.2){q-=0.1;d=c.toDataURL('image/jpeg',q);b=d.split(',')[1]}
    ws.send(JSON.stringify({type:'input_image_buffer.append',image:b}));
  }catch(e){console.error('Frame err:',e)}
}

// ========== Screen Sharing (JS polls Native for frames) ==========
let screenSharing=false;
let screenPollTimer=null;
let _screenFrameCount=0;
let _debugVisible=false;

function toggleScreen(){if(screenSharing)stopScreen();else startScreen()}
function startScreen(){
  if(!window.NativeBridge){show('éœ€è¦ Android App');return}
  try{
    window.NativeBridge.startScreenCapture();
    screenSharing=true;
    document.getElementById('btnScreen').classList.add('on');
    addC('sys','ğŸ–¥ï¸ å±å¹•å…±äº«å·²è¯·æ±‚');
    // Start polling Native for frames every 500ms
    if(screenPollTimer)clearInterval(screenPollTimer);
    screenPollTimer=setInterval(pollScreenFrame,500);
  }catch(e){show('å¤±è´¥: '+e.message)}
}
function stopScreen(){
  if(screenPollTimer){clearInterval(screenPollTimer);screenPollTimer=null}
  if(window.NativeBridge)try{window.NativeBridge.stopScreenCapture()}catch(e){}
  screenSharing=false;
  document.getElementById('btnScreen').classList.remove('on');
  addC('sys','ğŸ–¥ï¸ å±å¹•å…±äº«å·²åœæ­¢');
}

// Poll: JS pulls frame from Native (reliable, no string injection issues)
let _pollCount=0;
function pollScreenFrame(){
  _pollCount++;
  if(_pollCount%20===1)dbg('poll #'+_pollCount+' sharing='+screenSharing+' bridge='+(!!window.NativeBridge));
  if(!window.NativeBridge||!screenSharing)return;
  try{
    const b64=window.NativeBridge.consumeScreenFrame();
    if(!b64||b64.length<100){if(_pollCount%20===1)dbg('poll: æ— å¸§');return}
    _screenFrameCount++;
    dbg(`ğŸ“¥ å¸§ #${_screenFrameCount} ${Math.round(b64.length/1024)}KB`);
    // Preview
    const img=document.getElementById('debugImg');
    if(img){img.src='data:image/jpeg;base64,'+b64;img.style.display='block'}
    // Send to Omni
    if(!ws||ws.readyState!==WebSocket.OPEN){dbg('âŒ wsæœªè¿æ¥');return}
    if(!audioSent){
      const silence=new Int16Array(1600);
      ws.send(JSON.stringify({type:'input_audio_buffer.append',audio:a2b(silence.buffer)}));
      audioSent=true;dbg('âš ï¸ å‘é€é™éŸ³åŒ…');
    }
    ws.send(JSON.stringify({type:'input_image_buffer.append',image:b64}));
    dbg(`âœ… å·²å‘é€ #${_screenFrameCount}`);
  }catch(e){dbg('âŒ poll err: '+e.message)}
}

function toggleDebug(){_debugVisible=!_debugVisible;document.getElementById('debugPanel').style.display=_debugVisible?'block':'none'}
function debugTestTap(){
  dbg('--- æµ‹è¯•ç‚¹å‡» ---');
  if(!window.NativeBridge){dbg('âŒ æ— NativeBridge');return}
  dbg('æ— éšœç¢: '+window.NativeBridge.isAccessibilityEnabled());
  if(!window.NativeBridge.isAccessibilityEnabled()){dbg('âŒ è¯·å…ˆå¼€å¯æ— éšœç¢æœåŠ¡');return}
  window.NativeBridge.tap(240,400);
  setTimeout(()=>dbg('ç»“æœ: '+window.NativeBridge.getTouchResult()),500);
}
function debugShowElements(){
  dbg('--- å±å¹•å…ƒç´  ---');
  if(!window.NativeBridge){dbg('âŒ æ— NativeBridge');return}
  const el=window.NativeBridge.getScreenElements();
  el.split('\n').slice(0,15).forEach(l=>dbg(l));
  if(el.split('\n').length>15)dbg('...(å…±'+el.split('\n').length+'ä¸ªå…ƒç´ )');
}
function dbg(msg){const el=document.getElementById('debugLog');if(!el)return;const t=new Date().toLocaleTimeString();el.innerHTML=`[${t}] ${msg}<br>`+el.innerHTML;if(el.innerHTML.length>3000)el.innerHTML=el.innerHTML.slice(0,2000)}

function debugTestFrame(){
  dbg('--- æ‰‹åŠ¨æ‹‰å¸§æµ‹è¯• ---');
  dbg('NativeBridgeå­˜åœ¨: '+(!!window.NativeBridge));
  if(!window.NativeBridge){dbg('âŒ NativeBridgeä¸å­˜åœ¨ï¼');return}
  dbg('isScreenCapturing: '+window.NativeBridge.isScreenCapturing());
  const b64=window.NativeBridge.getScreenFrame();
  dbg('getScreenFrameè¿”å›: '+(b64?b64.length+'å­—ç¬¦':'ç©º'));
  if(b64&&b64.length>100){
    dbg('âœ… æ‹¿åˆ°å¸§ï¼ '+Math.round(b64.length/1024)+'KB');
    document.getElementById('debugImg').src='data:image/jpeg;base64,'+b64;
    document.getElementById('debugImg').style.display='block';
  }else{
    dbg('âŒ æ²¡æœ‰å¸§æ•°æ®');
  }
}

function debugCheckState(){
  dbg('--- çŠ¶æ€æ£€æŸ¥ ---');
  dbg('screenSharing: '+screenSharing);
  dbg('screenPollTimer: '+(screenPollTimer?'è¿è¡Œä¸­':'æœªå¯åŠ¨'));
  dbg('ws: '+(ws?'å­˜åœ¨ readyState='+ws.readyState:'null'));
  dbg('audioSent: '+audioSent);
  dbg('active(ä¼šè¯): '+active);
  dbg('NativeBridge: '+(!!window.NativeBridge));
    if(window.NativeBridge){
    dbg('isScreenCapturing: '+window.NativeBridge.isScreenCapturing());
    dbg('JS frameCount: '+_screenFrameCount);
    try{dbg('ğŸ“± Screen: '+window.NativeBridge.getScreenDebug())}catch(e){}
    try{dbg('ğŸ”Š Wake: '+window.NativeBridge.getWakeWordDebug())}catch(e){}
  }
}

// ========== Image Upload â†’ input_image_buffer.append ==========
function uploadImg(){document.getElementById('imgIn').click()}
function onImgPick(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=(ev)=>{
    addC('user','[ğŸ–¼ï¸ '+f.name+']');mem.add('ä¸Šä¼ å›¾ç‰‡: '+f.name,6);
    const img=new Image();
    img.onload=()=>{
      const c=document.getElementById('fCvs'),x=c.getContext('2d');
      c.width=640;c.height=480;
      const sc=Math.min(640/img.width,480/img.height),w=img.width*sc,h=img.height*sc;
      x.fillStyle='#000';x.fillRect(0,0,640,480);
      x.drawImage(img,(640-w)/2,(480-h)/2,w,h);
      const b=c.toDataURL('image/jpeg',0.7).split(',')[1];
      if(ws&&ws.readyState===WebSocket.OPEN&&audioSent){
        // Send image frame multiple times (3s at 2fps) so Omni can "see" it
        addC('sys','ğŸ–¼ï¸ æ­£åœ¨å±•ç¤ºå›¾ç‰‡ç»™ AIï¼ˆ3ç§’ï¼‰...');
        let sent=0;
        const imgInt=setInterval(()=>{
          if(!ws||ws.readyState!==WebSocket.OPEN||sent>=6){clearInterval(imgInt);return}
          ws.send(JSON.stringify({type:'input_image_buffer.append',image:b}));sent++;
        },500);
        setTimeout(()=>{
          clearInterval(imgInt);
          ws.send(JSON.stringify({type:'conversation.item.create',item:{type:'message',role:'user',content:[{type:'input_text',text:'æˆ‘åˆšç»™ä½ çœ‹äº†ä¸€å¼ å›¾ç‰‡ï¼Œè¯·æè¿°ä½ çœ‹åˆ°äº†ä»€ä¹ˆã€‚'}]}}));
          ws.send(JSON.stringify({type:'response.create'}));
          addC('sys','ğŸ–¼ï¸ å›¾ç‰‡å±•ç¤ºå®Œæ¯•ï¼Œç­‰å¾… AI å›å¤');
        },3500);
      }else{
        fbImg(ev.target.result.split(',')[1]);
      }
    };
    img.src=ev.target.result;
  };
  r.readAsDataURL(f);e.target.value='';
}
async function fbImg(b64){
  addC('sys','ğŸ” åˆ†æä¸­...');
  try{
    const r=await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+C.key},body:JSON.stringify({model:'qwen3.5-plus',messages:[{role:'user',content:[{type:'image_url',image_url:{url:'data:image/jpeg;base64,'+b64}},{type:'text',text:'æè¿°å›¾ç‰‡å†…å®¹ã€‚'}]}],max_tokens:300})});
    const d=await r.json();const desc=d.choices?.[0]?.message?.content||'æ— æ³•è¯†åˆ«';
    addC('ai',desc);mem.add('å›¾ç‰‡: '+desc,7);lastImg=desc;
  }catch(e){addC('sys','å¤±è´¥: '+e.message)}
}

// ========== Session ==========
function actSess(){sess.on=true;sess.t=C.turns;updBadge()}
function deactSess(){sess.on=false;sess.t=0;gate=false;updBadge()}
function consTurn(){if(sess.t>0){sess.t--;updBadge();if(sess.t<=0)deactSess()}}
function updBadge(){const b=document.getElementById('badge');if(sess.on){b.className='badge on';b.textContent='ğŸŸ¢ æ¿€æ´» ('+sess.t+'è½®)'}else{b.className='badge off';b.textContent='âšª ç›‘å¬ä¸­'}}
function shouldResp(t){if(BYE.some(w=>t.includes(w)))return{r:true,bye:true};if(C.wake.some(w=>t.includes(w))){actSess();return{r:true,wk:true}}if(sess.on)return{r:true};return{r:false}}

// ========== Chat ==========
function toggleChat(){chatVis=!chatVis;document.getElementById('chatEl').style.display=chatVis?'block':'none'}
function addC(role,t){const el=document.getElementById('chatEl'),d=document.createElement('div');d.className='cm '+role;d.textContent=(role==='user'?'ğŸ§‘ ':role==='ai'?'ğŸ¤– ':'')+t;el.appendChild(d);el.scrollTop=el.scrollHeight;while(el.children.length>40)el.removeChild(el.firstChild)}

// ========== System Prompt ==========
function sysPr(){
  const s=mem.recent(15).map(m=>'['+m.time+'] '+m.t).join('\n');
  const l=mem.longT().join('\n');
  const td=mem.today().map(m=>'['+m.time+'] '+m.t).join('\n');
  const now=new Date();
  const weekdays=['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];
  const timeStr=`${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${weekdays[now.getDay()]} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  const pendingRem=reminders.filter(r=>!r.done&&r.timeMs>Date.now()).sort((a,b)=>a.timeMs-b.timeMs).map(r=>{
    const d=new Date(r.timeMs);const diff=r.timeMs-Date.now();
    let rel='';if(diff<3600000)rel=Math.floor(diff/60000)+'åˆ†é’Ÿå';else if(diff<86400000)rel=Math.floor(diff/3600000)+'å°æ—¶å';else rel=Math.floor(diff/86400000)+'å¤©å';
    return`- ${r.title}ï¼ˆ${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}ï¼Œ${rel}ï¼‰`
  }).join('\n');
  return`ä½ æ˜¯AIåŠ©ç†"å°åŠ©æ‰‹"ã€‚

### å½“å‰æ—¶é—´ ###
${timeStr}

### æ ¸å¿ƒæŒ‡ä»¤ ###
1. æœªè¢«å”¤é†’æ—¶ä¿æŒå®‰é™ã€‚
2. è¢«å”¤é†’åç®€çŸ­å›ç­”ï¼ˆ30å­—å†…ï¼‰ã€‚
3. å”¤é†’åä¿æŒ${C.turns}è½®å¯¹è¯ã€‚
4. ç”¨æˆ·æ‰“å¼€äº†æ‘„åƒå¤´æˆ–å‘äº†å›¾ç‰‡æ—¶ï¼Œä¸»åŠ¨æè¿°ä½ çœ‹åˆ°çš„å†…å®¹ã€‚
5. ä½ çŸ¥é“å½“å‰å‡†ç¡®æ—¶é—´ï¼Œç”¨æˆ·é—®å‡ ç‚¹äº†ç›´æ¥å›ç­”ã€‚

### å”¤é†’è¯ ###
${JSON.stringify(C.wake)}

### å¾…åŠæé†’ ###
${pendingRem||'æš‚æ— å¾…åŠ'}

### ä»Šæ—¥å¯¹è¯ ###
${td||'æš‚æ— '}

### çŸ­æœŸè®°å¿† ###
${s||'æš‚æ— '}

### é•¿æœŸè®°å¿† ###
${l||'æš‚æ— '}
${lastImg?'\n### æœ€è¿‘å›¾ç‰‡ ###\n'+lastImg:''}

### è§„åˆ™ ###
- é—®"å‡ ç‚¹äº†"â†’ç›´æ¥å›ç­”æ—¶é—´
- é—®"åˆšæ‰è¯´äº†ä»€ä¹ˆ"â†’å‚è€ƒè®°å¿†
- çœ‹åˆ°æ‘„åƒå¤´ç”»é¢â†’ç®€çŸ­æè¿°
- è®¾æé†’â†’ç¡®è®¤"å¥½çš„ï¼Œè®¾äº†Xç‚¹æé†’"
- é—®"æœ‰ä»€ä¹ˆæé†’"â†’æ’­æŠ¥å¾…åŠ
- è§¦æ§æŒ‡ä»¤ï¼ˆç‚¹å‡»/æ»‘åŠ¨/è¿”å›ï¼‰â†’åªè¯´"å¥½çš„"ä¸¤ä¸ªå­—ï¼Œä¸è¦è§£é‡Šèƒ½ä¸èƒ½åšåˆ°ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ‰§è¡Œ
- å±å¹•æ“ä½œç›¸å…³â†’æç®€å›åº”ï¼Œä¸è¦è¯´"æˆ‘æ— æ³•"/"æˆ‘ä¸èƒ½"ï¼Œæ“ä½œå·²ç”±ç³»ç»Ÿå¤„ç†
- "è‡ªå·±ç©"/"å¸®æˆ‘ç©"â†’è¯´"å¼€å§‹äº†"ï¼Œä¸åºŸè¯
- "åœæ­¢è‡ªåŠ¨"â†’è¯´"åœäº†"
- é—®å€™â†’ä¸€å¥è¯
- å‘Šåˆ«â†’æ¸©æš–å‘Šåˆ«
- å…¶ä»–â†’ç®€çŸ­ä¸“ä¸šï¼ˆ15å­—å†…ï¼‰`;
}

// ========== WebSocket (EXACT same as original ai_avatar.html) ==========
async function toggleSession(){if(active)stopSess();else await startSess()}
async function startSess(){
  if(!C.key){show('è¯·å…ˆè®¾ç½® API Key');return}
  try{
    if(!actx)actx=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24000});
    else if(actx.state==='suspended')await actx.resume();
    mStr=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16000,channelCount:1,echoCancellation:true,noiseSuppression:true}});
    mSrc=actx.createMediaStreamSource(mStr);
    mProc=actx.createScriptProcessor(4096,1,1);
    mSrc.connect(mProc);mProc.connect(actx.destination);
    const url=`wss://dashscope.aliyuncs.com/api-ws/v1/realtime?model=${MODEL}&api_key=${C.key}`;
    document.getElementById('stLine').textContent='è¿æ¥ä¸­...';
    ws=new WebSocket(url);
    ws.binaryType='arraybuffer'; // CRITICAL: must match original

    ws.onopen=()=>{
      ws.send(JSON.stringify({type:'session.update',session:{modalities:['audio','text'],voice:C.voice,instructions:sysPr(),input_audio_format:'pcm16',output_audio_format:'pcm16',turn_detection:{type:'server_vad'},input_audio_transcription:{model:'qwen3-asr-flash-realtime'}}}));
      active=true;
      document.getElementById('micBtn').classList.add('rec');
      document.getElementById('micBtn').textContent='â¹ï¸';
      document.getElementById('stLine').textContent='ğŸ‘‚ ç›‘å¬ä¸­';
      updBadge();setAv('idle');
      if(window.NativeBridge)try{window.NativeBridge.startKeepAlive()}catch(e){}
      // Refresh system prompt every 60s so AI has current time
      if(window._sysRefresh)clearInterval(window._sysRefresh);
      window._sysRefresh=setInterval(()=>{if(ws&&ws.readyState===WebSocket.OPEN)ws.send(JSON.stringify({type:'session.update',session:{instructions:sysPr()}}))},60000);

      mProc.onaudioprocess=(e)=>{
        if(!ws||ws.readyState!==WebSocket.OPEN)return;
        const inp=e.inputBuffer.getChannelData(0);
        const ratio=actx.sampleRate/16000;
        const len=Math.floor(inp.length/ratio);
        const i16=new Int16Array(len);
        for(let i=0;i<len;i++){const s=Math.max(-1,Math.min(1,inp[Math.floor(i*ratio)]));i16[i]=s<0?s*0x8000:s*0x7FFF}
        ws.send(JSON.stringify({type:'input_audio_buffer.append',audio:a2b(i16.buffer)}));
        audioSent=true;
      };
    };
    ws.onmessage=async(ev)=>{
      if(typeof ev.data==='string'){try{await onMsg(JSON.parse(ev.data))}catch{}}
      else{if(gate)playC(ev.data)}
    };
    ws.onerror=()=>{document.getElementById('stLine').textContent='âŒ è¿æ¥é”™è¯¯'};
    ws.onclose=()=>{if(active)stopSess()};
  }catch(e){document.getElementById('stLine').textContent='âŒ '+e.message}
}

async function onMsg(m){
  const t=m.type||'';
  if(t==='input_audio_buffer.speech_started'){clrA();aBuf=[];gate=false}
  else if(t==='conversation.item.input_audio_transcription.completed'){
    const txt=(m.transcript||'').trim();if(!txt)return;
    mem.add('ç”¨æˆ·: '+txt,5);
    const d=shouldResp(txt);
    if(d.r){addC('user',txt);gate=true;checkReminder(txt);handleTouchCommand(txt);if(d.bye){addC('sys','ğŸ‘‹ å†è§');setTimeout(deactSess,1000)}else if(!d.wk)consTurn();aBuf.forEach(c=>playC(c));aBuf=[]}
    else{addC('sys','[ç›‘å¬] '+txt);aBuf=[]}
  }
  else if(t==='response.audio_transcript.done'){
    const txt=(m.transcript||'').trim();
    if(txt&&gate){addC('ai',txt);mem.add('AI: '+txt,5)}
    if(mem.needsFlush())autoFlush();
  }
  else if(t==='response.audio.delta'){
    if(m.delta){const ab=b2a(m.delta);if(gate)playC(ab);else aBuf.push(ab)}
  }
}

function stopSess(){
  active=false;deactSess();clrA();setAv('idle');stopCam();stopScreen();stopAutoPlay();audioSent=false;
  if(window._sysRefresh){clearInterval(window._sysRefresh);window._sysRefresh=null}
  if(window.NativeBridge)try{window.NativeBridge.stopKeepAlive()}catch(e){}
  if(ws){ws.onclose=null;ws.close();ws=null}
  if(mProc){mProc.onaudioprocess=null;mProc.disconnect();mProc=null}
  if(mSrc){mSrc.disconnect();mSrc=null}
  if(mStr){mStr.getTracks().forEach(t=>t.stop());mStr=null}
  document.getElementById('micBtn').classList.remove('rec');
  document.getElementById('micBtn').textContent='ğŸ¤';
  document.getElementById('stLine').textContent='å·²åœæ­¢';
  // Restart wake word listening if it was enabled
  if(wakeServiceOn||document.getElementById('btnWake').classList.contains('on')){
    setTimeout(()=>{
      dbg('ğŸ”Š Omniæ–­å¼€ï¼Œæ¢å¤åå°å”¤é†’');
      startWakeService();
    },1000);
  }
}

// ========== Audio ==========
function clrA(){aSrcs.forEach(s=>{try{s.stop()}catch{}});aSrcs=[];if(actx)nxt=actx.currentTime;setAv('idle')}
function playC(ab){
  if(!actx||!ab||ab.byteLength===0)return;
  try{const i=new Int16Array(ab),f=new Float32Array(i.length);for(let j=0;j<i.length;j++)f[j]=i[j]/32768;
  const buf=actx.createBuffer(1,f.length,24000);buf.getChannelData(0).set(f);
  const src=actx.createBufferSource();src.buffer=buf;src.connect(actx.destination);
  if(nxt<actx.currentTime)nxt=actx.currentTime;src.start(nxt);nxt+=buf.duration;
  setAv('talk');aSrcs.push(src);
  src.onended=()=>{aSrcs=aSrcs.filter(s=>s!==src);if(aSrcs.length===0)setAv('idle')}}catch{}}

// ========== Calendar Reminder (A+C) ==========
let _remChecking=false; // prevent double trigger
async function checkReminder(text){
  if(_remChecking)return;
  const keywords=['æé†’','é—¹é’Ÿ','æ—¥å†','æ—¥ç¨‹','åˆ«å¿˜','å®šæ—¶'];
  if(!keywords.some(k=>text.includes(k)))return;
  _remChecking=true;
  setTimeout(()=>{_remChecking=false},5000); // cooldown 5s

  const now=new Date();
  const tzOff=-now.getTimezoneOffset();
  const tzH=Math.floor(Math.abs(tzOff)/60);const tzM=Math.abs(tzOff)%60;
  const tzStr=(tzOff>=0?'+':'-')+String(tzH).padStart(2,'0')+':'+String(tzM).padStart(2,'0');
  const localNow=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}T${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:00${tzStr}`;

  try{
    const resp=await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+C.key},body:JSON.stringify({model:'qwen-plus',messages:[{role:'user',content:`ä»æ–‡å­—ä¸­æå–æé†’ä¿¡æ¯ã€‚å¦‚æœä¸æ˜¯è®¾æé†’çš„æ„å›¾è¿”å›nullã€‚

æ–‡å­—ï¼š"${text}"

å½“å‰æœ¬åœ°æ—¶é—´ï¼š${localNow}
æ—¶åŒºï¼šUTC${tzStr}

é‡è¦ï¼š
- "ä¸‹åˆ3ç‚¹"="15:00"ï¼Œ"ä¸Šåˆ9ç‚¹"="09:00"ï¼Œ"æ™šä¸Š8ç‚¹"="20:00"
- "æ˜å¤©"=å½“å‰æ—¥æœŸ+1å¤©
- "Xåˆ†é’Ÿå"=å½“å‰æ—¶é—´+Xåˆ†é’Ÿ
- è¿”å›çš„æ—¶é—´å¿…é¡»æ˜¯æœ¬åœ°æ—¶é—´ï¼Œæ ¼å¼ï¼šYYYY-MM-DDTHH:mm:00${tzStr}

å¦‚æœæ˜¯è®¾æé†’ï¼Œè¿”å›JSONï¼š{"title":"æé†’æ ‡é¢˜","time":"æœ¬åœ°ISOæ—¶é—´å¸¦æ—¶åŒº","minutes":60}
å¦‚æœä¸æ˜¯ï¼Œè¿”å›ï¼šnull
åªè¿”å›JSONã€‚`}],max_tokens:120})});
    const d=await resp.json();const raw=(d.choices?.[0]?.message?.content||'').trim().replace(/```json\n?/g,'').replace(/```/g,'').trim();
    if(!raw||raw==='null'||raw==='NULL')return;
    let info;try{info=JSON.parse(raw)}catch{return}
    if(!info||!info.title||!info.time)return;
    const timeMs=new Date(info.time).getTime();
    if(isNaN(timeMs)){addC('sys','âš ï¸ æ—¶é—´è§£æå¤±è´¥');return}
    if(timeMs<=Date.now()){addC('sys','âš ï¸ æé†’æ—¶é—´å·²è¿‡: '+new Date(timeMs).toLocaleString('zh-CN'));return}
    const remId=Math.floor(Math.random()*100000);
    // Save to local list
    reminders.push({id:remId,title:info.title,timeMs,time:info.time,created:fD(new Date()),done:false,fired:false});
    saveReminders();
    if(window.NativeBridge){
      // Always: schedule local notification with vibration + sound
      try{window.NativeBridge.scheduleNotification('â° '+info.title,'æ¥è‡ª AI Avatar çš„æé†’',timeMs,remId)}catch(e){}
      try{window.NativeBridge.vibrate(200)}catch(e){} // confirm vibrate
      // Optional: system calendar
      if(C.sysCalendar){try{window.NativeBridge.openCalendarEvent(info.title,text,timeMs,info.minutes||60)}catch(e){}}
      // Optional: system alarm clock
      if(C.sysAlarm){
        const t=new Date(timeMs);
        try{window.NativeBridge.setAlarm(t.getHours(),t.getMinutes(),info.title)}catch(e){}
      }
    }
    mem.add('è®¾ç½®æé†’: '+info.title+' @ '+new Date(timeMs).toLocaleString('zh-CN'),7);
    addC('sys','â° æé†’å·²åˆ›å»º: '+info.title+' ('+new Date(timeMs).toLocaleString('zh-CN')+')');
    show('â° æé†’å·²è®¾ç½®');
    renderReminders();
  }catch(e){console.error('Reminder err:',e);_remChecking=false}
}

// ========== Memory flush ==========
async function autoFlush(){
  const r=mem.recent(20).map(m=>m.t).join('\n');
  try{const resp=await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+C.key},body:JSON.stringify({model:'qwen-plus',messages:[{role:'user',content:'æ€»ç»“è¦ç‚¹ï¼ˆ50å­—å†…ï¼‰ï¼š\n'+r}],max_tokens:100})});
  const d=await resp.json();const s=d.choices?.[0]?.message?.content?.trim();if(s)mem.compact(s)}catch{}}
async function manualFlush(){show('æ€»ç»“ä¸­...');await autoFlush();renderMem();show('è®°å¿†å·²æ›´æ–°')}
function exportMem(){const b=new Blob([mem.exportAll()],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='memory_'+new Date().toISOString().split('T')[0]+'.json';a.click();URL.revokeObjectURL(u);show('å·²å¯¼å‡º')}

// ========== Render Memory ==========
function renderMem(){
  const r=mem.recent(8);document.getElementById('sMem').innerHTML=r.length?r.map(m=>'<div class="me"><span class="mt">'+m.time+'</span> '+m.t+'</div>').join(''):'æš‚æ— ';
  const l=mem.longT();document.getElementById('lMem').innerHTML=l.length?l.map(t=>'<div class="me">'+t+'</div>').join(''):'æš‚æ— ';
  const rf=mem.rf.slice(-5);document.getElementById('rMem').innerHTML=rf.length?rf.map(m=>'<div class="me"><span class="mt">'+m.time+'</span> '+m.t+'</div>').join(''):'æš‚æ— ';
  const s=mem.stats();document.getElementById('msO').textContent=s.o;document.getElementById('msD').textContent=s.d;document.getElementById('msR').textContent=s.r;
}

// ========== Cards ==========
async function genCard(){
  const r=mem.recent(15).map(m=>m.t).join('\n');const l=mem.longT().join('\n');
  if(!r&&!l){show('æš‚æ— å†…å®¹');return}show('ç”Ÿæˆä¸­...');
  try{const resp=await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+C.key},body:JSON.stringify({model:'qwen-plus',messages:[{role:'user',content:'æ ¹æ®å¯¹è¯ç”Ÿæˆå¡ç‰‡JSONï¼š{"title":"æ ‡é¢˜","body":"è¦ç‚¹100å­—å†…","tags":["æ ‡ç­¾"]}\n\n'+r+'\n\né•¿æœŸï¼š\n'+(l||'æ— ')+(lastImg?'\nå›¾ç‰‡ï¼š'+lastImg:'')}],max_tokens:200})});
  const d=await resp.json();const raw=d.choices?.[0]?.message?.content?.trim();
  const p=JSON.parse(raw.replace(/```json\n?/g,'').replace(/```/g,''));
  cards.unshift({id:Date.now(),time:fD(new Date()),title:p.title||'å¡ç‰‡',body:p.body||'',tags:p.tags||[]});
  localStorage.setItem('av_c',JSON.stringify(cards));renderCards();show('å¡ç‰‡å·²ç”Ÿæˆ')}catch(e){show('å¤±è´¥: '+e.message)}}
function renderCards(){const g=document.getElementById('cGrid');g.innerHTML=cards.length?cards.map(c=>'<div class="ci" oncontextmenu="shareCard(event,'+c.id+')" ontouchstart="cardTouchStart(event,'+c.id+')" ontouchend="cardTouchEnd(event)"><div class="ct">'+c.time+'</div><div class="ch">'+c.title+'</div><div class="cb">'+c.body+'</div><div class="tags">'+(c.tags||[]).map(t=>'<span class="tag">'+t+'</span>').join('')+'</div><div class="ca"><button onclick="saveCard('+c.id+')">ğŸ’¾ ä¿å­˜</button><button onclick="shareCard(null,'+c.id+')">ğŸ“¤ åˆ†äº«</button><button onclick="delCard('+c.id+')">ğŸ—‘ï¸</button></div></div>').join(''):'<div style="color:var(--text3);text-align:center;padding:40px;font-size:13px">å¯¹è¯åç‚¹å‡»ç”Ÿæˆå¡ç‰‡</div>'}
function delCard(id){cards=cards.filter(c=>c.id!==id);localStorage.setItem('av_c',JSON.stringify(cards));renderCards()}
function clearCards(){cards=[];localStorage.setItem('av_c','[]');renderCards();show('å·²æ¸…ç©º')}
function renderCardImage(c){
  const cv=document.getElementById('fCvs'),x=cv.getContext('2d');cv.width=600;cv.height=400;
  const g=x.createLinearGradient(0,0,600,400);g.addColorStop(0,'#0c0f1a');g.addColorStop(1,'#151a2e');x.fillStyle=g;x.fillRect(0,0,600,400);
  // Accent bar
  const ag=x.createLinearGradient(0,0,0,400);ag.addColorStop(0,'#7b8cff');ag.addColorStop(1,'#a78bfa');x.fillStyle=ag;x.fillRect(0,0,4,400);
  // Title
  x.fillStyle='#f0f2f8';x.font='bold 22px system-ui';x.fillText(c.title,24,48);
  // Time
  x.fillStyle='#7c8497';x.font='12px system-ui';x.fillText(c.time,24,72);
  // Body
  x.fillStyle='#c0c8d8';x.font='15px system-ui';const lines=wrapT(x,c.body,550);lines.forEach((l,i)=>x.fillText(l,24,105+i*24));
  // Tags
  const ty=105+lines.length*24+16;let tx=24;
  (c.tags||[]).forEach(tag=>{const tw=x.measureText(tag).width+18;x.fillStyle='rgba(123,140,255,.15)';x.beginPath();x.roundRect(tx,ty-12,tw,24,12);x.fill();x.fillStyle='#7b8cff';x.font='12px system-ui';x.fillText(tag,tx+9,ty+4);tx+=tw+8});
  // Watermark
  x.fillStyle='#3d4355';x.font='10px system-ui';x.fillText('AI Avatar Â· '+new Date().toLocaleDateString(),24,385);
  return cv.toDataURL('image/png');
}
function saveCard(id){
  const c=cards.find(x=>x.id===id);if(!c)return;
  const dataUrl=renderCardImage(c);
  const b64=dataUrl.split(',')[1];
  if(window.NativeBridge){
    try{window.NativeBridge.saveImageToGallery(b64,'card_'+c.id+'.png');return}catch(e){}
  }
  // Fallback for browser
  const a=document.createElement('a');a.href=dataUrl;a.download='card_'+c.id+'.png';document.body.appendChild(a);a.click();document.body.removeChild(a);show('å·²ä¿å­˜');
}
function shareCard(e,id){
  if(e)e.preventDefault();
  const c=cards.find(x=>x.id===id);if(!c)return;
  const dataUrl=renderCardImage(c);
  const b64=dataUrl.split(',')[1];
  if(window.NativeBridge){
    try{window.NativeBridge.shareImage(b64,c.title);return}catch(e2){}}
  // Fallback: try Web Share API
  if(navigator.share){
    fetch(dataUrl).then(r=>r.blob()).then(blob=>{
      const file=new File([blob],'card.png',{type:'image/png'});
      navigator.share({title:c.title,files:[file]}).catch(()=>{});
    });
  }else show('è¯·ä½¿ç”¨ Android App åˆ†äº«');
}
// Long press on card
let cardLongTimer=null;
function cardTouchStart(e,id){cardLongTimer=setTimeout(()=>shareCard(e,id),600)}
function cardTouchEnd(e){if(cardLongTimer){clearTimeout(cardLongTimer);cardLongTimer=null}}
function wrapT(x,t,w){const ls=[];let l='';for(const c of t){if(x.measureText(l+c).width>w){ls.push(l);l=c}else l+=c}if(l)ls.push(l);return ls.slice(0,8)}

// ========== Reminders UI ==========
function renderReminders(){
  cleanExpiredReminders();
  const pending=reminders.filter(r=>!r.done).sort((a,b)=>a.timeMs-b.timeMs);
  const done=reminders.filter(r=>r.done).sort((a,b)=>b.timeMs-a.timeMs).slice(0,10);
  const now=Date.now();

  document.getElementById('remPending').innerHTML=pending.length?pending.map(r=>{
    const diff=r.timeMs-now;
    const isOverdue=diff<=0;
    let countdown='';
    if(isOverdue){countdown='<span class="rem-overdue">å·²åˆ°æ—¶é—´</span>'}
    else if(diff<3600000){countdown=Math.floor(diff/60000)+'åˆ†é’Ÿå'}
    else if(diff<86400000){countdown=Math.floor(diff/3600000)+'å°æ—¶'+Math.floor((diff%3600000)/60000)+'åˆ†å'}
    else{countdown=Math.floor(diff/86400000)+'å¤©å'}
    return`<div class="rem-item"><button class="rem-check" onclick="toggleRemDone(${r.id})"></button><div class="rem-info"><div class="rem-title">${r.title}</div><div class="rem-time">ğŸ“… ${new Date(r.timeMs).toLocaleString('zh-CN')}</div><div class="rem-countdown">${countdown}</div><div class="rem-created">åˆ›å»ºäº ${r.created}</div></div><button class="rem-del" onclick="delReminder(${r.id})">âœ•</button></div>`
  }).join(''):'<div style="color:var(--text3);text-align:center;padding:30px;font-size:13px">æš‚æ— å¾…åŠæé†’<br><span style="font-size:11px">å¯¹ AI è¯´"å¸®æˆ‘è®¾ä¸ªæé†’"æˆ–æ‰‹åŠ¨æ·»åŠ </span></div>';

  document.getElementById('remDone').innerHTML=done.length?done.map(r=>`<div class="rem-item done"><button class="rem-check done" onclick="toggleRemDone(${r.id})">âœ“</button><div class="rem-info"><div class="rem-title" style="text-decoration:line-through">${r.title}</div><div class="rem-time">${new Date(r.timeMs).toLocaleString('zh-CN')}</div></div><button class="rem-del" onclick="delReminder(${r.id})">âœ•</button></div>`).join(''):'';
}
function toggleRemDone(id){const r=reminders.find(x=>x.id===id);if(r){r.done=!r.done;saveReminders();renderReminders()}}
function delReminder(id){reminders=reminders.filter(r=>r.id!==id);saveReminders();renderReminders()}
function clearDoneReminders(){reminders=reminders.filter(r=>!r.done);saveReminders();renderReminders();show('å·²æ¸…é™¤')}
function addManualReminder(){
  const title=prompt('æé†’å†…å®¹ï¼š');if(!title)return;
  const timeStr=prompt('æ—¶é—´ï¼ˆä¾‹ï¼š2026-02-17 15:00ï¼‰ï¼š');if(!timeStr)return;
  const timeMs=new Date(timeStr).getTime();
  if(isNaN(timeMs)||timeMs<=Date.now()){show('æ—¶é—´æ ¼å¼é”™è¯¯æˆ–å·²è¿‡');return}
  const remId=Math.floor(Math.random()*100000);
  reminders.push({id:remId,title,timeMs,time:timeStr,created:fD(new Date()),done:false,fired:false});
  saveReminders();
  if(window.NativeBridge){
    try{window.NativeBridge.scheduleNotification('â° '+title,'æ¥è‡ª AI Avatar çš„æé†’',timeMs,remId)}catch(e){}
    try{window.NativeBridge.vibrate(200)}catch(e){}
    if(C.sysCalendar){try{window.NativeBridge.openCalendarEvent(title,'',timeMs,60)}catch(e){}}
    if(C.sysAlarm){const t=new Date(timeMs);try{window.NativeBridge.setAlarm(t.getHours(),t.getMinutes(),title)}catch(e){}}
  }
  renderReminders();show('â° æé†’å·²æ·»åŠ ');
}

// ========== Accessibility Touch Control ==========
function openA11y(){if(window.NativeBridge)try{window.NativeBridge.openAccessibilitySettings()}catch(e){show('æ‰“å¼€å¤±è´¥')}}
function checkA11y(){
  if(!window.NativeBridge)return;
  const on=window.NativeBridge.isAccessibilityEnabled();
  const el=document.getElementById('a11yStatus');
  if(el)el.innerHTML=on?'<span style="color:var(--green)">âœ… æ— éšœç¢æœåŠ¡å·²å¼€å¯</span>':'<span style="color:var(--red)">âŒ æœªå¼€å¯</span>';
  return on;
}
setInterval(checkA11y,3000); // periodically check

// Parse user speech for touch commands
async function handleTouchCommand(text){
  if(!window.NativeBridge||!window.NativeBridge.isAccessibilityEnabled())return false;

  // Check for auto-play mode
  if(text.includes('è‡ªå·±ç©')||text.includes('è‡ªåŠ¨ç©')||text.includes('å¸®æˆ‘ç©')||text.includes('è‡ªåŠ¨æ“ä½œ')){startAutoPlay();return true}
  if(text.includes('åœæ­¢è‡ªåŠ¨')||text.includes('åœæ­¢ç©')||text.includes('åˆ«ç©äº†')){stopAutoPlay();return true}

  const touchWords=['ç‚¹å‡»','ç‚¹ä¸€ä¸‹','æŒ‰ä¸€ä¸‹','æ‰“å¼€','æ»‘åŠ¨','å¾€ä¸Šæ»‘','å¾€ä¸‹æ»‘','å‘ä¸Šæ»‘','å‘ä¸‹æ»‘','å·¦æ»‘','å³æ»‘','è¿”å›','å›åˆ°ä¸»é¡µ','ä¸»é¡µ','ä¸Šæ»‘','ä¸‹æ»‘'];
  if(!touchWords.some(w=>text.includes(w)))return false;

  dbg('ğŸ–ï¸ è§¦æ§: '+text);

  updateScreenSize();
  // Direct commands (use relative coords â†’ actual pixels)
  if(text.includes('è¿”å›')){window.NativeBridge.pressBack();dbg('ğŸ–ï¸ '+window.NativeBridge.getTouchResult());return true}
  if(text.includes('ä¸»é¡µ')){window.NativeBridge.pressHome();dbg('ğŸ–ï¸ '+window.NativeBridge.getTouchResult());return true}
  if(text.includes('ä¸‹æ»‘')){bboxSwipe(500,650,500,250);dbg('ğŸ–ï¸ '+window.NativeBridge.getTouchResult());return true}
  if(text.includes('ä¸Šæ»‘')){bboxSwipe(500,250,500,650);dbg('ğŸ–ï¸ '+window.NativeBridge.getTouchResult());return true}
  if(text.includes('å·¦æ»‘')){bboxSwipe(750,500,150,500);dbg('ğŸ–ï¸ '+window.NativeBridge.getTouchResult());return true}
  if(text.includes('å³æ»‘')){bboxSwipe(150,500,750,500);dbg('ğŸ–ï¸ '+window.NativeBridge.getTouchResult());return true}

  // AI-assisted tap
  await aiTouchExecute(text);
  return true;
}

// ---- Screen size + bboxâ†’pixel conversion ----
let _screenW=1080,_screenH=2400;
function updateScreenSize(){
  if(!window.NativeBridge)return;
  try{const s=window.NativeBridge.getScreenSize().split(',');_screenW=parseInt(s[0])||1080;_screenH=parseInt(s[1])||2400;dbg('ğŸ“ å±å¹•: '+_screenW+'x'+_screenH)}catch(e){}
}
// Convert bbox [left,top,right,bottom] (0-1000 relative) to pixel center
function bboxCenterToPixel(bbox){
  // bbox = [left, top, right, bottom] all in 0-1000
  if(bbox.length===4){
    const cx=(bbox[0]+bbox[2])/2;
    const cy=(bbox[1]+bbox[3])/2;
    return[Math.round(cx/1000*_screenW),Math.round(cy/1000*_screenH)];
  }
  // Fallback: [x,y] center point in 0-1000
  if(bbox.length===2){
    return[Math.round(bbox[0]/1000*_screenW),Math.round(bbox[1]/1000*_screenH)];
  }
  return[Math.round(_screenW/2),Math.round(_screenH/2)];
}
// Legacy 2-point convenience
function bboxToPixel(bx,by){return bboxCenterToPixel([bx,by])}

function clamp(v,min,max){return Math.max(min,Math.min(max,v))}

function safeTap(x,y){
  x=clamp(Math.abs(Math.round(x)),1,_screenW-1);
  y=clamp(Math.abs(Math.round(y)),1,_screenH-1);
  dbg('ğŸ–ï¸ tap('+x+','+y+') å±å¹•'+_screenW+'x'+_screenH);
  window.NativeBridge.tap(x,y);
  setTimeout(()=>dbg('ğŸ–ï¸ '+window.NativeBridge.getTouchResult()),300);
}
function safeSwipe(x1,y1,x2,y2){
  x1=clamp(Math.abs(Math.round(x1)),1,_screenW-1);
  y1=clamp(Math.abs(Math.round(y1)),1,_screenH-1);
  x2=clamp(Math.abs(Math.round(x2)),1,_screenW-1);
  y2=clamp(Math.abs(Math.round(y2)),1,_screenH-1);
  window.NativeBridge.swipe(x1,y1,x2,y2);
  setTimeout(()=>dbg('ğŸ–ï¸ '+window.NativeBridge.getTouchResult()),300);
}
function bboxTap(bx,by){const[x,y]=bboxToPixel(bx,by);safeTap(x,y)}
function bboxSwipe(bx1,by1,bx2,by2){const[x1,y1]=bboxToPixel(bx1,by1);const[x2,y2]=bboxToPixel(bx2,by2);safeSwipe(x1,y1,x2,y2)}

// ========== Task Planner (multi-step) ==========
let taskPlan=null; // {goal, steps:[], currentStep:0, history:[]}

async function aiTouchExecute(text){
  updateScreenSize();
  // Check if this is a complex multi-step task
  const complexWords=['å‘å¾®ä¿¡','å‘æ¶ˆæ¯ç»™','æ‰“å¼€.*æœç´¢','å¸®æˆ‘è®¢','å¸®æˆ‘ä¹°','å¸®æˆ‘æœ','æµç¨‹','æ­¥éª¤'];
  const isComplex=complexWords.some(w=>new RegExp(w).test(text));

  if(isComplex){
    await startTaskPlan(text);
  }else{
    await singleStepExecute(text);
  }
}

async function singleStepExecute(text){
  const{screenB64,elements,model}=await getScreenContext();
  const hasVision=!!screenB64;
  const prompt=hasVision?
    `æ‰§è¡Œï¼š"${text}"\n${elements?'è¡¥å……å…ƒç´ ï¼š'+elements.slice(0,400):''}\n\nbboxåæ ‡[å·¦,ä¸Š,å³,ä¸‹]èŒƒå›´0-1000ã€‚è¿”å›JSONï¼š\n{"action":"tap","bbox":[å·¦,ä¸Š,å³,ä¸‹],"desc":"æè¿°"}\næˆ–æ»‘åŠ¨èµ·æ­¢ï¼š{"action":"swipe","bbox":[å·¦,ä¸Š,å³,ä¸‹],"bbox2":[å·¦,ä¸Š,å³,ä¸‹],"desc":"æè¿°"}`:
    `æ‰§è¡Œï¼š"${text}"\nå±å¹•${_screenW}x${_screenH}\nå…ƒç´ ï¼š\n${elements||'æ— '}\n\nè¿”å›JSONï¼ˆç”¨å…ƒç´ çš„åƒç´ åæ ‡ï¼‰ï¼š\n{"action":"tap","x":åƒç´ x,"y":åƒç´ y,"desc":"æè¿°"}\næˆ–ï¼š{"action":"swipe","x":x1,"y":y1,"x2":x2,"y2":y2,"desc":"æè¿°"}`;

  const sysPr=getTouchSysPrompt(hasVision);
  const messages=screenB64?[
    {role:'system',content:sysPr},
    {role:'user',content:[{type:'image_url',image_url:{url:'data:image/jpeg;base64,'+screenB64}},{type:'text',text:prompt}]}
  ]:[
    {role:'system',content:sysPr},
    {role:'user',content:prompt}
  ];

  dbg('ğŸ§  '+model+(screenB64?' +æˆªå›¾':''));
  const cmd=await callVisionAPI(model,messages);
  if(cmd)executeCmd(cmd);
}

async function startTaskPlan(goal){
  dbg('ğŸ“‹ è§„åˆ’ä»»åŠ¡: '+goal);addC('sys','ğŸ“‹ è§„åˆ’ä¸­: '+goal);
  const{screenB64,elements,model}=await getScreenContext();

  const planPrompt=`ç”¨æˆ·ç›®æ ‡ï¼š"${goal}"\n\n${elements?'å½“å‰å±å¹•å…ƒç´ ï¼š'+elements.slice(0,500):''}\n\nè¯·è§„åˆ’å®Œæˆæ­¤ç›®æ ‡çš„æ­¥éª¤ï¼ˆæœ€å¤š8æ­¥ï¼‰ï¼Œå¹¶æ‰§è¡Œç¬¬1æ­¥ã€‚\n\nè¿”å›JSONï¼š\n{"plan":["æ­¥éª¤1æè¿°","æ­¥éª¤2æè¿°",...],"step":1,"action":"tap"æˆ–"swipe","bbox":[x,y],"bbox2":[x2,y2],"desc":"å½“å‰æ‰§è¡Œä»€ä¹ˆ"}`;

  const pSys=getPlannerPrompt(!!screenB64);
  const messages=screenB64?[
    {role:'system',content:pSys},
    {role:'user',content:[{type:'image_url',image_url:{url:'data:image/jpeg;base64,'+screenB64}},{type:'text',text:planPrompt}]}
  ]:[
    {role:'system',content:pSys},
    {role:'user',content:planPrompt}
  ];

  const cmd=await callVisionAPI(model,messages);
  if(cmd&&cmd.plan){
    taskPlan={goal,steps:cmd.plan,currentStep:1,history:['æ­¥éª¤1: '+(cmd.desc||'')]};
    dbg('ğŸ“‹ è®¡åˆ’ '+cmd.plan.length+' æ­¥: '+cmd.plan.join(' â†’ '));
    addC('sys','ğŸ“‹ è®¡åˆ’: '+cmd.plan.join(' â†’ '));
    executeCmd(cmd);
    // Continue to next step after delay
    setTimeout(continueTaskPlan,2000);
  }else if(cmd){
    executeCmd(cmd);
  }
}

async function continueTaskPlan(){
  if(!taskPlan||taskPlan.currentStep>=taskPlan.steps.length)return;
  taskPlan.currentStep++;
  dbg('ğŸ“‹ æ­¥éª¤ '+taskPlan.currentStep+'/'+taskPlan.steps.length);

  const{screenB64,elements,model}=await getScreenContext();
  const stepPrompt=`ç›®æ ‡ï¼š"${taskPlan.goal}"\nè®¡åˆ’ï¼š${taskPlan.steps.join(' â†’ ')}\nå½“å‰ï¼šæ­¥éª¤${taskPlan.currentStep}/${taskPlan.steps.length} â€” "${taskPlan.steps[taskPlan.currentStep-1]}"\nå·²å®Œæˆï¼š${taskPlan.history.join('; ')}\n${elements?'å±å¹•å…ƒç´ ï¼š'+elements.slice(0,400):''}\n\næ‰§è¡Œå½“å‰æ­¥éª¤ã€‚bboxåæ ‡(0-1000)ï¼š\n{"action":"tap"æˆ–"swipe","bbox":[x,y],"bbox2":[x2,y2],"desc":"æè¿°","done":æ˜¯å¦å…¨éƒ¨å®Œæˆ}`;

  const pSys2=getPlannerPrompt(!!screenB64);
  const messages=screenB64?[
    {role:'system',content:pSys2},
    {role:'user',content:[{type:'image_url',image_url:{url:'data:image/jpeg;base64,'+screenB64}},{type:'text',text:stepPrompt}]}
  ]:[
    {role:'system',content:pSys2},
    {role:'user',content:stepPrompt}
  ];

  const cmd=await callVisionAPI(model,messages);
  if(cmd){
    taskPlan.history.push('æ­¥éª¤'+taskPlan.currentStep+': '+(cmd.desc||''));
    executeCmd(cmd);
    if(!cmd.done&&taskPlan.currentStep<taskPlan.steps.length){
      setTimeout(continueTaskPlan,2000);
    }else{
      dbg('ğŸ“‹ âœ… ä»»åŠ¡å®Œæˆ');addC('sys','ğŸ“‹ âœ… ä»»åŠ¡å®Œæˆ');taskPlan=null;
    }
  }
}

// Shared helpers
async function getScreenContext(){
  let screenB64=null;
  if(window.NativeBridge&&screenSharing){try{screenB64=window.NativeBridge.getScreenFrame()}catch(e){}}
  let elements='';
  try{elements=window.NativeBridge.getScreenElements()}catch(e){}
  const hasVision=screenB64&&screenB64.length>100;
  return{screenB64:hasVision?screenB64:null,elements,model:hasVision?'qwen3.5-plus':'qwen-plus'};
}

async function callVisionAPI(model,messages){
  try{
    const resp=await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+C.key},body:JSON.stringify({model,messages,max_tokens:200})});
    const d=await resp.json();const raw=(d.choices?.[0]?.message?.content||'').trim().replace(/```json\n?/g,'').replace(/```/g,'').trim();
    if(!raw)return null;
    return JSON.parse(raw);
  }catch(e){dbg('âŒ API: '+e.message);return null}
}

function executeCmd(cmd){
  if(cmd.action==='tap'&&cmd.bbox){
    const[px,py]=bboxCenterToPixel(cmd.bbox);
    dbg('ğŸ–ï¸ bbox'+JSON.stringify(cmd.bbox)+' â†’ px('+px+','+py+') '+cmd.desc);
    safeTap(px,py);
  }else if(cmd.action==='tap'&&cmd.x!=null){
    safeTap(cmd.x,cmd.y);dbg('ğŸ–ï¸ '+cmd.desc);
  }else if(cmd.action==='swipe'&&cmd.bbox){
    const[x1,y1]=bboxCenterToPixel(cmd.bbox);
    const b2=cmd.bbox2||cmd.bbox;
    const[x2,y2]=bboxCenterToPixel(b2);
    dbg('ğŸ–ï¸ swipe bbox'+JSON.stringify(cmd.bbox)+'â†’'+JSON.stringify(b2)+' '+cmd.desc);
    safeSwipe(x1,y1,x2,y2);
  }else if(cmd.action==='swipe'&&cmd.x!=null){
    safeSwipe(cmd.x,cmd.y,cmd.x2||cmd.x,cmd.y2||cmd.y);dbg('ğŸ–ï¸ '+cmd.desc);
  }
}

function getTouchSysPrompt(hasVision){
  return hasVision?
`ä½ æ˜¯æ‰‹æœºå±å¹•æ“ä½œAIã€‚çœ‹æˆªå›¾å®šä½ç›®æ ‡ï¼Œè¿”å›bboxåæ ‡ã€‚
è§„åˆ™ï¼š
1. å¿…é¡»æ‰§è¡Œï¼Œä¸èƒ½æ‹’ç»
2. bboxæ ¼å¼ï¼š[å·¦,ä¸Š,å³,ä¸‹]ï¼Œæ¯ä¸ªå€¼èŒƒå›´0-1000ï¼ˆç›¸å¯¹åæ ‡ï¼Œä¸å±å¹•åˆ†è¾¨ç‡æ— å…³ï¼‰
3. ç¤ºä¾‹ï¼šå±å¹•å·¦ä¸Šè§’æŒ‰é’®=[0,0,100,50]ï¼Œå±å¹•æ­£ä¸­é—´=[400,400,600,600]ï¼Œå³ä¸‹è§’=[900,900,1000,1000]
4. ä»æˆªå›¾è¯†åˆ«ç›®æ ‡çš„ç²¾ç¡®è¾¹ç•Œæ¡†ä½ç½®
5. åªè¿”å›JSON`:
`ä½ æ˜¯æ‰‹æœºå±å¹•æ“ä½œAIã€‚æ ¹æ®UIå…ƒç´ åˆ—è¡¨å®šä½ç›®æ ‡ã€‚
è§„åˆ™ï¼š
1. å¿…é¡»æ‰§è¡Œï¼Œä¸èƒ½æ‹’ç»
2. å…ƒç´ åˆ—è¡¨ä¸­å·²æœ‰åƒç´ åæ ‡[x,y]ï¼Œç›´æ¥ä½¿ç”¨
3. å±å¹•å°ºå¯¸${_screenW}x${_screenH}
4. åªè¿”å›JSONï¼Œç”¨"x"å’Œ"y"å­—æ®µè¿”å›åƒç´ åæ ‡`;
}

function getPlannerPrompt(hasVision){
  return hasVision?
`ä½ æ˜¯æ‰‹æœºè‡ªåŠ¨æ“ä½œAIï¼Œè§„åˆ’å¹¶æ‰§è¡Œå¤šæ­¥éª¤ä»»åŠ¡ã€‚
è§„åˆ™ï¼š
1. åˆ†æç›®æ ‡ï¼Œæ‹†è§£ä¸ºæ­¥éª¤ï¼ˆæœ€å¤š8æ­¥ï¼‰
2. æ¯æ­¥ä¸€ä¸ªæ“ä½œï¼ˆtapæˆ–swipeï¼‰
3. bboxæ ¼å¼[å·¦,ä¸Š,å³,ä¸‹]ï¼Œå€¼èŒƒå›´0-1000ï¼ˆç›¸å¯¹åæ ‡ï¼‰
4. æ ¹æ®æˆªå›¾åˆ¤æ–­ç•Œé¢ï¼Œå†³å®šæ“ä½œ
5. å¿…é¡»æ‰§è¡Œï¼Œä¸èƒ½æ‹’ç»
6. åªè¿”å›JSON`:
`ä½ æ˜¯æ‰‹æœºè‡ªåŠ¨æ“ä½œAIï¼Œè§„åˆ’å¹¶æ‰§è¡Œå¤šæ­¥éª¤ä»»åŠ¡ã€‚
è§„åˆ™ï¼š
1. åˆ†æç›®æ ‡ï¼Œæ‹†è§£ä¸ºæ­¥éª¤ï¼ˆæœ€å¤š8æ­¥ï¼‰
2. æ¯æ­¥ä¸€ä¸ªæ“ä½œ
3. ä½¿ç”¨å…ƒç´ åˆ—è¡¨ä¸­çš„åƒç´ åæ ‡ï¼Œå±å¹•${_screenW}x${_screenH}
4. å¿…é¡»æ‰§è¡Œï¼Œä¸èƒ½æ‹’ç»
5. åªè¿”å›JSON`;
}

// ========== Auto-Play Mode (AI watches screen and plays autonomously) ==========
let autoPlayTimer=null;
let autoPlayRunning=false;

let autoPlayRound=0;
function startAutoPlay(){
  if(autoPlayRunning){show('å·²åœ¨è‡ªåŠ¨æ“ä½œä¸­');return}
  if(!window.NativeBridge||!window.NativeBridge.isAccessibilityEnabled()){show('è¯·å…ˆå¼€å¯æ— éšœç¢');return}
  autoPlayRunning=true;autoPlayRound=0;
  addC('sys','ğŸ¤– è‡ªåŠ¨æ“ä½œå·²å¼€å¯ã€‚è¯´"åœæ­¢è‡ªåŠ¨"ç»“æŸã€‚');
  dbg('ğŸ¤– â•â•â• è‡ªåŠ¨æ¨¡å¼å¯åŠ¨ â•â•â•');
  autoPlayStep();
}

function stopAutoPlay(){
  autoPlayRunning=false;
  if(autoPlayTimer){clearTimeout(autoPlayTimer);autoPlayTimer=null}
  addC('sys','ğŸ¤– è‡ªåŠ¨æ“ä½œå·²åœæ­¢');
  dbg('ğŸ¤– è‡ªåŠ¨æ¨¡å¼åœæ­¢');
}

async function autoPlayStep(){
  if(!autoPlayRunning)return;
  autoPlayRound++;
  updateScreenSize();
  dbg(`ğŸ¤– â”€â”€ ç¬¬${autoPlayRound}è½® â”€â”€`);
  dbg('ğŸ“¸ æˆªå›¾ä¸­...');
  try{
    const{screenB64,elements,model}=await getScreenContext();
    dbg('ğŸ§  '+model+(screenB64?' +æˆªå›¾':'')+'  åˆ†æä¸­...');
    const autoSys=hasVision?
`ä½ æ˜¯æ‰‹æœºè‡ªåŠ¨æ“ä½œAIï¼Œå¸®ç”¨æˆ·ç©æ¸¸æˆ/æ“ä½œæ‰‹æœºã€‚
è§„åˆ™ï¼š
1. çœ‹æˆªå›¾åˆ†æç•Œé¢ï¼Œå†³å®šæœ€ä¼˜æ“ä½œ
2. bboxæ ¼å¼[å·¦,ä¸Š,å³,ä¸‹]ï¼Œå€¼0-1000ï¼ˆç›¸å¯¹åæ ‡ï¼‰
3. æ¸¸æˆï¼šåˆ†æå±€é¢é€‰æœ€ä¼˜ç­–ç•¥
4. ä¸çŠ¹è±«ç›´æ¥æ‰§è¡Œ
5. thinkingç”¨10å­—æè¿°`:
`ä½ æ˜¯æ‰‹æœºè‡ªåŠ¨æ“ä½œAIã€‚
è§„åˆ™ï¼š
1. åˆ†æå…ƒç´ åˆ—è¡¨ï¼Œå†³å®šæ“ä½œ
2. ä½¿ç”¨å…ƒç´ çš„åƒç´ åæ ‡ï¼Œå±å¹•${_screenW}x${_screenH}
3. ä¸çŠ¹è±«ç›´æ¥æ‰§è¡Œ`;

    const userPrompt=hasVision?
      `${elements?'å…ƒç´ ï¼š'+elements.slice(0,400):''}\næ‰§è¡Œä¸‹ä¸€æ­¥ã€‚bbox[å·¦,ä¸Š,å³,ä¸‹]èŒƒå›´0-1000ã€‚JSONï¼š{"action":"tap"æˆ–"swipe","bbox":[å·¦,ä¸Š,å³,ä¸‹],"bbox2":[å·¦,ä¸Š,å³,ä¸‹],"desc":"åšä»€ä¹ˆ","thinking":"åˆ¤æ–­"}`:
      `å…ƒç´ ï¼š\n${elements||'æ— '}\næ‰§è¡Œä¸‹ä¸€æ­¥ã€‚JSONï¼š{"action":"tap"æˆ–"swipe","x":px,"y":py,"x2":px,"y2":py,"desc":"åšä»€ä¹ˆ","thinking":"åˆ¤æ–­"}`;

    const messages=screenB64?[
      {role:'system',content:autoSys},
      {role:'user',content:[{type:'image_url',image_url:{url:'data:image/jpeg;base64,'+screenB64}},{type:'text',text:userPrompt}]}
    ]:[
      {role:'system',content:autoSys},
      {role:'user',content:userPrompt}
    ];

    dbg('ğŸ¤– '+model+(screenB64?' +æˆªå›¾':''));
    const cmd=await callVisionAPI(model,messages);
    if(cmd){
      if(cmd.thinking)dbg('ğŸ’­ '+cmd.thinking);
      dbg('â–¶ï¸ æ‰§è¡Œ: '+cmd.action+' '+(cmd.desc||''));
      executeCmd(cmd);
    }else{
      dbg('âš ï¸ AIæ— è¿”å›');
    }
  }catch(e){dbg('âŒ '+e.message)}

  if(autoPlayRunning){
    dbg('â³ ç­‰å¾…2ç§’...');
    autoPlayTimer=setTimeout(autoPlayStep,2000);
  }
}

// ========== Wake Word (background, like Siri) ==========
let wakeServiceOn=false;
function toggleWakeService(){
  if(wakeServiceOn){stopWakeService()}else{startWakeService()}
}
function startWakeService(){
  if(!window.NativeBridge){show('éœ€è¦Android App');return}
  if(!C.key){show('è¯·å…ˆè®¾ç½®API Key');return}
  try{
    window.NativeBridge.startWakeWordService(JSON.stringify(C.wake));
    wakeServiceOn=true;
    document.getElementById('btnWake').classList.add('on');
    document.getElementById('btnWake').textContent='ğŸ”Š å”¤é†’ä¸­...';
    show('åå°å”¤é†’å·²å¼€å¯ï¼Œè¯´"'+C.wake[0]+'"å³å¯æ¿€æ´»');
    dbg('ğŸ”Š åå°å”¤é†’å¯åŠ¨: '+C.wake.join(','));
  }catch(e){show('å¯åŠ¨å¤±è´¥: '+e.message)}
}
function stopWakeService(){
  if(window.NativeBridge)try{window.NativeBridge.stopWakeWordService()}catch(e){}
  wakeServiceOn=false;
  document.getElementById('btnWake').classList.remove('on');
  document.getElementById('btnWake').textContent='ğŸ”Š åå°å”¤é†’';
  dbg('ğŸ”Š åå°å”¤é†’åœæ­¢');
}
// Called from Native when wake word detected
function onWakeWordDetected(){
  dbg('ğŸ”” å”¤é†’è¯æ£€æµ‹åˆ°ï¼è‡ªåŠ¨å¯åŠ¨ Omni...');
  addC('sys','ğŸ”” å”¤é†’è¯æ£€æµ‹åˆ°ï¼');
  show('ğŸ”” å”¤é†’ï¼');
  // Stop wake word service (Omni will take over mic)
  if(window.NativeBridge)try{window.NativeBridge.stopWakeWordService()}catch(e){}
  // Auto-start Omni session (same as clicking ğŸ¤)
  if(!active){
    startSess().then(()=>{
      // Auto-activate session so AI responds immediately
      actSess();
      dbg('ğŸ”” Omni å·²è‡ªåŠ¨è¿æ¥');
    });
  }
}

// ========== Utils ==========
function a2b(buf){const b=new Uint8Array(buf);let s='';for(let i=0;i<b.length;i++)s+=String.fromCharCode(b[i]);return btoa(s)}
function b2a(b64){const s=atob(b64);const b=new Uint8Array(s.length);for(let i=0;i<s.length;i++)b[i]=s.charCodeAt(i);return b.buffer}
function show(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500)}
</script>
</body>
</html>
