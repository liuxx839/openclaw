<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>AI Avatar</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{--bg:#08090e;--bg2:#10121a;--glass:rgba(16,18,26,.85);--card:rgba(28,35,58,.6);--accent:#7b8cff;--accent2:#5b6bff;--glow:rgba(123,140,255,.12);--purple:#a78bfa;--warm:#ffb347;--green:#34d399;--red:#fb7185;--cyan:#67e8f9;--text:#f0f2f8;--text2:#7c8497;--text3:#3d4355;--border:rgba(255,255,255,.06);--r:16px;--rs:12px}
body{font-family:'SF Pro Display',-apple-system,system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;padding-bottom:env(safe-area-inset-bottom)}
.nav{position:fixed;bottom:0;left:0;right:0;background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom)}
.ni{flex:1;display:flex;flex-direction:column;align-items:center;padding:10px 0 6px;font-size:10px;color:var(--text3);cursor:pointer;transition:.3s}.ni.on{color:var(--accent)}.ni .ic{font-size:22px;margin-bottom:3px}
.page{display:none;min-height:100vh;padding:20px 16px 90px}.page.on{display:flex;flex-direction:column;align-items:center}
/* Avatar */
.av-wrap{padding-top:24px;display:flex;flex-direction:column;align-items:center;width:100%}
.av-ring{width:220px;height:220px;border-radius:50%;padding:4px;background:linear-gradient(135deg,var(--accent),var(--purple));box-shadow:0 0 40px var(--glow),0 0 80px rgba(123,140,255,.06)}
.av-inner{width:100%;height:100%;border-radius:50%;overflow:hidden;background:#000;position:relative}
.av-inner video{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0}
.av-inner .ph{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:80px;background:linear-gradient(135deg,#1a1a3e,#2d1b69)}
.badge{font-size:11px;padding:4px 14px;border-radius:20px;margin-top:14px;font-weight:500;letter-spacing:.5px}
.badge.on{background:rgba(52,211,153,.12);color:var(--green);border:1px solid rgba(52,211,153,.2)}
.badge.off{background:rgba(124,132,151,.08);color:var(--text2);border:1px solid var(--border)}
/* Mic */
.mic-wrap{margin:24px 0 16px;display:flex;align-items:center;gap:16px}
.mic{width:68px;height:68px;border-radius:50%;border:none;font-size:26px;cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--purple));color:#fff;box-shadow:0 8px 32px var(--glow);transition:.3s}
.mic.rec{background:linear-gradient(135deg,#fb7185,#f43f5e);animation:glow 2s infinite}
.mic:disabled{background:var(--text3);box-shadow:none;cursor:not-allowed}
@keyframes glow{0%,100%{box-shadow:0 0 0 0 rgba(244,63,94,.3)}50%{box-shadow:0 0 0 20px rgba(244,63,94,0)}}
.side-btn{width:44px;height:44px;border-radius:50%;border:1px solid var(--border);background:var(--card);color:var(--text2);font-size:18px;cursor:pointer;transition:.2s;backdrop-filter:blur(10px)}
.side-btn:active{transform:scale(.9)}.side-btn.on{border-color:var(--accent);color:var(--accent);background:var(--glow)}
.status{font-size:12px;color:var(--text2);text-align:center}
/* Actions */
.actions{display:flex;gap:10px;margin:16px 0;flex-wrap:wrap;justify-content:center}
.abtn{padding:8px 18px;border-radius:24px;border:1px solid var(--border);background:var(--card);backdrop-filter:blur(10px);color:var(--text2);font-size:12px;cursor:pointer;transition:.2s;font-weight:500}
.abtn:active{transform:scale(.95)}.abtn.on{border-color:var(--accent);color:var(--accent);background:var(--glow)}
/* Chat */
.chat{width:100%;max-height:260px;overflow-y:auto;background:var(--card);backdrop-filter:blur(10px);border-radius:var(--r);padding:14px;margin-top:12px;border:1px solid var(--border)}
.cm{padding:5px 0;font-size:13px;line-height:1.6;border-bottom:1px solid var(--border)}.cm:last-child{border:none}
.cm.user{color:var(--accent)}.cm.ai{color:var(--green)}.cm.sys{color:var(--text3);font-size:11px}
/* Camera */
.cam-box{position:fixed;bottom:80px;right:12px;width:130px;height:100px;background:#000;border-radius:var(--rs);overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,.6);opacity:0;transition:.3s;z-index:50;pointer-events:none;border:1px solid var(--border)}
.cam-box.show{opacity:1;pointer-events:auto}
.cam-box video{width:100%;height:100%;object-fit:cover}
.cam-box .cx{position:absolute;top:4px;right:4px;width:22px;height:22px;background:rgba(0,0,0,.6);border:none;color:#fff;border-radius:50%;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.cam-box .flip{position:absolute;bottom:4px;right:4px;width:22px;height:22px;background:rgba(0,0,0,.6);border:none;color:#fff;border-radius:50%;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center}
/* Cards */
.cg{display:flex;flex-direction:column;gap:12px;width:100%}
.ci{background:var(--card);backdrop-filter:blur(10px);border-radius:var(--r);padding:16px;border:1px solid var(--border);border-left:3px solid var(--accent)}
.ci .ct{font-size:10px;color:var(--text3)}.ci .ch{font-size:15px;font-weight:600;margin:4px 0}.ci .cb{font-size:12px;color:var(--text2);line-height:1.7}
.ci .tags{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px}
.ci .tag{font-size:10px;background:var(--glow);color:var(--accent);padding:3px 10px;border-radius:12px;border:1px solid rgba(123,140,255,.15)}
.ci .ca{display:flex;gap:6px;margin-top:10px}
.ci .ca button{font-size:11px;padding:5px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer}
/* Memory */
.ms{background:var(--card);backdrop-filter:blur(10px);border-radius:var(--r);padding:16px;margin-bottom:12px;width:100%;border:1px solid var(--border)}
.ms h3{font-size:13px;color:var(--accent);margin-bottom:10px;font-weight:600}
.me{font-size:11px;color:var(--text2);padding:5px 0;border-bottom:1px solid var(--border);line-height:1.6}.me:last-child{border:none}
.me .mt{color:var(--warm);font-size:10px}
.mstats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:100%;margin-top:12px}
.mst{background:var(--card);backdrop-filter:blur(10px);border-radius:var(--rs);padding:12px;text-align:center;border:1px solid var(--border)}
.mst .v{font-size:22px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.mst .l{font-size:9px;color:var(--text3);margin-top:3px;text-transform:uppercase}
/* Settings */
.sg{background:var(--card);backdrop-filter:blur(10px);border-radius:var(--r);padding:16px;margin-bottom:14px;width:100%;border:1px solid var(--border)}
.sg h3{font-size:13px;color:var(--text2);margin-bottom:12px;font-weight:600}
.sr{display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap}
.sr label{font-size:12px;color:var(--text2);min-width:65px;font-weight:500}
.sr input,.sr select{flex:1;min-width:0;padding:10px 14px;border:1px solid var(--border);border-radius:var(--rs);background:var(--bg2);color:var(--text);font-size:13px;outline:none;transition:.2s}
.sr input:focus,.sr select:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--glow)}
.sb{padding:10px 20px;border:none;border-radius:var(--rs);font-size:12px;font-weight:600;cursor:pointer;transition:.2s;letter-spacing:.3px}
.sb.pr{background:linear-gradient(135deg,var(--accent),var(--purple));color:#fff;box-shadow:0 4px 16px var(--glow)}
.sb.gh{background:var(--bg2);color:var(--text2);border:1px solid var(--border)}
.sb:active{transform:scale(.96)}
.pg-h{font-size:20px;font-weight:700;margin-bottom:18px;width:100%;letter-spacing:-.3px}
/* Toast */
.toast{position:fixed;top:50px;left:50%;transform:translateX(-50%);background:var(--glass);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:var(--rs);padding:10px 24px;font-size:12px;color:var(--text);z-index:200;opacity:0;transition:.3s;font-weight:500}
.toast.show{opacity:1}
</style>
</head>
<body>
<div class="page on" id="p-chat">
  <div class="av-wrap">
    <div class="av-ring"><div class="av-inner" id="avBox">
      <div class="ph" id="avPh">ğŸ¤–</div>
      <video id="vI" loop muted playsinline autoplay style="display:none"></video>
      <video id="vT" loop muted playsinline style="display:none"></video>
    </div></div>
    <div class="badge off" id="badge">âšª å¾…æœº</div>
  </div>
  <div class="mic-wrap">
    <button class="side-btn" id="btnCam" onclick="toggleCam()">ğŸ“¹</button>
    <button class="mic" id="micBtn" onclick="toggleSession()" disabled>ğŸ¤</button>
    <button class="side-btn" onclick="uploadImg()">ğŸ–¼ï¸</button>
  </div>
  <div class="status" id="stLine">è®¾ç½®ä¸­è¾“å…¥ API Key åå¼€å§‹</div>
  <div class="actions">
    <button class="abtn" id="btnFlip" onclick="flipCam()" style="display:none">ğŸ”„ ç¿»è½¬</button>
    <button class="abtn" onclick="toggleChat()">ğŸ’¬ å¯¹è¯</button>
  </div>
  <div class="chat" id="chatEl" style="display:none"></div>
  <input type="file" id="imgIn" accept="image/*" style="display:none" onchange="onImgPick(event)">
</div>

<div class="page" id="p-cards">
  <div class="pg-h">ğŸ“‹ å¡ç‰‡æ•´ç†</div>
  <div style="display:flex;gap:10px;margin-bottom:16px;width:100%">
    <button class="sb pr" onclick="genCard()" style="flex:1">âœ¨ AI ç”Ÿæˆå¡ç‰‡</button>
    <button class="sb gh" onclick="clearCards()">ğŸ—‘ï¸</button>
  </div>
  <div class="cg" id="cGrid"></div>
</div>

<div class="page" id="p-mem">
  <div class="pg-h">ğŸ§  è®°å¿†ç³»ç»Ÿ</div>
  <div class="ms"><h3>ğŸ“ çŸ­æœŸè®°å¿†</h3><div id="sMem">æš‚æ— </div></div>
  <div class="ms"><h3>ğŸ’ é•¿æœŸè®°å¿†</h3><div id="lMem">æš‚æ— </div></div>
  <div class="ms"><h3>ğŸ”® åæ€</h3><div id="rMem">æš‚æ— </div></div>
  <div class="mstats">
    <div class="mst"><div class="v" id="msO">0</div><div class="l">è§‚å¯Ÿ</div></div>
    <div class="mst"><div class="v" id="msD">0</div><div class="l">å¤©æ•°</div></div>
    <div class="mst"><div class="v" id="msR">0</div><div class="l">åæ€</div></div>
  </div>
  <div style="display:flex;gap:10px;margin-top:14px;width:100%">
    <button class="sb gh" onclick="manualFlush()" style="flex:1">ğŸ“ ç«‹å³æ€»ç»“</button>
    <button class="sb gh" onclick="exportMem()" style="flex:1">ğŸ“¤ å¯¼å‡º</button>
  </div>
</div>

<div class="page" id="p-set">
  <div class="pg-h">âš™ï¸ è®¾ç½®</div>
  <div class="sg"><h3>ğŸ”‘ API</h3>
    <div class="sr"><label>Key:</label><input type="password" id="sKey" placeholder="sk-xxxxxxxx"></div>
    <button class="sb pr" onclick="saveCfg()" style="width:100%">ä¿å­˜å¹¶åº”ç”¨</button>
  </div>
  <div class="sg"><h3>ğŸ—£ï¸ è¯­éŸ³åŠ©æ‰‹</h3>
    <div class="sr"><label>æ¿€æ´»è¯:</label><input type="text" id="sWake" placeholder="å°åŠ©æ‰‹,ä½ å¥½ï¼ˆé€—å·åˆ†éš”ï¼‰"></div>
    <div class="sr"><label>è½®æ•°:</label><input type="text" id="sTurns" value="10"></div>
    <div class="sr"><label>è¯­éŸ³:</label><select id="sVoice"><option value="Serena">Serena å¥³å£°</option><option value="Ethan">Ethan ç”·å£°</option><option value="Chelsie">Chelsie</option></select></div>
    <button class="sb pr" onclick="saveCfg()" style="width:100%">ä¿å­˜å¹¶åº”ç”¨</button>
  </div>
  <div class="sg"><h3>ğŸ¬ å¤´åƒè§†é¢‘</h3>
    <button class="sb gh" onclick="pickVid()" style="width:100%">é€‰æ‹©è§†é¢‘æ–‡ä»¶</button>
    <div id="vidSt" style="font-size:11px;color:var(--text3);margin-top:6px"></div>
    <input type="file" id="vidIn" accept="video/*" multiple style="display:none" onchange="onVidPick(event)">
  </div>
  <div class="sg"><h3>â„¹ï¸ å…³äº</h3>
    <div style="font-size:11px;color:var(--text3);line-height:2">
      AI Avatar v1.1<br>
      Omni: qwen3-omni-flash-realtime<br>
      ASR: qwen3-asr-flash-realtime<br>
      Vision: qwen-vl-plus<br>
      Summary: qwen-plus<br>
      Memory: OpenClaw pattern
    </div>
  </div>
</div>

<div class="nav">
  <div class="ni on" data-p="p-chat"><div class="ic">ğŸ¤</div>å¯¹è¯</div>
  <div class="ni" data-p="p-cards"><div class="ic">ğŸ“‹</div>å¡ç‰‡</div>
  <div class="ni" data-p="p-mem"><div class="ic">ğŸ§ </div>è®°å¿†</div>
  <div class="ni" data-p="p-set"><div class="ic">âš™ï¸</div>è®¾ç½®</div>
</div>
<div class="cam-box" id="camBox"><video id="camVid" autoplay muted playsinline></video><button class="cx" onclick="toggleCam()">âœ•</button><button class="flip" onclick="flipCam()">ğŸ”„</button></div>
<div class="toast" id="toast"></div>
<canvas id="fCvs" style="display:none"></canvas>

<script>
// ========== Config ==========
let C={key:localStorage.getItem('av_k')||'',wake:(localStorage.getItem('av_w')||'å°åŠ©æ‰‹,ä½ å¥½,å—¨').split(',').map(s=>s.trim()).filter(Boolean),turns:parseInt(localStorage.getItem('av_t')||'10'),voice:localStorage.getItem('av_v')||'Serena'};
const BYE=['æ‹œæ‹œ','å¥½äº†','è°¢è°¢','å†è§','åœåœ','æ²¡äº‹äº†','å°±è¿™æ ·'];
const MODEL='qwen3-omni-flash-realtime-2025-12-01';

// ========== Memory (OpenClaw) ==========
class Mem{
  constructor(){this.st=[];this.dl={};this.lt=[];this.rf=[];this.imp=new Map();this._load()}
  _save(){try{localStorage.setItem('av_m',JSON.stringify({st:this.st.slice(-100),dl:this.dl,lt:this.lt.slice(-50),rf:this.rf.slice(-20)}))}catch{}}
  _load(){try{const d=JSON.parse(localStorage.getItem('av_m')||'null');if(d){this.st=d.st||[];this.dl=d.dl||{};this.lt=d.lt||[];this.rf=d.rf||[];[...this.st,...this.rf].forEach(m=>this.imp.set(m.t,m.i||5))}}catch{}}
  add(t,i=5){const n=new Date(),e={t,time:fD(n),ts:n.getTime(),i};this.st.push(e);this.imp.set(t,i);const k=n.toISOString().split('T')[0];if(!this.dl[k])this.dl[k]=[];this.dl[k].push(e);this._save()}
  addRef(t){const n=new Date(),e={t,time:fD(n),ts:n.getTime(),i:8};this.rf.push(e);this.lt.push(e);this.imp.set(t,8);this._save()}
  recent(n=10){return this.st.slice(-n)}
  longT(){return this.lt.slice(-10).map(m=>m.t)}
  today(){const k=new Date().toISOString().split('T')[0];return this.dl[k]||[]}
  needsFlush(){return this.st.length>20}
  compact(s){this.addRef(s);this.st=this.st.slice(-5);this._save()}
  stats(){return{o:this.st.length,d:Object.keys(this.dl).length,r:this.rf.length}}
  exportAll(){return JSON.stringify({stream:this.st,daily:this.dl,longTerm:this.lt,reflections:this.rf},null,2)}
}
function fD(d){const p=n=>String(n).padStart(2,'0');return`${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`}
const mem=new Mem();

// ========== State ==========
let ws=null,actx=null,mProc=null,mSrc=null,mStr=null;
let active=false,gate=false,aBuf=[],nxt=0,aSrcs=[];
let sess={on:false,t:0};
let camStr=null,frameInt=null,audioSent=false,facingBack=true;
let hasVid=false,talkU=null,pauseU=null,lastImg='';
let cards=JSON.parse(localStorage.getItem('av_c')||'[]');
let chatVis=false;

// ========== Nav ==========
document.querySelectorAll('.ni').forEach(n=>{n.onclick=()=>{
  document.querySelectorAll('.ni').forEach(x=>x.classList.remove('on'));
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('on'));
  n.classList.add('on');document.getElementById(n.dataset.p).classList.add('on');
  if(n.dataset.p==='p-mem')renderMem();if(n.dataset.p==='p-cards')renderCards();
}});

// ========== Init ==========
window.addEventListener('load',()=>{
  if(C.key){document.getElementById('sKey').value=C.key;document.getElementById('micBtn').disabled=false;document.getElementById('stLine').textContent='å‡†å¤‡å°±ç»ª'}
  document.getElementById('sWake').value=C.wake.join(',');
  document.getElementById('sTurns').value=C.turns;
  document.getElementById('sVoice').value=C.voice;
  renderCards();
  // Auto-load bundled videos
  const vI=document.getElementById('vI'),vT=document.getElementById('vT');
  vI.src='pause.mp4';vT.src='talk.mp4';
  vI.oncanplay=()=>{hasVid=true;pauseU='pause.mp4';talkU='talk.mp4';document.getElementById('avPh').style.display='none';vI.style.display='block';vI.play().catch(()=>{});document.getElementById('vidSt').textContent='âœ“ å†…ç½®è§†é¢‘'};
});

// ========== Settings (live apply) ==========
function saveCfg(){
  C.key=document.getElementById('sKey').value.trim();
  C.wake=document.getElementById('sWake').value.split(',').map(s=>s.trim()).filter(Boolean);
  C.turns=parseInt(document.getElementById('sTurns').value)||10;
  C.voice=document.getElementById('sVoice').value;
  localStorage.setItem('av_k',C.key);localStorage.setItem('av_w',C.wake.join(','));
  localStorage.setItem('av_t',C.turns);localStorage.setItem('av_v',C.voice);
  document.getElementById('micBtn').disabled=!C.key;
  if(C.key)document.getElementById('stLine').textContent='å‡†å¤‡å°±ç»ª';
  if(ws&&ws.readyState===WebSocket.OPEN){
    ws.send(JSON.stringify({type:'session.update',session:{voice:C.voice,instructions:sysPr()}}));
    show('è®¾ç½®å·²ä¿å­˜å¹¶å®æ—¶ç”Ÿæ•ˆ');
  }else show('è®¾ç½®å·²ä¿å­˜');
}

// ========== Video ==========
function pickVid(){document.getElementById('vidIn').click()}
function onVidPick(e){for(const f of e.target.files){const u=URL.createObjectURL(f),n=f.name.toLowerCase();if(n.includes('talk')){talkU=u;document.getElementById('vT').src=u}else{pauseU=u;document.getElementById('vI').src=u}}
  if(pauseU){hasVid=true;document.getElementById('avPh').style.display='none';document.getElementById('vI').style.display='block';document.getElementById('vI').play().catch(()=>{});document.getElementById('vidSt').textContent='âœ“ å·²åŠ è½½'}}
function setAv(s){if(!hasVid){document.getElementById('avPh').textContent=s==='talk'?'ğŸ—£ï¸':'ğŸ¤–';return}const i=document.getElementById('vI'),t=document.getElementById('vT');if(s==='talk'&&talkU){i.style.display='none';i.pause();t.style.display='block';t.play().catch(()=>{})}else{t.style.display='none';t.pause();i.style.display='block';i.play().catch(()=>{})}}

// ========== Camera (from original ai_avatar.html logic) ==========
function toggleCam(){if(camStr)stopCam();else startCam()}
async function startCam(){
  try{
    camStr=await navigator.mediaDevices.getUserMedia({video:{facingMode:facingBack?'environment':'user',width:{ideal:640},height:{ideal:480}},audio:false});
    document.getElementById('camVid').srcObject=camStr;
    document.getElementById('camBox').classList.add('show');
    document.getElementById('btnCam').classList.add('on');
    document.getElementById('btnFlip').style.display='';
    frameInt=setInterval(sendFrame,500);
    addC('sys','ğŸ“¹ æ‘„åƒå¤´å·²æ‰“å¼€');mem.add('æ‰“å¼€äº†æ‘„åƒå¤´',5);
  }catch(e){show('æ‘„åƒå¤´å¤±è´¥: '+e.message)}
}
function stopCam(){
  if(frameInt){clearInterval(frameInt);frameInt=null}
  if(camStr){camStr.getTracks().forEach(t=>t.stop());camStr=null}
  document.getElementById('camVid').srcObject=null;
  document.getElementById('camBox').classList.remove('show');
  document.getElementById('btnCam').classList.remove('on');
  document.getElementById('btnFlip').style.display='none';
  addC('sys','ğŸ“¹ æ‘„åƒå¤´å·²å…³é—­');
}
async function flipCam(){
  facingBack=!facingBack;
  if(camStr){stopCam();await startCam()}
  // Mirror front camera
  document.getElementById('camVid').style.transform=facingBack?'none':'scaleX(-1)';
}

// Send video frame â€” EXACT same protocol as original ai_avatar.html
function sendFrame(){
  if(!ws||ws.readyState!==WebSocket.OPEN)return;
  if(!audioSent)return;
  const v=document.getElementById('camVid');
  if(!v.videoWidth||!v.videoHeight)return;
  try{
    const c=document.getElementById('fCvs'),x=c.getContext('2d');
    c.width=640;c.height=480;
    x.drawImage(v,0,0,640,480);
    let q=0.6,d=c.toDataURL('image/jpeg',q),b=d.split(',')[1];
    const mx=450*1024;
    while(b.length>mx&&q>0.2){q-=0.1;d=c.toDataURL('image/jpeg',q);b=d.split(',')[1]}
    ws.send(JSON.stringify({type:'input_image_buffer.append',image:b}));
  }catch(e){console.error('Frame err:',e)}
}

// ========== Image Upload â†’ input_image_buffer.append ==========
function uploadImg(){document.getElementById('imgIn').click()}
function onImgPick(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=(ev)=>{
    addC('user','[ğŸ–¼ï¸ '+f.name+']');mem.add('ä¸Šä¼ å›¾ç‰‡: '+f.name,6);
    const img=new Image();
    img.onload=()=>{
      const c=document.getElementById('fCvs'),x=c.getContext('2d');
      c.width=640;c.height=480;
      const sc=Math.min(640/img.width,480/img.height),w=img.width*sc,h=img.height*sc;
      x.fillStyle='#000';x.fillRect(0,0,640,480);
      x.drawImage(img,(640-w)/2,(480-h)/2,w,h);
      const b=c.toDataURL('image/jpeg',0.7).split(',')[1];
      if(ws&&ws.readyState===WebSocket.OPEN&&audioSent){
        // Send image frame multiple times (3s at 2fps) so Omni can "see" it
        addC('sys','ğŸ–¼ï¸ æ­£åœ¨å±•ç¤ºå›¾ç‰‡ç»™ AIï¼ˆ3ç§’ï¼‰...');
        let sent=0;
        const imgInt=setInterval(()=>{
          if(!ws||ws.readyState!==WebSocket.OPEN||sent>=6){clearInterval(imgInt);return}
          ws.send(JSON.stringify({type:'input_image_buffer.append',image:b}));sent++;
        },500);
        setTimeout(()=>{
          clearInterval(imgInt);
          ws.send(JSON.stringify({type:'conversation.item.create',item:{type:'message',role:'user',content:[{type:'input_text',text:'æˆ‘åˆšç»™ä½ çœ‹äº†ä¸€å¼ å›¾ç‰‡ï¼Œè¯·æè¿°ä½ çœ‹åˆ°äº†ä»€ä¹ˆã€‚'}]}}));
          ws.send(JSON.stringify({type:'response.create'}));
          addC('sys','ğŸ–¼ï¸ å›¾ç‰‡å±•ç¤ºå®Œæ¯•ï¼Œç­‰å¾… AI å›å¤');
        },3500);
      }else{
        fbImg(ev.target.result.split(',')[1]);
      }
    };
    img.src=ev.target.result;
  };
  r.readAsDataURL(f);e.target.value='';
}
async function fbImg(b64){
  addC('sys','ğŸ” åˆ†æä¸­...');
  try{
    const r=await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+C.key},body:JSON.stringify({model:'qwen-vl-plus',messages:[{role:'user',content:[{type:'image_url',image_url:{url:'data:image/jpeg;base64,'+b64}},{type:'text',text:'æè¿°å›¾ç‰‡å†…å®¹ã€‚'}]}],max_tokens:300})});
    const d=await r.json();const desc=d.choices?.[0]?.message?.content||'æ— æ³•è¯†åˆ«';
    addC('ai',desc);mem.add('å›¾ç‰‡: '+desc,7);lastImg=desc;
  }catch(e){addC('sys','å¤±è´¥: '+e.message)}
}

// ========== Session ==========
function actSess(){sess.on=true;sess.t=C.turns;updBadge()}
function deactSess(){sess.on=false;sess.t=0;gate=false;updBadge()}
function consTurn(){if(sess.t>0){sess.t--;updBadge();if(sess.t<=0)deactSess()}}
function updBadge(){const b=document.getElementById('badge');if(sess.on){b.className='badge on';b.textContent='ğŸŸ¢ æ¿€æ´» ('+sess.t+'è½®)'}else{b.className='badge off';b.textContent='âšª ç›‘å¬ä¸­'}}
function shouldResp(t){if(BYE.some(w=>t.includes(w)))return{r:true,bye:true};if(C.wake.some(w=>t.includes(w))){actSess();return{r:true,wk:true}}if(sess.on)return{r:true};return{r:false}}

// ========== Chat ==========
function toggleChat(){chatVis=!chatVis;document.getElementById('chatEl').style.display=chatVis?'block':'none'}
function addC(role,t){const el=document.getElementById('chatEl'),d=document.createElement('div');d.className='cm '+role;d.textContent=(role==='user'?'ğŸ§‘ ':role==='ai'?'ğŸ¤– ':'')+t;el.appendChild(d);el.scrollTop=el.scrollHeight;while(el.children.length>40)el.removeChild(el.firstChild)}

// ========== System Prompt ==========
function sysPr(){
  const s=mem.recent(15).map(m=>'['+m.time+'] '+m.t).join('\n');
  const l=mem.longT().join('\n');
  const td=mem.today().map(m=>'['+m.time+'] '+m.t).join('\n');
  return`ä½ æ˜¯AIåŠ©ç†"å°åŠ©æ‰‹"ã€‚
### æ ¸å¿ƒæŒ‡ä»¤ ###
1. æœªè¢«å”¤é†’æ—¶ä¿æŒå®‰é™ã€‚
2. è¢«å”¤é†’åç®€çŸ­å›ç­”ï¼ˆ30å­—å†…ï¼‰ã€‚
3. å”¤é†’åä¿æŒ${C.turns}è½®å¯¹è¯ã€‚
4. ç”¨æˆ·æ‰“å¼€äº†æ‘„åƒå¤´æˆ–å‘äº†å›¾ç‰‡æ—¶ï¼Œä¸»åŠ¨æè¿°ä½ çœ‹åˆ°çš„å†…å®¹ã€‚

### å”¤é†’è¯ ###
${JSON.stringify(C.wake)}

### ä»Šæ—¥å¯¹è¯ ###
${td||'æš‚æ— '}

### çŸ­æœŸè®°å¿† ###
${s||'æš‚æ— '}

### é•¿æœŸè®°å¿† ###
${l||'æš‚æ— '}
${lastImg?'\n### æœ€è¿‘å›¾ç‰‡ ###\n'+lastImg:''}

### è§„åˆ™ ###
- é—®"åˆšæ‰è¯´äº†ä»€ä¹ˆ"â†’å‚è€ƒå¯¹è¯è®°å½•å’Œè®°å¿†
- çœ‹åˆ°æ‘„åƒå¤´ç”»é¢â†’ä¸»åŠ¨æè¿°çœ‹åˆ°çš„å†…å®¹
- è®¾æé†’/æ—¥ç¨‹â†’ç¡®è®¤æ—¶é—´å’Œå†…å®¹ï¼Œè¯´"å¥½çš„ï¼Œæˆ‘å¸®ä½ è®¾äº†Xç‚¹çš„æé†’"
- é—®å€™â†’ä¸€å¥è¯å›åº”
- å‘Šåˆ«â†’æ¸©æš–å‘Šåˆ«
- å…¶ä»–â†’ç®€çŸ­ä¸“ä¸š`;
}

// ========== WebSocket (EXACT same as original ai_avatar.html) ==========
async function toggleSession(){if(active)stopSess();else await startSess()}
async function startSess(){
  if(!C.key){show('è¯·å…ˆè®¾ç½® API Key');return}
  try{
    if(!actx)actx=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24000});
    else if(actx.state==='suspended')await actx.resume();
    mStr=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16000,channelCount:1,echoCancellation:true,noiseSuppression:true}});
    mSrc=actx.createMediaStreamSource(mStr);
    mProc=actx.createScriptProcessor(4096,1,1);
    mSrc.connect(mProc);mProc.connect(actx.destination);
    const url=`wss://dashscope.aliyuncs.com/api-ws/v1/realtime?model=${MODEL}&api_key=${C.key}`;
    document.getElementById('stLine').textContent='è¿æ¥ä¸­...';
    ws=new WebSocket(url);
    ws.binaryType='arraybuffer'; // CRITICAL: must match original

    ws.onopen=()=>{
      ws.send(JSON.stringify({type:'session.update',session:{modalities:['audio','text'],voice:C.voice,instructions:sysPr(),input_audio_format:'pcm16',output_audio_format:'pcm16',turn_detection:{type:'server_vad'},input_audio_transcription:{model:'qwen3-asr-flash-realtime'}}}));
      active=true;
      document.getElementById('micBtn').classList.add('rec');
      document.getElementById('micBtn').textContent='â¹ï¸';
      document.getElementById('stLine').textContent='ğŸ‘‚ ç›‘å¬ä¸­';
      updBadge();setAv('idle');
      if(window.NativeBridge)try{window.NativeBridge.startKeepAlive()}catch(e){}

      mProc.onaudioprocess=(e)=>{
        if(!ws||ws.readyState!==WebSocket.OPEN)return;
        const inp=e.inputBuffer.getChannelData(0);
        const ratio=actx.sampleRate/16000;
        const len=Math.floor(inp.length/ratio);
        const i16=new Int16Array(len);
        for(let i=0;i<len;i++){const s=Math.max(-1,Math.min(1,inp[Math.floor(i*ratio)]));i16[i]=s<0?s*0x8000:s*0x7FFF}
        ws.send(JSON.stringify({type:'input_audio_buffer.append',audio:a2b(i16.buffer)}));
        audioSent=true;
      };
    };
    ws.onmessage=async(ev)=>{
      if(typeof ev.data==='string'){try{await onMsg(JSON.parse(ev.data))}catch{}}
      else{if(gate)playC(ev.data)}
    };
    ws.onerror=()=>{document.getElementById('stLine').textContent='âŒ è¿æ¥é”™è¯¯'};
    ws.onclose=()=>{if(active)stopSess()};
  }catch(e){document.getElementById('stLine').textContent='âŒ '+e.message}
}

async function onMsg(m){
  const t=m.type||'';
  if(t==='input_audio_buffer.speech_started'){clrA();aBuf=[];gate=false}
  else if(t==='conversation.item.input_audio_transcription.completed'){
    const txt=(m.transcript||'').trim();if(!txt)return;
    mem.add('ç”¨æˆ·: '+txt,5);
    const d=shouldResp(txt);
    if(d.r){addC('user',txt);gate=true;checkReminder(txt);if(d.bye){addC('sys','ğŸ‘‹ å†è§');setTimeout(deactSess,1000)}else if(!d.wk)consTurn();aBuf.forEach(c=>playC(c));aBuf=[]}
    else{addC('sys','[ç›‘å¬] '+txt);aBuf=[]}
  }
  else if(t==='response.audio_transcript.done'){
    const txt=(m.transcript||'').trim();
    if(txt&&gate){addC('ai',txt);mem.add('AI: '+txt,5);checkReminder(txt)}
    if(mem.needsFlush())autoFlush();
  }
  else if(t==='response.audio.delta'){
    if(m.delta){const ab=b2a(m.delta);if(gate)playC(ab);else aBuf.push(ab)}
  }
}

function stopSess(){
  active=false;deactSess();clrA();setAv('idle');stopCam();audioSent=false;
  if(window.NativeBridge)try{window.NativeBridge.stopKeepAlive()}catch(e){}
  if(ws){ws.onclose=null;ws.close();ws=null}
  if(mProc){mProc.onaudioprocess=null;mProc.disconnect();mProc=null}
  if(mSrc){mSrc.disconnect();mSrc=null}
  if(mStr){mStr.getTracks().forEach(t=>t.stop());mStr=null}
  document.getElementById('micBtn').classList.remove('rec');
  document.getElementById('micBtn').textContent='ğŸ¤';
  document.getElementById('stLine').textContent='å·²åœæ­¢';
}

// ========== Audio ==========
function clrA(){aSrcs.forEach(s=>{try{s.stop()}catch{}});aSrcs=[];if(actx)nxt=actx.currentTime;setAv('idle')}
function playC(ab){
  if(!actx||!ab||ab.byteLength===0)return;
  try{const i=new Int16Array(ab),f=new Float32Array(i.length);for(let j=0;j<i.length;j++)f[j]=i[j]/32768;
  const buf=actx.createBuffer(1,f.length,24000);buf.getChannelData(0).set(f);
  const src=actx.createBufferSource();src.buffer=buf;src.connect(actx.destination);
  if(nxt<actx.currentTime)nxt=actx.currentTime;src.start(nxt);nxt+=buf.duration;
  setAv('talk');aSrcs.push(src);
  src.onended=()=>{aSrcs=aSrcs.filter(s=>s!==src);if(aSrcs.length===0)setAv('idle')}}catch{}}

// ========== Calendar Reminder (A+C) ==========
async function checkReminder(text){
  const keywords=['æé†’','é—¹é’Ÿ','æ—¥å†','æ—¥ç¨‹','è®°å¾—','åˆ«å¿˜','å®šæ—¶','åˆ°æ—¶å€™'];
  if(!keywords.some(k=>text.includes(k)))return;
  // Ask AI to extract reminder info
  try{
    const resp=await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+C.key},body:JSON.stringify({model:'qwen-plus',messages:[{role:'user',content:`ä»ä»¥ä¸‹æ–‡å­—ä¸­æå–æé†’ä¿¡æ¯ï¼Œå¦‚æœä¸æ˜¯è®¾æé†’çš„æ„å›¾å°±è¿”å›nullã€‚
æ–‡å­—ï¼š"${text}"
å½“å‰æ—¶é—´ï¼š${new Date().toISOString()}

å¦‚æœæ˜¯è®¾æé†’ï¼Œè¿”å›JSONï¼š{"title":"æé†’æ ‡é¢˜","time":"ISOæ—¶é—´æ ¼å¼","minutes":æŒç»­åˆ†é’Ÿæ•°}
å¦‚æœä¸æ˜¯ï¼Œè¿”å›ï¼šnull
åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚`}],max_tokens:100})});
    const d=await resp.json();const raw=(d.choices?.[0]?.message?.content||'').trim();
    if(raw==='null'||!raw.startsWith('{'))return;
    const info=JSON.parse(raw);if(!info.title||!info.time)return;
    const timeMs=new Date(info.time).getTime();
    if(timeMs<=Date.now()){addC('sys','âš ï¸ æé†’æ—¶é—´å·²è¿‡');return}
    const remId=Math.floor(Math.random()*100000);
    // A: Open system calendar
    if(window.NativeBridge){
      try{window.NativeBridge.openCalendarEvent(info.title,text,timeMs,info.minutes||60)}catch(e){}
      // C: Also schedule local notification
      try{window.NativeBridge.scheduleNotification('â° '+info.title,'æ¥è‡ª AI Avatar çš„æé†’',timeMs,remId)}catch(e){}
    }
    mem.add('è®¾ç½®æé†’: '+info.title+' @ '+info.time,7);
    addC('sys','â° æé†’å·²åˆ›å»º: '+info.title);
    show('â° æé†’å·²è®¾ç½®');
  }catch(e){console.error('Reminder parse err:',e)}
}

// ========== Memory flush ==========
async function autoFlush(){
  const r=mem.recent(20).map(m=>m.t).join('\n');
  try{const resp=await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+C.key},body:JSON.stringify({model:'qwen-plus',messages:[{role:'user',content:'æ€»ç»“è¦ç‚¹ï¼ˆ50å­—å†…ï¼‰ï¼š\n'+r}],max_tokens:100})});
  const d=await resp.json();const s=d.choices?.[0]?.message?.content?.trim();if(s)mem.compact(s)}catch{}}
async function manualFlush(){show('æ€»ç»“ä¸­...');await autoFlush();renderMem();show('è®°å¿†å·²æ›´æ–°')}
function exportMem(){const b=new Blob([mem.exportAll()],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='memory_'+new Date().toISOString().split('T')[0]+'.json';a.click();URL.revokeObjectURL(u);show('å·²å¯¼å‡º')}

// ========== Render Memory ==========
function renderMem(){
  const r=mem.recent(8);document.getElementById('sMem').innerHTML=r.length?r.map(m=>'<div class="me"><span class="mt">'+m.time+'</span> '+m.t+'</div>').join(''):'æš‚æ— ';
  const l=mem.longT();document.getElementById('lMem').innerHTML=l.length?l.map(t=>'<div class="me">'+t+'</div>').join(''):'æš‚æ— ';
  const rf=mem.rf.slice(-5);document.getElementById('rMem').innerHTML=rf.length?rf.map(m=>'<div class="me"><span class="mt">'+m.time+'</span> '+m.t+'</div>').join(''):'æš‚æ— ';
  const s=mem.stats();document.getElementById('msO').textContent=s.o;document.getElementById('msD').textContent=s.d;document.getElementById('msR').textContent=s.r;
}

// ========== Cards ==========
async function genCard(){
  const r=mem.recent(15).map(m=>m.t).join('\n');const l=mem.longT().join('\n');
  if(!r&&!l){show('æš‚æ— å†…å®¹');return}show('ç”Ÿæˆä¸­...');
  try{const resp=await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+C.key},body:JSON.stringify({model:'qwen-plus',messages:[{role:'user',content:'æ ¹æ®å¯¹è¯ç”Ÿæˆå¡ç‰‡JSONï¼š{"title":"æ ‡é¢˜","body":"è¦ç‚¹100å­—å†…","tags":["æ ‡ç­¾"]}\n\n'+r+'\n\né•¿æœŸï¼š\n'+(l||'æ— ')+(lastImg?'\nå›¾ç‰‡ï¼š'+lastImg:'')}],max_tokens:200})});
  const d=await resp.json();const raw=d.choices?.[0]?.message?.content?.trim();
  const p=JSON.parse(raw.replace(/```json\n?/g,'').replace(/```/g,''));
  cards.unshift({id:Date.now(),time:fD(new Date()),title:p.title||'å¡ç‰‡',body:p.body||'',tags:p.tags||[]});
  localStorage.setItem('av_c',JSON.stringify(cards));renderCards();show('å¡ç‰‡å·²ç”Ÿæˆ')}catch(e){show('å¤±è´¥: '+e.message)}}
function renderCards(){const g=document.getElementById('cGrid');g.innerHTML=cards.length?cards.map(c=>'<div class="ci" oncontextmenu="shareCard(event,'+c.id+')" ontouchstart="cardTouchStart(event,'+c.id+')" ontouchend="cardTouchEnd(event)"><div class="ct">'+c.time+'</div><div class="ch">'+c.title+'</div><div class="cb">'+c.body+'</div><div class="tags">'+(c.tags||[]).map(t=>'<span class="tag">'+t+'</span>').join('')+'</div><div class="ca"><button onclick="saveCard('+c.id+')">ğŸ’¾ ä¿å­˜</button><button onclick="shareCard(null,'+c.id+')">ğŸ“¤ åˆ†äº«</button><button onclick="delCard('+c.id+')">ğŸ—‘ï¸</button></div></div>').join(''):'<div style="color:var(--text3);text-align:center;padding:40px;font-size:13px">å¯¹è¯åç‚¹å‡»ç”Ÿæˆå¡ç‰‡</div>'}
function delCard(id){cards=cards.filter(c=>c.id!==id);localStorage.setItem('av_c',JSON.stringify(cards));renderCards()}
function clearCards(){cards=[];localStorage.setItem('av_c','[]');renderCards();show('å·²æ¸…ç©º')}
function renderCardImage(c){
  const cv=document.getElementById('fCvs'),x=cv.getContext('2d');cv.width=600;cv.height=400;
  const g=x.createLinearGradient(0,0,600,400);g.addColorStop(0,'#0c0f1a');g.addColorStop(1,'#151a2e');x.fillStyle=g;x.fillRect(0,0,600,400);
  // Accent bar
  const ag=x.createLinearGradient(0,0,0,400);ag.addColorStop(0,'#7b8cff');ag.addColorStop(1,'#a78bfa');x.fillStyle=ag;x.fillRect(0,0,4,400);
  // Title
  x.fillStyle='#f0f2f8';x.font='bold 22px system-ui';x.fillText(c.title,24,48);
  // Time
  x.fillStyle='#7c8497';x.font='12px system-ui';x.fillText(c.time,24,72);
  // Body
  x.fillStyle='#c0c8d8';x.font='15px system-ui';const lines=wrapT(x,c.body,550);lines.forEach((l,i)=>x.fillText(l,24,105+i*24));
  // Tags
  const ty=105+lines.length*24+16;let tx=24;
  (c.tags||[]).forEach(tag=>{const tw=x.measureText(tag).width+18;x.fillStyle='rgba(123,140,255,.15)';x.beginPath();x.roundRect(tx,ty-12,tw,24,12);x.fill();x.fillStyle='#7b8cff';x.font='12px system-ui';x.fillText(tag,tx+9,ty+4);tx+=tw+8});
  // Watermark
  x.fillStyle='#3d4355';x.font='10px system-ui';x.fillText('AI Avatar Â· '+new Date().toLocaleDateString(),24,385);
  return cv.toDataURL('image/png');
}
function saveCard(id){
  const c=cards.find(x=>x.id===id);if(!c)return;
  const dataUrl=renderCardImage(c);
  const b64=dataUrl.split(',')[1];
  if(window.NativeBridge){
    try{window.NativeBridge.saveImageToGallery(b64,'card_'+c.id+'.png');return}catch(e){}
  }
  // Fallback for browser
  const a=document.createElement('a');a.href=dataUrl;a.download='card_'+c.id+'.png';document.body.appendChild(a);a.click();document.body.removeChild(a);show('å·²ä¿å­˜');
}
function shareCard(e,id){
  if(e)e.preventDefault();
  const c=cards.find(x=>x.id===id);if(!c)return;
  const dataUrl=renderCardImage(c);
  const b64=dataUrl.split(',')[1];
  if(window.NativeBridge){
    try{window.NativeBridge.shareImage(b64,c.title);return}catch(e2){}}
  // Fallback: try Web Share API
  if(navigator.share){
    fetch(dataUrl).then(r=>r.blob()).then(blob=>{
      const file=new File([blob],'card.png',{type:'image/png'});
      navigator.share({title:c.title,files:[file]}).catch(()=>{});
    });
  }else show('è¯·ä½¿ç”¨ Android App åˆ†äº«');
}
// Long press on card
let cardLongTimer=null;
function cardTouchStart(e,id){cardLongTimer=setTimeout(()=>shareCard(e,id),600)}
function cardTouchEnd(e){if(cardLongTimer){clearTimeout(cardLongTimer);cardLongTimer=null}}
function wrapT(x,t,w){const ls=[];let l='';for(const c of t){if(x.measureText(l+c).width>w){ls.push(l);l=c}else l+=c}if(l)ls.push(l);return ls.slice(0,8)}

// ========== Utils ==========
function a2b(buf){const b=new Uint8Array(buf);let s='';for(let i=0;i<b.length;i++)s+=String.fromCharCode(b[i]);return btoa(s)}
function b2a(b64){const s=atob(b64);const b=new Uint8Array(s.length);for(let i=0;i<s.length;i++)b[i]=s.charCodeAt(i);return b.buffer}
function show(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500)}
</script>
</body>
</html>
